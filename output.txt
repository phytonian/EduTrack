--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\__init__.py
<<code:
"""
EduTrack Core App Initialization
"""
default_app_config = 'core.apps.CoreConfig'

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\admin.py
<<code:
"""
EduTrack Django Admin Registration
====================================
This file registers all EduTrack models with Django's built-in admin panel at /admin/.
The admin panel is only accessible to superusers and staff users.
Each class below controls how a model appears and behaves inside the admin panel —
what columns show in the list, what filters are available, what fields appear on the
edit page, and what bulk actions are available.

Why this file matters:
- Admin is the fastest way for a developer/superuser to directly inspect and fix data.
- Custom list_display columns, search fields, and filters make it usable at a glance.
- Bulk actions (mark as paid, mark as absent, etc.) save time for common tasks.
"""

from django.contrib import admin
from .models import (
    UserProfile, Student, Assignment, Submission,
    RoadmapTopic, Attendance, TestScore, Comment,
    Holiday, StatusPost, AssignmentTicket, BrushUpRequest,
    Notification, Feedback, Announcement,
    Subject, SubjectsTaken, TeacherProfile, FeesStatus,
    TeacherAttendance, PettyExpense
)


# ─────────────────────────────────────────────────────────────
# USER PROFILE ADMIN
# Shows every user account's extended profile (role, phone, etc.)
# UserProfile is a OneToOne extension of Django's built-in User model.
# Use this to check a user's role (admin/teacher/student/parent)
# or to quickly find someone by name/username.
# ─────────────────────────────────────────────────────────────
@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    # Columns shown in the list view
    list_display = ['user', 'role', 'phone_number', 'created_at']

    # Sidebar filter — filter by role to quickly see all teachers, students, etc.
    list_filter = ['role']

    # Search box — search by username or full name
    search_fields = ['user__username', 'user__first_name', 'user__last_name']


# ─────────────────────────────────────────────────────────────
# STUDENT ADMIN
# Shows student-specific data: roll number, grade, section, active status.
# A Student record is linked to a UserProfile with role='student'.
# Use this to check enrolment status, find a student by roll number,
# or manually activate/deactivate a student account.
# ─────────────────────────────────────────────────────────────
@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    # Columns shown in the list view
    list_display = ['user', 'roll_number', 'grade', 'section', 'is_active']

    # Filter by grade, section, or active/inactive status
    list_filter = ['grade', 'section', 'is_active']

    # Search by student name or roll number
    search_fields = ['user__first_name', 'user__last_name', 'roll_number']

    # Clicking the user column takes you to the edit page
    list_display_links = ['user']


# ─────────────────────────────────────────────────────────────
# ASSIGNMENT ADMIN
# Shows all assignments created by teachers.
# Assignments are the core task unit — teachers create them,
# students submit work against them.
# Use this to inspect due dates, check which teacher created what,
# or manually change an assignment's status.
# ─────────────────────────────────────────────────────────────
@admin.register(Assignment)
class AssignmentAdmin(admin.ModelAdmin):
    # Show key details at a glance
    list_display = ['title', 'created_by', 'subject', 'grade', 'due_date', 'status']

    # Filter by status (active/draft/closed) or grade
    list_filter = ['status', 'grade']

    # Search by assignment title or subject name
    search_fields = ['title', 'subject']


# ─────────────────────────────────────────────────────────────
# SUBMISSION ADMIN
# Shows student submissions for assignments.
# A Submission is created when a student submits work for an Assignment.
# It holds the score, status (submitted/graded/late), and timestamp.
# Use this to find ungraded submissions or check a student's score.
# ─────────────────────────────────────────────────────────────
@admin.register(Submission)
class SubmissionAdmin(admin.ModelAdmin):
    list_display = ['assignment', 'student', 'status', 'score', 'submitted_at']

    # Filter by status to find all ungraded or late submissions quickly
    list_filter = ['status']

    # Search by student name or assignment title
    search_fields = ['student__user__first_name', 'assignment__title']


# ─────────────────────────────────────────────────────────────
# ROADMAP TOPIC ADMIN
# Shows all roadmap topics (curriculum items) created by teachers.
# Topics form a tree — a topic can have a parent_topic (sub-topic).
# Each topic has a status: upcoming / in_progress / completed.
# Use this to inspect the curriculum structure or fix ordering.
# ─────────────────────────────────────────────────────────────
@admin.register(RoadmapTopic)
class RoadmapTopicAdmin(admin.ModelAdmin):
    list_display = ['title', 'created_by', 'status', 'order', 'parent_topic']

    # Filter by status or by teacher to see a specific teacher's roadmap
    list_filter = ['status', 'created_by']

    # Search by topic title
    search_fields = ['title']


# ─────────────────────────────────────────────────────────────
# STUDENT ATTENDANCE ADMIN
# Shows student attendance records marked by teachers.
# Each record is one student on one date with a status and optional note.
# Use this to audit attendance data or fix incorrect records.
# ─────────────────────────────────────────────────────────────
@admin.register(Attendance)
class AttendanceAdmin(admin.ModelAdmin):
    # Show student, date, status, who marked it, and any note
    list_display = ['student', 'date', 'status', 'marked_by', 'notes']

    # Filter by status (present/absent/late) or by date
    list_filter = ['status', 'date']

    # Search by student name or roll number
    search_fields = [
        'student__user__first_name',
        'student__user__last_name',
        'student__roll_number',
    ]

    # Most recent records shown first
    ordering = ['-date']


# ─────────────────────────────────────────────────────────────
# TEST SCORE ADMIN
# Shows test/exam scores entered by teachers for students.
# Scores are linked to a RoadmapTopic so progress can be tracked.
# Use this to review scores, fix errors, or check pass/fail rates.
# ─────────────────────────────────────────────────────────────
@admin.register(TestScore)
class TestScoreAdmin(admin.ModelAdmin):
    list_display = ['student', 'test_name', 'subject', 'date', 'score', 'max_score']

    # Filter by subject to see all tests for a particular subject
    list_filter = ['subject']


# ─────────────────────────────────────────────────────────────
# COMMENT ADMIN
# Shows teacher/admin comments left on student profiles.
# Comments can be private (only visible to admin/teacher)
# or public (visible to parent too).
# Use this to audit communication or remove inappropriate comments.
# ─────────────────────────────────────────────────────────────
@admin.register(Comment)
class CommentAdmin(admin.ModelAdmin):
    list_display = ['author', 'target_user', 'comment_type', 'is_private', 'created_at']

    # Filter by type (academic/behaviour/general) or private/public
    list_filter = ['comment_type', 'is_private']


# ─────────────────────────────────────────────────────────────
# HOLIDAY ADMIN
# Shows holidays and working day announcements created by admin.
# Each holiday has a type (Holiday/Working Day/Half Day) and
# can be marked as recurring annually.
# Use this to review the school calendar or fix dates.
# ─────────────────────────────────────────────────────────────
@admin.register(Holiday)
class HolidayAdmin(admin.ModelAdmin):
    list_display = ['title', 'date', 'holiday_type', 'is_recurring']

    # Filter by type to separate holidays from working days
    list_filter = ['holiday_type']


# ─────────────────────────────────────────────────────────────
# STATUS POST ADMIN
# Shows announcements/posts created by admin for specific roles.
# A post can target all users, or just students/parents/teachers.
# Pinned posts appear at the top of the feed.
# Use this to delete outdated posts or check what was broadcast.
# ─────────────────────────────────────────────────────────────
@admin.register(StatusPost)
class StatusPostAdmin(admin.ModelAdmin):
    list_display = ['author', 'target_role', 'is_pinned', 'created_at']


# ─────────────────────────────────────────────────────────────
# ASSIGNMENT TICKET ADMIN
# Shows tickets raised by students for offline submissions
# (email, WhatsApp, physical handover).
# Teachers respond to tickets and mark them verified/rejected.
# Use this to see all open tickets or manually update status.
# ─────────────────────────────────────────────────────────────
@admin.register(AssignmentTicket)
class AssignmentTicketAdmin(admin.ModelAdmin):
    list_display = ['student', 'assignment', 'submission_method', 'status', 'created_at']

    # Filter by status (open/acknowledged/verified/rejected) or submission method
    list_filter = ['status', 'submission_method']


# ─────────────────────────────────────────────────────────────
# BRUSH-UP REQUEST ADMIN
# Shows student requests for brush-up sessions or re-tests
# on topics where they scored below the pass threshold.
# Teachers approve/schedule/reject these requests.
# Use this to see all pending requests or audit completed ones.
# ─────────────────────────────────────────────────────────────
@admin.register(BrushUpRequest)
class BrushUpRequestAdmin(admin.ModelAdmin):
    list_display = ['student', 'topic', 'request_type', 'status', 'created_at']

    # Filter by status or request type (brushup/retest)
    list_filter = ['status', 'request_type']


# ─────────────────────────────────────────────────────────────
# NOTIFICATION ADMIN
# Shows in-app notifications sent to any user.
# Notifications are auto-created by the system when events happen
# (new assignment, grade posted, holiday announced, etc.)
# Use this to check what notifications were sent or mark them read.
# ─────────────────────────────────────────────────────────────
@admin.register(Notification)
class NotificationAdmin(admin.ModelAdmin):
    list_display = ['user', 'notification_type', 'title', 'is_read', 'created_at']

    # Filter by type or read/unread status
    list_filter = ['notification_type', 'is_read']


# ─────────────────────────────────────────────────────────────
# FEEDBACK ADMIN
# Shows feedback submitted by parents or students to admin.
# Feedback has types (academic/facility/teacher/general) and
# a status (pending/reviewed/resolved).
# Use this to review feedback and update resolution status.
# ─────────────────────────────────────────────────────────────
@admin.register(Feedback)
class FeedbackAdmin(admin.ModelAdmin):
    list_display = ['submitted_by', 'feedback_type', 'subject', 'status', 'created_at']

    # Filter by status or feedback type
    list_filter = ['status', 'feedback_type']


# ─────────────────────────────────────────────────────────────
# ANNOUNCEMENT ADMIN
# Shows school-wide announcements with priority levels.
# Announcements can target specific audiences and be activated/deactivated.
# Different from StatusPost — Announcements have priority and active flag.
# Use this to manage important school-wide messages.
# ─────────────────────────────────────────────────────────────
@admin.register(Announcement)
class AnnouncementAdmin(admin.ModelAdmin):
    list_display = ['title', 'priority', 'target_audience', 'is_active', 'created_at']

    # Filter by priority (high/medium/low), audience, or active status
    list_filter = ['priority', 'target_audience', 'is_active']


# ─────────────────────────────────────────────────────────────
# SUBJECT ADMIN
# Shows all subjects in the system, each assigned to a teacher.
# A Subject belongs to one teacher's UserProfile (role='teacher').
# Students enrol in subjects via SubjectsTaken (separate model).
# Use this to create subjects or reassign them to a different teacher.
# ─────────────────────────────────────────────────────────────
@admin.register(Subject)
class SubjectAdmin(admin.ModelAdmin):
    # Show subject name and teacher's full name (via custom method below)
    list_display = ['name', 'get_teacher_name', 'created_at']

    # Filter by teacher to see all subjects under a specific teacher
    list_filter = ['teacher']

    # Search by subject name or teacher name
    search_fields = ['name', 'teacher__user__first_name', 'teacher__user__last_name']

    ordering = ['name']

    def get_teacher_name(self, obj):
        """
        Returns the full name of the teacher assigned to this subject.
        Shows '— Unassigned —' if no teacher is linked.
        Used as a custom column in the list view since teacher is a FK,
        not a plain text field, so it can't be used in list_display directly.
        """
        if obj.teacher and obj.teacher.user:
            return obj.teacher.user.get_full_name()
        return '— Unassigned —'
    get_teacher_name.short_description = 'Teacher'  # Column header label


# ─────────────────────────────────────────────────────────────
# SUBJECTS TAKEN ADMIN
# Shows which students are enrolled in which subjects.
# SubjectsTaken is a many-to-many bridge between Student and Subject
# with an enrolled_at timestamp. One record = one student in one subject.
# Use this to enrol/remove students from subjects or audit enrolments.
# ─────────────────────────────────────────────────────────────
@admin.register(SubjectsTaken)
class SubjectsTakenAdmin(admin.ModelAdmin):
    # Custom display columns (all via methods below since they cross FK relationships)
    list_display = ['get_student_name', 'get_roll_number', 'get_subject_name', 'get_teacher_name', 'enrolled_at']

    # Filter by subject or by the teacher assigned to the subject
    list_filter = ['subject', 'subject__teacher']

    # Search by student name, roll number, or subject name
    search_fields = [
        'student__user__first_name',
        'student__user__last_name',
        'student__roll_number',
        'subject__name',
    ]

    ordering = ['student__roll_number', 'subject__name']

    def get_student_name(self, obj):
        """Returns the enrolled student's full name."""
        return obj.student.user.get_full_name()
    get_student_name.short_description = 'Student'

    def get_roll_number(self, obj):
        """Returns the enrolled student's roll number."""
        return obj.student.roll_number
    get_roll_number.short_description = 'Roll Number'

    def get_subject_name(self, obj):
        """Returns the subject name this enrolment is for."""
        return obj.subject.name
    get_subject_name.short_description = 'Subject'

    def get_teacher_name(self, obj):
        """
        Returns the full name of the teacher who owns the subject.
        Shows '— Unassigned —' if the subject has no teacher linked.
        """
        if obj.subject.teacher and obj.subject.teacher.user:
            return obj.subject.teacher.user.get_full_name()
        return '— Unassigned —'
    get_teacher_name.short_description = 'Teacher'


# ─────────────────────────────────────────────────────────────
# TEACHER PROFILE ADMIN
# Shows extended teacher data: salary, qualification, joining date.
# TeacherProfile is a OneToOne extension of UserProfile (role='teacher').
# Created by admin when a teacher account is set up.
# Use this to update salaries, check qualifications, or fix joining dates.
# ─────────────────────────────────────────────────────────────
@admin.register(TeacherProfile)
class TeacherProfileAdmin(admin.ModelAdmin):
    list_display = [
        'get_full_name',      # Teacher's full name (via method)
        'get_subjects',       # Comma-separated list of their subjects (via method)
        'get_salary_display', # Formatted salary like ₹12,000.00 (via method)
        'qualification',      # Highest degree (B.Ed, M.Sc, Ph.D etc.)
        'joining_date',       # Date they joined the school
        'emergency_contact',  # Emergency phone number
    ]

    # Filter by qualification or joining year
    list_filter = ['qualification', 'joining_date']

    # Search by teacher's name or email
    search_fields = [
        'profile__user__first_name',
        'profile__user__last_name',
        'profile__user__email',
    ]

    ordering = ['profile__user__first_name']

    # fieldsets organises the edit page into named sections
    fieldsets = (
        ('Teacher', {
            'fields': ('profile',)                          # Link to the UserProfile
        }),
        ('Employment Details', {
            'fields': ('salary', 'joining_date', 'qualification')
        }),
        ('Contact', {
            'fields': ('emergency_contact',)
        }),
    )

    def get_full_name(self, obj):
        """Returns the teacher's full name from the linked User account."""
        return obj.profile.user.get_full_name()
    get_full_name.short_description = 'Teacher Name'

    def get_subjects(self, obj):
        """
        Returns a comma-separated list of all subjects assigned to this teacher.
        Calls the model's get_subjects() method which queries Subject.objects
        filtered by this teacher's profile.
        Shows '— No subjects assigned —' if none exist yet.
        """
        subjects = obj.get_subjects()
        if subjects.exists():
            return ', '.join(s.name for s in subjects)
        return '— No subjects assigned —'
    get_subjects.short_description = 'Subjects'

    def get_salary_display(self, obj):
        """
        Returns the formatted salary string (e.g. ₹12,000.00).
        Calls the model's get_salary_display() method.
        """
        return obj.get_salary_display()
    get_salary_display.short_description = 'Salary'


# ─────────────────────────────────────────────────────────────
# FEES STATUS ADMIN
# Shows monthly fee records for each student.
# One FeesStatus record = one student for one month (e.g. 02/2026).
# Status can be: Unpaid / Paid / Overdue / Waived.
# When status changes, the parent's pending_amount auto-updates via model's save().
# 2+ overdue records automatically sets the student as inactive.
# Use this to create fee records, mark payments, or investigate overdue cases.
# ─────────────────────────────────────────────────────────────
@admin.register(FeesStatus)
class FeesStatusAdmin(admin.ModelAdmin):
    list_display = [
        'get_student_name',  # Student's full name (via method)
        'get_roll_number',   # Roll number (via method)
        'month',             # Month in MM/YYYY format
        'fees',              # Fee amount
        'status',            # Unpaid/Paid/Overdue/Waived
        'due_date',          # Date payment was due
        'paid_date',         # Date payment was received (auto-set when marked Paid)
    ]

    # Filter by payment status or month
    list_filter = ['status', 'month']

    # Search by student name, roll number, or month string
    search_fields = [
        'student__user__first_name',
        'student__user__last_name',
        'student__roll_number',
        'month',
    ]

    # Most recent months first
    ordering = ['-month', 'student__roll_number']

    # created_at and updated_at are auto-set — show but don't allow editing
    readonly_fields = ['created_at', 'updated_at']

    # Organise the edit page into named sections
    fieldsets = (
        ('Student', {
            'fields': ('student',)
        }),
        ('Fee Details', {
            'fields': ('month', 'fees', 'status', 'due_date', 'paid_date')
        }),
        ('Notes', {
            'fields': ('remarks',)
        }),
        ('Timestamps', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)  # Hidden by default, click to expand
        }),
    )

    def get_student_name(self, obj):
        """Returns the student's full name from the linked User account."""
        return obj.student.user.get_full_name()
    get_student_name.short_description = 'Student'

    def get_roll_number(self, obj):
        """Returns the student's roll number."""
        return obj.student.roll_number
    get_roll_number.short_description = 'Roll Number'

    # ── Bulk actions ──────────────────────────────────────────
    # These appear in the "Action" dropdown in the list view.
    # Select multiple records, choose an action, click Go.
    actions = ['mark_as_paid', 'mark_as_overdue', 'mark_as_waived']

    def mark_as_paid(self, request, queryset):
        """
        Bulk action: marks all selected fee records as Paid.
        Calls .save() on each record individually so the model's
        save() logic runs — this auto-sets paid_date and
        recalculates the parent's pending_amount.
        """
        for fee in queryset:
            fee.status = 'paid'
            fee.save()
        self.message_user(request, f'{queryset.count()} fee(s) marked as Paid.')
    mark_as_paid.short_description = 'Mark selected as Paid'

    def mark_as_overdue(self, request, queryset):
        """
        Bulk action: marks all selected fee records as Overdue.
        Calls .save() individually so auto-logic runs (clears paid_date,
        recalculates pending, checks if student should be deactivated).
        """
        for fee in queryset:
            fee.status = 'overdue'
            fee.save()
        self.message_user(request, f'{queryset.count()} fee(s) marked as Overdue.')
    mark_as_overdue.short_description = 'Mark selected as Overdue'

    def mark_as_waived(self, request, queryset):
        """
        Bulk action: marks all selected fee records as Waived (fee forgiven).
        Calls .save() individually so pending_amount recalculates correctly.
        """
        for fee in queryset:
            fee.status = 'waived'
            fee.save()
        self.message_user(request, f'{queryset.count()} fee(s) marked as Waived.')
    mark_as_waived.short_description = 'Mark selected as Waived'


# ─────────────────────────────────────────────────────────────
# PETTY EXPENSE ADMIN
# Shows small operational expenses logged by admin:
# rent, stationary, events, utilities, etc.
# These are used in the Finance Overview page to calculate
# total expenses and net balance (income minus expenses).
# Use this to add, edit, or delete expense records.
# ─────────────────────────────────────────────────────────────
@admin.register(PettyExpense)
class PettyExpenseAdmin(admin.ModelAdmin):
    # Show description, amount, category, date, and who added it
    list_display = ['description', 'amount', 'category', 'date', 'added_by']

    # Filter by category or date to find specific expense types
    list_filter = ['category', 'date']


# ─────────────────────────────────────────────────────────────
# TEACHER ATTENDANCE ADMIN
# Shows attendance records for teachers, marked by admin.
# Separate from student Attendance for clean querying and
# salary calculation purposes (absent days can affect salary).
# Each record is one teacher on one date — unique_together prevents duplicates.
# Use this to view attendance history, fix incorrect records,
# or bulk-mark teachers for a given day.
# ─────────────────────────────────────────────────────────────
@admin.register(TeacherAttendance)
class TeacherAttendanceAdmin(admin.ModelAdmin):
    list_display = [
        'get_teacher_name',  # Teacher's full name (via method)
        'date',              # Date of attendance
        'status',            # Present/Absent/Late/Half Day/Excused
        'marked_by',         # Admin who marked this record
        'notes',             # Optional reason or note
    ]

    # Filter by status, date, or teacher
    list_filter = ['status', 'date', 'teacher']

    # Search by teacher first or last name
    search_fields = [
        'teacher__user__first_name',
        'teacher__user__last_name',
    ]

    # Most recent dates first
    ordering = ['-date']

    # created_at is auto-set — show but don't allow editing
    readonly_fields = ['created_at']

    # Organise the edit page into named sections
    fieldsets = (
        ('Teacher', {
            'fields': ('teacher', 'date')
        }),
        ('Attendance', {
            'fields': ('status', 'marked_by', 'notes')
        }),
        ('Timestamps', {
            'fields': ('created_at',),
            'classes': ('collapse',)  # Hidden by default
        }),
    )

    def get_teacher_name(self, obj):
        """Returns the teacher's full name from their linked User account."""
        return obj.teacher.user.get_full_name()
    get_teacher_name.short_description = 'Teacher'

    # ── Bulk actions ──────────────────────────────────────────
    # Select multiple attendance records and apply status in one click.
    # Note: these use queryset.update() for speed (no model save() logic needed
    # for attendance — unlike FeesStatus which has side effects in save()).
    actions = ['mark_present', 'mark_absent', 'mark_half_day']

    def mark_present(self, request, queryset):
        """Bulk action: marks all selected records as Present."""
        queryset.update(status='present')
        self.message_user(request, f'{queryset.count()} record(s) marked as Present.')
    mark_present.short_description = 'Mark selected as Present'

    def mark_absent(self, request, queryset):
        """Bulk action: marks all selected records as Absent."""
        queryset.update(status='absent')
        self.message_user(request, f'{queryset.count()} record(s) marked as Absent.')
    mark_absent.short_description = 'Mark selected as Absent'

    def mark_half_day(self, request, queryset):
        """Bulk action: marks all selected records as Half Day."""
        queryset.update(status='half_day')
        self.message_user(request, f'{queryset.count()} record(s) marked as Half Day.')
    mark_half_day.short_description = 'Mark selected as Half Day'

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\apps.py
<<code:
"""
EduTrack Core App Configuration
"""
from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'
    verbose_name = 'EduTrack Core'

    def ready(self):
        try:
            import core.signals  # noqa: F401
        except ImportError:
            import warnings
            warnings.warn('Could not import core.signals.', RuntimeWarning)

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\forms.py
<<code:
from django import forms
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from django.db import transaction
from datetime import date
from django.forms.widgets import SelectDateWidget

from .models import (
    UserProfile, Student, Assignment, Submission,
    RoadmapTopic, Comment, StatusPost, Holiday,
    Attendance, AssignmentTicket, BrushUpRequest,
    Feedback, TestScore, Notification
)
_current_year = date.today().year

DATE_WIDGET = SelectDateWidget(
    years=range(_current_year + 5, 1949, -1),
    attrs={'class': 'form-select d-inline-block w-auto me-1'}
)

FUTURE_DATE_WIDGET = SelectDateWidget(
    years=range(_current_year, _current_year + 10),
    attrs={'class': 'form-select d-inline-block w-auto me-1'}
)

# =====================
# PROFILE FORMS (all roles)
# =====================

class ProfilePhotoForm(forms.ModelForm):
    """Update profile photo — available to all roles."""
    class Meta:
        model = UserProfile
        fields = ['profile_photo']
        widgets = {
            'profile_photo': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            })
        }


class ProfileUpdateForm(forms.ModelForm):
    """Update basic profile info — password change handled separately via Django auth."""
    class Meta:
        model = UserProfile
        fields = ['phone_number', 'date_of_birth', 'address']
        widgets = {
            'phone_number': forms.TextInput(attrs={'class': 'form-control'}),
            'date_of_birth': DATE_WIDGET,
            'address': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }


class UserNameForm(forms.ModelForm):
    """Edit name/email portion of a user."""
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'email']
        widgets = {
            'first_name': forms.TextInput(attrs={'class': 'form-control'}),
            'last_name': forms.TextInput(attrs={'class': 'form-control'}),
            'email': forms.EmailInput(attrs={'class': 'form-control'}),
        }


# =====================
# STUDENT FORM 
# =====================
class StudentForm(forms.Form):
    """
    Student creation form with all fields.
    Uses plain Form (not ModelForm) with manual save() in atomic transaction.
    """

    SECTION_CHOICES = [
        ('', 'Select Section'),
        ('A', 'A'),
        ('B', 'B'),
        ('C', 'C'),
        ('D', 'D'),
    ]

    BLOOD_GROUP_CHOICES = [
        ('', 'Select Blood Group (Optional)'),
        ('A+', 'A+'),
        ('A-', 'A-'),
        ('B+', 'B+'),
        ('B-', 'B-'),
        ('AB+', 'AB+'),
        ('AB-', 'AB-'),
        ('O+', 'O+'),
        ('O-', 'O-'),
    ]

    # ── User fields ──────────────────────────────────────────────────────────

    username = forms.CharField(
        max_length=150,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Username',
            'autocomplete': 'off'
        }),
        help_text='Must be unique'
    )
    first_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'First Name'})
    )
    last_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Last Name'})
    )
    email = forms.EmailField(
        widget=forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'Email'})
    )
    password = forms.CharField(
        min_length=8,
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Password (min 8 chars)'
        }),
        help_text='Minimum 8 characters'
    )
    confirm_password = forms.CharField(
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Confirm Password'
        })
    )

    # ── Student fields ───────────────────────────────────────────────────────

    roll_number = forms.CharField(
        max_length=20,
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Auto-generated if left blank'
        }),
        help_text='Leave blank to auto-assign next available number'
    )
    grade = forms.CharField(
        max_length=10,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Grade (e.g. 10)'
        })
    )
    section = forms.ChoiceField(
        choices=SECTION_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    phone_number = forms.CharField(
        max_length=15,
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': '00-00-00-0000',
            'id': 'id_phone_number'
        }),
        help_text='Format: 00-00-00-0000. Leave blank to fill later.'
    )
    address = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'placeholder': 'Residential Address (can be filled later)',
            'rows': 3
        }),
        help_text='Leave blank to fill later.'
    )
    subjects = forms.ModelMultipleChoiceField(
        queryset=None,
        required=False,
        widget=forms.CheckboxSelectMultiple(attrs={'class': 'form-check-input'}),
        help_text='Select subjects this student is enrolled in'
    )
    parent = forms.ModelChoiceField(
        queryset=User.objects.none(),
        required=False,
        empty_label='— Select Parent (Optional) —',
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    blood_group = forms.ChoiceField(
        choices=BLOOD_GROUP_CHOICES,
        required=False,
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    medical_conditions = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 2,
            'placeholder': 'Any medical conditions (optional)'
        })
    )
    admission_date = forms.DateField(
        required=False,
        initial=date.today,
        widget=DATE_WIDGET
        )

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Load parents dropdown
        self.fields['parent'].queryset = User.objects.filter(
            profile__role='parent'
        ).order_by('first_name', 'last_name')
        # Load subjects
        from core.models import Subject
        self.fields['subjects'].queryset = Subject.objects.select_related('teacher').all().order_by('name')

    # ── Validation ───────────────────────────────────────────────────────────

    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get('password')
        confirm_password = cleaned_data.get('confirm_password')
        if password and confirm_password and password != confirm_password:
            raise ValidationError('Passwords do not match.')
        return cleaned_data

    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise ValidationError('Username already taken. Choose another.')
        return username

    def clean_email(self):
        email = self.cleaned_data.get('email')
        if User.objects.filter(email=email).exists():
            raise ValidationError('Email already registered.')
        return email

    def clean_roll_number(self):
        roll_number = self.cleaned_data.get('roll_number', '').strip()
        if roll_number and Student.objects.filter(roll_number=roll_number).exists():
            raise ValidationError('Roll number already exists.')
        return roll_number

    # ── Save ─────────────────────────────────────────────────────────────────

    def save(self):
        """
        Wrapped in transaction.atomic() to prevent partial saves.
        Signals are intentionally avoided for UserProfile creation here.
        """
        with transaction.atomic():

            # Auto-generate roll number if blank
            roll_number = self.cleaned_data.get('roll_number', '').strip()
            if not roll_number:
                rolls = Student.objects.values_list('roll_number', flat=True)
                numeric_rolls = []
                for r in rolls:
                    r_stripped = r.lstrip('Ss')
                    if r_stripped.isdigit():
                        numeric_rolls.append(int(r_stripped))
                next_num = max(numeric_rolls) + 1 if numeric_rolls else 1
                roll_number = f'S{str(next_num).zfill(3)}'

            # 1. Create User
            user = User.objects.create_user(
                username=self.cleaned_data['username'],
                email=self.cleaned_data['email'],
                first_name=self.cleaned_data['first_name'],
                last_name=self.cleaned_data['last_name'],
                password=self.cleaned_data['password']
            )

            # 2. Create/update UserProfile
            UserProfile.objects.update_or_create(
                user=user,
                defaults={'role': 'student'}
            )

            # 3. Create Student
            student = Student.objects.create(
                user=user,
                roll_number=roll_number,
                grade=self.cleaned_data['grade'],
                section=self.cleaned_data['section'],
                phone_number=self.cleaned_data.get('phone_number') or '00-000-000-000',
                address=self.cleaned_data.get('address') or 'Not provided',
                parent=self.cleaned_data.get('parent'),
                blood_group=self.cleaned_data.get('blood_group', ''),
                medical_conditions=self.cleaned_data.get('medical_conditions', ''),
                admission_date=self.cleaned_data.get('admission_date') or date.today(),
            )

            # 4. Enrol student in selected subjects
            subjects = self.cleaned_data.get('subjects', [])
            if subjects:
                from core.models import SubjectsTaken
                SubjectsTaken.objects.bulk_create([
                    SubjectsTaken(student=student, subject=subject)
                    for subject in subjects
                ])

            return student


# =====================
# PARENT FORM — FIXED
# =====================

class ParentForm(forms.Form):
    """
    FIXED: Parent creation — same atomic pattern as StudentForm.
    """

    username = forms.CharField(
        max_length=150,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Username', 'autocomplete': 'off'})
    )
    first_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'First Name'})
    )
    last_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Last Name'})
    )
    email = forms.EmailField(
        widget=forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'Email'})
    )
    phone_number = forms.CharField(
        max_length=15,
        required=False,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Phone Number'})
    )
    password = forms.CharField(
        min_length=8,
        widget=forms.PasswordInput(attrs={'class': 'form-control', 'placeholder': 'Password'})
    )
    confirm_password = forms.CharField(
        widget=forms.PasswordInput(attrs={'class': 'form-control', 'placeholder': 'Confirm Password'})
    )

    def clean(self):
        cleaned_data = super().clean()
        if cleaned_data.get('password') != cleaned_data.get('confirm_password'):
            raise ValidationError('Passwords do not match.')
        return cleaned_data

    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise ValidationError('Username already taken.')
        return username

    def clean_email(self):
        email = self.cleaned_data.get('email')
        if User.objects.filter(email=email).exists():
            raise ValidationError('Email already registered.')
        return email

    def save(self):
        with transaction.atomic():
            user = User.objects.create_user(
                username=self.cleaned_data['username'],
                email=self.cleaned_data['email'],
                first_name=self.cleaned_data['first_name'],
                last_name=self.cleaned_data['last_name'],
                password=self.cleaned_data['password']
            )
            UserProfile.objects.update_or_create(
                user=user,
                defaults={
                    'role': 'parent',
                    'phone_number': self.cleaned_data.get('phone_number', '')
                }
            )
            return user


# =====================
# TEACHER FORM
# =====================

class TeacherForm(forms.Form):
    """Create a teacher account (admin only)."""

    username = forms.CharField(
        max_length=150,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Username'})
    )
    first_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'First Name'})
    )
    last_name = forms.CharField(
        max_length=30,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Last Name'})
    )
    email = forms.EmailField(
        widget=forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'Email'})
    )
    password = forms.CharField(
        min_length=8,
        widget=forms.PasswordInput(attrs={'class': 'form-control', 'placeholder': 'Password'})
    )
    subject_specialty = forms.CharField(
        max_length=100,
        required=False,
        widget=forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Subject Specialty'})
    )
    salary = forms.DecimalField(
        max_digits=10,
        decimal_places=2,
        initial=0,
        required=False,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': '0.00',
            'min': '0',
            'step': '0.01'
        }),
        help_text='Monthly salary in ₹. Can be updated later.'
    )

    QUALIFICATION_CHOICES = [
        ('', 'Select Qualification'),
        ('b_ed', 'B.Ed'),
        ('b_sc', 'B.Sc'),
        ('b_a',  'B.A'),
        ('m_sc', 'M.Sc'),
        ('m_a',  'M.A'),
        ('m_ed', 'M.Ed'),
        ('phd',  'Ph.D'),
        ('other','Other'),
    ]
    qualification = forms.ChoiceField(
        choices=QUALIFICATION_CHOICES,
        required=False,
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    joining_date = forms.DateField(
        required=False,
        initial=date.today,
        widget=DATE_WIDGET
    )

    def clean_username(self):
        username = self.cleaned_data.get('username')
        if User.objects.filter(username=username).exists():
            raise ValidationError('Username already taken.')
        return username

    def save(self):
        with transaction.atomic():
            user = User.objects.create_user(
                username=self.cleaned_data['username'],
                email=self.cleaned_data['email'],
                first_name=self.cleaned_data['first_name'],
                last_name=self.cleaned_data['last_name'],
                password=self.cleaned_data['password']
            )
            UserProfile.objects.update_or_create(
                user=user,
                defaults={'role': 'teacher'}
            )
            # Create TeacherProfile with salary and qualification
        try:
            from core.models import TeacherProfile
            profile = UserProfile.objects.get(user=user)
            TeacherProfile.objects.get_or_create(
                user_profile=profile,
                defaults={
                    'salary': self.cleaned_data.get('salary') or 0,
                    'qualification': self.cleaned_data.get('qualification') or '',
                    'joining_date': self.cleaned_data.get('joining_date') or date.today(),
                }
            )
        except Exception:
            pass  # TeacherProfile is optional - don't fail teacher creation

        return user

# =====================
# ASSIGNMENT FORM — FIXED
# =====================

class AssignmentForm(forms.ModelForm):
    """
    FIXED: Assignment creation with PDF/DOC file upload.
    Removed buggy inline error suppression — errors now surfaced properly.
    """

    class Meta:
        model = Assignment
        fields = ['title', 'description', 'subject', 'grade', 'due_date',
                  'max_score', 'status', 'assignment_file', 'instructions']
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Assignment Title'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 4}),
            'subject': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Subject'}),
            'grade': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Grade'}),
            'due_date': FUTURE_DATE_WIDGET,
            'max_score': forms.NumberInput(attrs={'class': 'form-control'}),
            'status': forms.Select(attrs={'class': 'form-control'}),
            'assignment_file': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': '.pdf,.doc,.docx'
            }),
            'instructions': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }

    def clean_due_date(self):
        due_date = self.cleaned_data.get('due_date')
        if due_date and due_date < date.today():
            raise ValidationError('Due date cannot be in the past.')
        return due_date


# =====================
# SUBMISSION FORM
# =====================

class SubmissionForm(forms.ModelForm):
    class Meta:
        model = Submission
        fields = ['file', 'submission_text', 'submission_method']
        widgets = {
            'file': forms.FileInput(attrs={'class': 'form-control', 'accept': '.pdf,.doc,.docx'}),
            'submission_text': forms.Textarea(attrs={'class': 'form-control', 'rows': 4}),
            'submission_method': forms.Select(attrs={'class': 'form-control'}),
        }


# =====================
# ROADMAP TOPIC FORM
# =====================

class RoadmapTopicForm(forms.ModelForm):
    """
    Roadmap topic creation with date selector for upload date and test scheduling.
    Supports parent/child hierarchy.
    """

    class Meta:
        model = RoadmapTopic
        fields = ['title', 'description', 'parent_topic', 'order', 'status',
                  'subject', 'grade', 'estimated_hours', 'resources',
                  'test_scheduled', 'test_title', 'test_duration']
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'parent_topic': forms.Select(attrs={'class': 'form-control'}),
            'order': forms.NumberInput(attrs={'class': 'form-control'}),
            'status': forms.Select(attrs={'class': 'form-control'}),
            'subject': forms.TextInput(attrs={'class': 'form-control'}),
            'grade': forms.TextInput(attrs={'class': 'form-control'}),
            'estimated_hours': forms.NumberInput(attrs={'class': 'form-control'}),
            'resources': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
            'test_scheduled': FUTURE_DATE_WIDGET,
            'test_title': forms.TextInput(attrs={'class': 'form-control'}),
            'test_duration': forms.NumberInput(attrs={'class': 'form-control', 'placeholder': 'Minutes'}),
        }

    def __init__(self, *args, user=None, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['parent_topic'].required = False
        self.fields['parent_topic'].empty_label = '-- No Parent (Root Topic) --'
        if user:
            # Only show current teacher's topics as parent options
            self.fields['parent_topic'].queryset = RoadmapTopic.objects.filter(created_by=user)


# =====================
# ATTENDANCE FORM
# =====================

class AttendanceForm(forms.ModelForm):
    class Meta:
        model = Attendance
        fields = ['student', 'date', 'status', 'notes', 'time_in', 'time_out']
        widgets = {
            'student': forms.Select(attrs={'class': 'form-control'}),
            'date': DATE_WIDGET,
            'status': forms.Select(attrs={'class': 'form-control'}),
            'notes': forms.Textarea(attrs={'class': 'form-control', 'rows': 2}),
            'time_in': forms.TimeInput(attrs={'class': 'form-control', 'type': 'time'}),
            'time_out': forms.TimeInput(attrs={'class': 'form-control', 'type': 'time'}),
        }


# =====================
# COMMENT FORM
# =====================

class CommentForm(forms.ModelForm):
    """
    Comment form for admin/teacher — can post on student, parent, teacher dashboards.
    """
    class Meta:
        model = Comment
        fields = ['content', 'comment_type', 'is_private']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Write your comment...'
            }),
            'comment_type': forms.Select(attrs={'class': 'form-control'}),
            'is_private': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }


# =====================
# STATUS POST FORM
# =====================

class StatusPostForm(forms.ModelForm):
    """Microblog post by admin — visible on dashboards."""
    class Meta:
        model = StatusPost
        fields = ['content', 'target_role', 'is_pinned']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Write a status update...',
                'maxlength': '500'
            }),
            'target_role': forms.Select(attrs={'class': 'form-control'}),
            'is_pinned': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }


# =====================
# HOLIDAY FORM
# =====================

class HolidayForm(forms.ModelForm):
    """Admin broadcasts holidays and working days to all users."""
    class Meta:
        model = Holiday
        fields = ['title', 'date', 'end_date', 'description', 'holiday_type', 'is_recurring']
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control'}),
            'date': FUTURE_DATE_WIDGET,
            'end_date': FUTURE_DATE_WIDGET,
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'holiday_type': forms.Select(attrs={'class': 'form-control'}),
            'is_recurring': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }


# =====================
# TICKET FORM (Student)
# =====================

class AssignmentTicketForm(forms.ModelForm):
    """Student raises a ticket for offline assignment submission."""
    class Meta:
        model = AssignmentTicket
        fields = ['assignment', 'submission_method', 'details']
        widgets = {
            'assignment': forms.Select(attrs={'class': 'form-control'}),
            'submission_method': forms.Select(attrs={'class': 'form-control'}),
            'details': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': 'Describe how you submitted: email address used, WhatsApp timestamp, physical drop date, etc.'
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['assignment'].queryset = Assignment.objects.filter(status='active')


# =====================
# BRUSH-UP REQUEST FORM (Student)
# =====================

class BrushUpRequestForm(forms.ModelForm):
    """Student requests a brush-up or re-test from the roadmap."""
    class Meta:
        model = BrushUpRequest
        fields = ['topic', 'request_type', 'reason']
        widgets = {
            'topic': forms.Select(attrs={'class': 'form-control'}),
            'request_type': forms.Select(attrs={'class': 'form-control'}),
            'reason': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Explain why you need this session...'
            }),
        }


# =====================
# FEEDBACK FORM
# =====================

class FeedbackForm(forms.ModelForm):
    class Meta:
        model = Feedback
        fields = ['feedback_type', 'subject', 'message']
        widgets = {
            'feedback_type': forms.Select(attrs={'class': 'form-control'}),
            'subject': forms.TextInput(attrs={'class': 'form-control'}),
            'message': forms.Textarea(attrs={'class': 'form-control', 'rows': 5}),
        }


# =====================
# GRADING FORM
# =====================

class GradeSubmissionForm(forms.Form):
    """Teacher grades a student submission."""
    score = forms.DecimalField(
        max_digits=5,
        decimal_places=2,
        min_value=0,
        widget=forms.NumberInput(attrs={'class': 'form-control', 'placeholder': 'Score'})
    )
    feedback = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={'class': 'form-control', 'rows': 3, 'placeholder': 'Feedback for student'})
    )
    status = forms.ChoiceField(
        choices=[('graded', 'Graded'), ('resubmit', 'Needs Resubmission')],
        widget=forms.Select(attrs={'class': 'form-control'})
    )


# =====================
# TICKET RESPONSE FORM (Teacher)
# =====================

class TicketResponseForm(forms.ModelForm):
    class Meta:
        model = AssignmentTicket
        fields = ['status', 'teacher_response']
        widgets = {
            'status': forms.Select(attrs={'class': 'form-control'}),
            'teacher_response': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }


# =====================
# BRUSH-UP RESPONSE FORM (Teacher)
# =====================

class BrushUpResponseForm(forms.ModelForm):
    class Meta:
        model = BrushUpRequest
        fields = ['status', 'scheduled_date', 'teacher_response']
        widgets = {
            'status': forms.Select(attrs={'class': 'form-control'}),
            'scheduled_date': forms.DateTimeInput(attrs={'class': 'form-control', 'type': 'datetime-local'}),
            'teacher_response': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\models.py
<<code:
"""
EduTrack Core Models
Complete database models for the Education Management System
Updated: Photo upload, comments, assignment PDF/DOC, roadmap hierarchy, tickets, brush-up
"""

from django.db import models
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from django.utils import timezone
from datetime import date
import os


# =====================
# VALIDATORS
# =====================

def validate_file_extension(value):
    """Validate file extensions for uploads (PDF, DOC, DOCX)."""
    ext = os.path.splitext(value.name)[1].lower()
    valid_extensions = ['.pdf', '.doc', '.docx']
    if ext not in valid_extensions:
        raise ValidationError(f'Unsupported file extension. Allowed: {", ".join(valid_extensions)}')


def validate_file_size(value):
    """Validate file size (max 10MB)."""
    filesize = value.size
    if filesize > 10485760:  # 10MB
        raise ValidationError("Maximum file size is 10MB")


def validate_image_extension(value):
    """Validate image file extensions."""
    ext = os.path.splitext(value.name)[1].lower()
    valid_extensions = ['.jpg', '.jpeg', '.png', '.gif']
    if ext not in valid_extensions:
        raise ValidationError(f'Unsupported image format. Allowed: {", ".join(valid_extensions)}')


# =====================
# USER PROFILE MODEL
# =====================

class UserProfile(models.Model):
    """Extended user profile with role-based information and photo upload."""

    ROLE_CHOICES = [
        ('admin', 'Administrator'),
        ('teacher', 'Teacher'),
        ('student', 'Student'),
        ('parent', 'Parent'),
    ]

    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='profile'
    )
    role = models.CharField(
        max_length=20,
        choices=ROLE_CHOICES,
        default='student'
    )
    phone_number = models.CharField(
        max_length=15,
        blank=True,
        help_text='Contact phone number'
    )
    profile_photo = models.ImageField(
        upload_to='profile_photos/',
        null=True,
        blank=True,
        validators=[validate_image_extension],
        help_text='Profile picture (JPG, PNG, GIF)'
    )
    date_of_birth = models.DateField(null=True, blank=True)
    address = models.TextField(blank=True, help_text='Residential address')
    pending_amount = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        default=0.00,
        help_text='Running total of unpaid/overdue fees (auto-updated)'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'User Profile'
        verbose_name_plural = 'User Profiles'
        ordering = ['user__first_name', 'user__last_name']

    def __str__(self):
        return f"{self.user.get_full_name()} - {self.get_role_display()}"

    def get_photo_url(self):
        """Return profile photo URL or default."""
        if self.profile_photo:
            return self.profile_photo.url
        return '/static/images/default-avatar.png'

    def is_teacher(self):
        return self.role == 'teacher'

    def is_student(self):
        return self.role == 'student'

    def is_parent(self):
        return self.role == 'parent'

    def is_admin(self):
        return self.role == 'admin' or self.user.is_superuser


# =====================
# STUDENT MODEL
# =====================

class Student(models.Model):
    """Student model with academic information."""

    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='student'
    )
    roll_number = models.CharField(
        max_length=20,
        unique=True,
        blank=True,
        default='',
    )
    grade = models.CharField(max_length=10, help_text='Current grade/class')
    section = models.CharField(max_length=5, help_text='Section (A, B, C, etc.)')
    parent = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='children',
        limit_choices_to={'profile__role': 'parent'},
        help_text='Parent/Guardian'
    )
    admission_date = models.DateField(default=date.today)
    phone_number = models.CharField(
        max_length=15,
        help_text='Student contact phone number e.g. 9187263541'
    )
    address = models.TextField(
        help_text='Student residential address e.g. Viman Nagar, Pune'
    )
    is_active = models.BooleanField(default=True)
    blood_group = models.CharField(max_length=5, blank=True)
    medical_conditions = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Student'
        verbose_name_plural = 'Students'
        ordering = ['grade', 'section', 'roll_number']
        indexes = [
            models.Index(fields=['grade', 'section']),
            models.Index(fields=['roll_number']),
        ]

    def __str__(self):
        return f"{self.user.get_full_name()} ({self.roll_number})"

    def get_full_details(self):
        return f"{self.user.get_full_name()} - Grade {self.grade}{self.section} - {self.roll_number}"

    def get_attendance_rate(self):
        total_days = self.attendance_set.count()
        if total_days == 0:
            return 0
        present_days = self.attendance_set.filter(status='present').count()
        return round((present_days / total_days) * 100, 2)

    def get_average_score(self):
        submissions = self.submission_set.filter(status='graded', score__isnull=False)
        if not submissions.exists():
            return 0
        avg = submissions.aggregate(models.Avg('score'))['score__avg']
        return round(avg, 2) if avg else 0


# =====================
# ASSIGNMENT MODEL
# =====================

class Assignment(models.Model):
    """Assignment/homework model — supports PDF and DOC uploads."""

    STATUS_CHOICES = [
        ('active', 'Active'),
        ('closed', 'Closed'),
        ('draft', 'Draft'),
    ]

    title = models.CharField(max_length=200)
    description = models.TextField(help_text='Detailed assignment instructions')
    created_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='created_assignments'
    )
    subject = models.CharField(max_length=100, blank=True)
    grade = models.CharField(max_length=10, blank=True)
    due_date = models.DateField(help_text='Submission deadline')
    max_score = models.IntegerField(default=100)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='active')
    assignment_file = models.FileField(
        upload_to='assignments/',
        null=True,
        blank=True,
        validators=[validate_file_extension, validate_file_size],
        help_text='Assignment file (PDF, DOC, DOCX — max 10MB)'
    )
    instructions = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Assignment'
        verbose_name_plural = 'Assignments'
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['-created_at']),
            models.Index(fields=['due_date']),
            models.Index(fields=['status']),
        ]

    def __str__(self):
        return f"{self.title} - Due: {self.due_date}"

    def is_overdue(self):
        return self.due_date < date.today() and self.status == 'active'

    def days_until_due(self):
        return (self.due_date - date.today()).days

    def get_submission_stats(self):
        submissions = self.submission_set.all()
        return {
            'total': submissions.count(),
            'submitted': submissions.filter(status__in=['submitted', 'graded']).count(),
            'graded': submissions.filter(status='graded').count(),
            'pending': submissions.filter(status='not_submitted').count(),
        }

    def get_file_extension(self):
        """Return the file extension of uploaded assignment."""
        if self.assignment_file:
            return os.path.splitext(self.assignment_file.name)[1].lower()
        return ''


# =====================
# SUBMISSION MODEL
# =====================

class Submission(models.Model):
    """Student submission for assignments with status tracking."""

    STATUS_CHOICES = [
        ('not_submitted', 'Not Submitted'),
        ('submitted', 'Submitted'),
        ('under_review', 'Under Review'),
        ('graded', 'Graded'),
        ('resubmit', 'Needs Resubmission'),
        ('late', 'Late Submission'),
    ]

    SUBMISSION_METHOD_CHOICES = [
        ('online', 'Online Upload'),
        ('email', 'Email'),
        ('whatsapp', 'WhatsApp'),
        ('physical', 'Physical Submission'),
    ]

    assignment = models.ForeignKey(Assignment, on_delete=models.CASCADE, related_name='submissions')
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='submission_set')
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='not_submitted')
    submission_method = models.CharField(max_length=20, choices=SUBMISSION_METHOD_CHOICES, default='online')
    file = models.FileField(
        upload_to='submissions/',
        null=True,
        blank=True,
        validators=[validate_file_size],
        help_text='Submission file (PDF, DOC, DOCX)'
    )
    submission_text = models.TextField(blank=True)
    submitted_at = models.DateTimeField(null=True, blank=True)
    graded_at = models.DateTimeField(null=True, blank=True)
    score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    feedback = models.TextField(blank=True)
    graded_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='graded_submissions'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Submission'
        verbose_name_plural = 'Submissions'
        ordering = ['-submitted_at']
        unique_together = ['assignment', 'student']
        indexes = [
            models.Index(fields=['status']),
            models.Index(fields=['-submitted_at']),
        ]

    def __str__(self):
        return f"{self.student.user.get_full_name()} - {self.assignment.title}"

    def is_late(self):
        if self.submitted_at and self.assignment.due_date:
            return self.submitted_at.date() > self.assignment.due_date
        return False

    def get_percentage(self):
        if self.score and self.assignment.max_score:
            return round((float(self.score) / self.assignment.max_score) * 100, 2)
        return 0

    def get_grade(self):
        p = self.get_percentage()
        if p >= 90: return 'A+'
        elif p >= 80: return 'A'
        elif p >= 70: return 'B'
        elif p >= 60: return 'C'
        elif p >= 50: return 'D'
        return 'F'


# =====================
# ROADMAP TOPIC MODEL
# =====================

class RoadmapTopic(models.Model):
    """
    Curriculum roadmap topics with full hierarchy (parent/child tree).
    Supports test scheduling and status badges.
    """

    STATUS_CHOICES = [
        ('not_started', 'Not Started'),
        ('in_progress', 'In Progress'),
        ('completed', 'Completed'),
        ('upcoming', 'Upcoming'),
    ]

    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    parent_topic = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='subtopics',
        help_text='Parent topic for hierarchy'
    )
    order = models.IntegerField(default=0)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='upcoming')
    created_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='roadmap_topics'
    )
    subject = models.CharField(max_length=100, blank=True)
    grade = models.CharField(max_length=10, blank=True)
    estimated_hours = models.IntegerField(null=True, blank=True)
    resources = models.TextField(blank=True)
    test_scheduled = models.DateField(null=True, blank=True, help_text='Scheduled test date')
    test_title = models.CharField(max_length=200, blank=True)
    test_duration = models.IntegerField(null=True, blank=True, help_text='Test duration in minutes')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Roadmap Topic'
        verbose_name_plural = 'Roadmap Topics'
        ordering = ['order', 'title']
        indexes = [
            models.Index(fields=['order']),
            models.Index(fields=['status']),
            models.Index(fields=['created_by']),
        ]

    def __str__(self):
        return self.title

    def has_upcoming_test(self):
        if self.test_scheduled:
            return self.test_scheduled >= date.today()
        return False

    def get_level(self):
        """Return depth level in hierarchy (0=root, 1=child, etc.)."""
        level = 0
        parent = self.parent_topic
        while parent:
            level += 1
            parent = parent.parent_topic
        return level

    def get_children(self):
        return self.subtopics.all().order_by('order')

    def get_all_descendants(self):
        descendants = []
        for child in self.subtopics.all():
            descendants.append(child)
            descendants.extend(child.get_all_descendants())
        return descendants

    def get_badge_class(self):
        """Bootstrap badge class based on status."""
        mapping = {
            'completed': 'bg-success',
            'in_progress': 'bg-warning text-dark',
            'upcoming': 'bg-info',
            'not_started': 'bg-secondary',
        }
        return mapping.get(self.status, 'bg-secondary')


# =====================
# ATTENDANCE MODEL
# =====================

class Attendance(models.Model):
    """Student attendance — teacher marks from dashboard."""

    STATUS_CHOICES = [
        ('present', 'Present'),
        ('absent', 'Absent'),
        ('late', 'Late'),
        ('excused', 'Excused'),
        ('half_day', 'Half Day'),
    ]

    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='attendance_set')
    date = models.DateField(default=date.today)
    status = models.CharField(max_length=10, choices=STATUS_CHOICES)
    marked_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='marked_attendance')
    notes = models.TextField(
    blank=True,
    help_text='Reason for absence or any relevant note' )
    time_in = models.TimeField(null=True, blank=True)
    time_out = models.TimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Attendance'
        verbose_name_plural = 'Attendance Records'
        ordering = ['-date']
        unique_together = ['student', 'date']

    def __str__(self):
        return f"{self.student.user.get_full_name()} - {self.date} - {self.status}"


# =====================
# TEST SCORE MODEL
# =====================

class TestScore(models.Model):
    """Test/exam scores linked to roadmap topics."""

    PASS_THRESHOLD = 50  # percent

    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='test_scores')
    test_name = models.CharField(max_length=200)
    subject = models.CharField(max_length=100, blank=True, default='')
    date = models.DateField()
    score = models.DecimalField(max_digits=5, decimal_places=2, default=0)
    max_score = models.DecimalField(max_digits=5, decimal_places=2, default=100)
    grade = models.CharField(max_length=5, blank=True)
    remarks = models.TextField(blank=True)
    roadmap_topic = models.ForeignKey(
        RoadmapTopic,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='test_scores'
    )
    created_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='created_test_scores'
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Test Score'
        verbose_name_plural = 'Test Scores'
        ordering = ['-date']

    def __str__(self):
        return f"{self.student.user.get_full_name()} - {self.test_name} - {self.score}/{self.max_score}"

    def get_percentage(self):
        if self.max_score > 0:
            return round((float(self.score) / float(self.max_score)) * 100, 2)
        return 0

    def is_failed(self):
        return self.get_percentage() < self.PASS_THRESHOLD

    def calculate_grade(self):
        p = self.get_percentage()
        if p >= 90: return 'A+'
        elif p >= 80: return 'A'
        elif p >= 70: return 'B'
        elif p >= 60: return 'C'
        elif p >= 50: return 'D'
        return 'F'


# =====================
# COMMENT MODEL
# =====================

class Comment(models.Model):
    """
    Comments on students, teachers, or parents.
    Admin can comment on all; teachers on student dashboards.
    """

    COMMENT_TYPE_CHOICES = [
        ('student', 'Student Comment'),
        ('teacher', 'Teacher Comment'),
        ('parent', 'Parent Comment'),
        ('general', 'General Comment'),
        ('progress', 'Progress Note'),
        ('behavior', 'Behavior Note'),
    ]

    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name='comments_made')
    target_user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='comments_received')
    comment_type = models.CharField(max_length=20, choices=COMMENT_TYPE_CHOICES, default='general')
    content = models.TextField()
    is_private = models.BooleanField(default=False, help_text='Visible to admins only')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Comment'
        verbose_name_plural = 'Comments'
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.author.get_full_name()} → {self.target_user.get_full_name()}: {self.content[:50]}"


# =====================
# HOLIDAY MODEL
# =====================

class Holiday(models.Model):
    """Holidays and working days — admin broadcasts to all users."""

    HOLIDAY_TYPE_CHOICES = [
        ('holiday', 'Holiday'),
        ('working_day', 'Special Working Day'),
        ('half_day', 'Half Day'),
        ('exam', 'Exam Day'),
    ]

    title = models.CharField(max_length=200)
    date = models.DateField()
    end_date = models.DateField(null=True, blank=True, help_text='End date for multi-day events')
    description = models.TextField(blank=True)
    holiday_type = models.CharField(max_length=20, choices=HOLIDAY_TYPE_CHOICES, default='holiday')
    is_recurring = models.BooleanField(default=False)
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='created_holidays')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Holiday'
        verbose_name_plural = 'Holidays'
        ordering = ['date']

    def __str__(self):
        return f"{self.title} - {self.date}"

    def is_upcoming(self):
        return self.date >= date.today()

    def duration_days(self):
        if self.end_date:
            return (self.end_date - self.date).days + 1
        return 1


# =====================
# STATUS POST MODEL
# =====================

class StatusPost(models.Model):
    """
    Microblogging / status posts by admin.
    Visible on parent and student dashboards.
    """

    TARGET_ROLE_CHOICES = [
        ('all', 'Everyone'),
        ('student', 'Students'),
        ('parent', 'Parents'),
        ('teacher', 'Teachers'),
    ]

    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name='status_posts')
    content = models.TextField(max_length=500)
    target_role = models.CharField(max_length=20, choices=TARGET_ROLE_CHOICES, default='all')
    is_pinned = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Status Post'
        verbose_name_plural = 'Status Posts'
        ordering = ['-is_pinned', '-created_at']

    def __str__(self):
        return f"{self.author.get_full_name()}: {self.content[:50]}"


# =====================
# ASSIGNMENT TICKET MODEL
# =====================

class AssignmentTicket(models.Model):
    """
    Tickets raised by students for offline/non-portal submissions.
    Supports email, WhatsApp, or physical submission methods.
    """

    SUBMISSION_METHOD_CHOICES = [
        ('email', 'Email'),
        ('whatsapp', 'WhatsApp'),
        ('physical', 'Physical'),
    ]

    STATUS_CHOICES = [
        ('open', 'Open'),
        ('acknowledged', 'Acknowledged'),
        ('verified', 'Verified'),
        ('rejected', 'Rejected'),
        ('closed', 'Closed'),
    ]

    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='tickets')
    assignment = models.ForeignKey(Assignment, on_delete=models.CASCADE, related_name='tickets')
    submission_method = models.CharField(max_length=20, choices=SUBMISSION_METHOD_CHOICES)
    details = models.TextField(help_text='Details: email sent to, WhatsApp timestamp, physical date, etc.')
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='open')
    teacher_response = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    resolved_at = models.DateTimeField(null=True, blank=True)
    resolved_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='resolved_tickets'
    )

    class Meta:
        verbose_name = 'Assignment Ticket'
        verbose_name_plural = 'Assignment Tickets'
        ordering = ['-created_at']

    def __str__(self):
        return f"Ticket #{self.id} - {self.student.user.get_full_name()} - {self.assignment.title}"


# =====================
# BRUSH-UP REQUEST MODEL
# =====================

class BrushUpRequest(models.Model):
    """Student requests for brush-up sessions or re-tests on failed tests."""

    REQUEST_TYPE_CHOICES = [
        ('brushup', 'Brush-Up Session'),
        ('retest', 'Re-test Request'),
    ]

    STATUS_CHOICES = [
        ('pending', 'Pending'),
        ('approved', 'Approved'),
        ('scheduled', 'Scheduled'),
        ('completed', 'Completed'),
        ('rejected', 'Rejected'),
    ]

    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='brushup_requests')
    topic = models.ForeignKey(RoadmapTopic, on_delete=models.CASCADE, related_name='brushup_requests')
    request_type = models.CharField(max_length=20, choices=REQUEST_TYPE_CHOICES)
    reason = models.TextField()
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')
    scheduled_date = models.DateTimeField(null=True, blank=True)
    teacher_response = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Brush-Up Request'
        verbose_name_plural = 'Brush-Up Requests'
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.student.user.get_full_name()} - {self.get_request_type_display()} - {self.topic.title}"


# =====================
# NOTIFICATION MODEL
# =====================

class Notification(models.Model):
    """In-app notifications for all user roles."""

    NOTIFICATION_TYPE_CHOICES = [
        ('assignment', 'New Assignment'),
        ('grade', 'Grade Posted'),
        ('comment', 'New Comment'),
        ('holiday', 'Holiday Announcement'),
        ('attendance', 'Attendance Alert'),
        ('general', 'General Notification'),
        ('ticket', 'Ticket Update'),
        ('brushup', 'Brush-Up Update'),
    ]

    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='notifications')
    notification_type = models.CharField(max_length=20, choices=NOTIFICATION_TYPE_CHOICES, default='general')
    title = models.CharField(max_length=200)
    message = models.TextField()
    link = models.CharField(max_length=200, blank=True)
    is_read = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Notification'
        verbose_name_plural = 'Notifications'
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'is_read']),
        ]

    def __str__(self):
        return f"{self.user.get_full_name()} - {self.title}"


# =====================
# FEEDBACK MODEL
# =====================

class Feedback(models.Model):
    """Parent/student feedback submitted to admin."""

    FEEDBACK_TYPE_CHOICES = [
        ('suggestion', 'Suggestion'),
        ('complaint', 'Complaint'),
        ('appreciation', 'Appreciation'),
        ('query', 'Query'),
    ]

    STATUS_CHOICES = [
        ('open', 'Open'),
        ('in_progress', 'In Progress'),
        ('resolved', 'Resolved'),
        ('closed', 'Closed'),
    ]

    submitted_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='submitted_feedback')
    feedback_type = models.CharField(max_length=20, choices=FEEDBACK_TYPE_CHOICES)
    subject = models.CharField(max_length=200)
    message = models.TextField()
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='open')
    response = models.TextField(blank=True)
    responded_by = models.ForeignKey(
        User, on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='responded_feedback'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    resolved_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = 'Feedback'
        verbose_name_plural = 'Feedback'
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.submitted_by.get_full_name()} - {self.subject}"


# =====================
# ANNOUNCEMENT MODEL
# =====================

class Announcement(models.Model):
    """School-wide announcements with priority levels."""

    PRIORITY_CHOICES = [
        ('low', 'Low'),
        ('medium', 'Medium'),
        ('high', 'High'),
        ('urgent', 'Urgent'),
    ]

    TARGET_ROLE_CHOICES = [
        ('all', 'Everyone'),
        ('student', 'Students'),
        ('parent', 'Parents'),
        ('teacher', 'Teachers'),
    ]

    title = models.CharField(max_length=200)
    content = models.TextField()
    priority = models.CharField(max_length=10, choices=PRIORITY_CHOICES, default='medium')
    target_audience = models.CharField(max_length=20, choices=TARGET_ROLE_CHOICES, default='all')
    is_active = models.BooleanField(default=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='announcements')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Announcement'
        verbose_name_plural = 'Announcements'
        ordering = ['-created_at']

    def __str__(self):
        return self.title

    def is_expired(self):
        if self.expires_at:
            return timezone.now() > self.expires_at
        return False


# =====================
# SUBJECT MODEL
# =====================

class Subject(models.Model):
    """
    Subjects created by Admin and assigned to a Teacher.
    SerialNumber = auto PK (Django handles this automatically).
    TID = teacher ForeignKey (UserProfile where role='teacher').
    SET_NULL on teacher delete — subject is never lost, just unassigned
    until Admin reassigns it.
    """

    teacher = models.ForeignKey(
        'UserProfile',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='subjects',
        limit_choices_to={'role': 'teacher'},
        help_text='Teacher responsible for this subject'
    )
    name = models.CharField(
        max_length=100,
        help_text='Subject name e.g. Mathematics, Science, ICT'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Subject'
        verbose_name_plural = 'Subjects'
        ordering = ['name']
        # Same subject name CAN exist under different teachers — valid per schema

    def __str__(self):
        if self.teacher and self.teacher.user:
            return f"{self.name} — {self.teacher.user.get_full_name()}"
        return f"{self.name} — Unassigned"


# =====================
# SUBJECTS TAKEN MODEL
# =====================

class SubjectsTaken(models.Model):
    """
    Join table: which subjects a student is enrolled in.
    student → Student (roll_number is unique on Student model).
    subject → Subject.
    unique_together prevents duplicate enrolments.
    CASCADE on both: deleting student or subject auto-cleans enrolments.
    """

    student = models.ForeignKey(
        'Student',
        on_delete=models.CASCADE,
        related_name='subjects_taken',
        help_text='Student enrolled in this subject'
    )
    subject = models.ForeignKey(
        'Subject',
        on_delete=models.CASCADE,
        related_name='enrolled_students',
        help_text='Subject the student is enrolled in'
    )
    enrolled_at = models.DateField(auto_now_add=True)

    class Meta:
        verbose_name = 'Subject Taken'
        verbose_name_plural = 'Subjects Taken'
        ordering = ['student', 'subject__name']
        unique_together = ['student', 'subject']

    def __str__(self):
        return (
            f"{self.student.user.get_full_name()} "
            f"({self.student.roll_number}) → {self.subject.name}"
        )


# =====================
# TEACHER PROFILE MODEL
# =====================

class TeacherProfile(models.Model):
    """
    Teacher-specific data extending UserProfile.
    Created manually by Admin in /admin/ when a teacher is added.
    OneToOne with UserProfile (role='teacher').
    Salary is stored as Decimal for accurate financial calculations.
    """

    QUALIFICATION_CHOICES = [
        ('b_ed', 'B.Ed'),
        ('m_ed', 'M.Ed'),
        ('b_sc', 'B.Sc'),
        ('m_sc', 'M.Sc'),
        ('b_a', 'B.A'),
        ('m_a', 'M.A'),
        ('phd', 'Ph.D'),
        ('other', 'Other'),
    ]

    profile = models.OneToOneField(
        'UserProfile',
        on_delete=models.CASCADE,
        related_name='teacher_profile',
        limit_choices_to={'role': 'teacher'},
        help_text='UserProfile of the teacher (role must be teacher)'
    )
    salary = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        default=0.00,
        help_text='Monthly salary e.g. 12000.00'
    )
    joining_date = models.DateField(
        null=True,
        blank=True,
        help_text='Date teacher joined the school'
    )
    qualification = models.CharField(
        max_length=10,
        choices=QUALIFICATION_CHOICES,
        blank=True,
        help_text='Highest academic qualification'
    )
    emergency_contact = models.CharField(
        max_length=15,
        blank=True,
        help_text='Emergency contact phone number'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Teacher Profile'
        verbose_name_plural = 'Teacher Profiles'
        ordering = ['profile__user__first_name', 'profile__user__last_name']

    def __str__(self):
        return f"{self.profile.user.get_full_name()} — Teacher Profile"

    def get_full_name(self):
        return self.profile.user.get_full_name()

    def get_subjects(self):
        """Return all subjects assigned to this teacher."""
        return Subject.objects.filter(teacher=self.profile)

    def get_salary_display(self):
        """Return formatted salary string."""
        return f"₹{self.salary:,.2f}"
# =====================
# FEES STATUS MODEL
# =====================

class FeesStatus(models.Model):
    """
    Monthly fee record per student.
    Created by Admin — one record per student per month.
    PendingAmount on Parent is updated automatically via save().
    Student is flagged for discontinuation if 2+ months are Overdue.
    """

    STATUS_CHOICES = [
        ('unpaid',  'Unpaid'),
        ('paid',    'Paid'),
        ('overdue', 'Overdue'),
        ('waived',  'Waived'),
    ]

    student = models.ForeignKey(
        'Student',
        on_delete=models.CASCADE,
        related_name='fees',
        help_text='Student this fee record belongs to'
    )
    month = models.CharField(
        max_length=7,
        help_text='Month and year in MM/YYYY format e.g. 01/2026'
    )
    fees = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        help_text='Fee amount set by Admin e.g. 10000.00'
    )
    status = models.CharField(
        max_length=10,
        choices=STATUS_CHOICES,
        default='unpaid',
        help_text='Payment status'
    )
    due_date = models.DateField(
        help_text='Date by which payment is due'
    )
    paid_date = models.DateField(
        null=True,
        blank=True,
        help_text='Date payment was received — leave blank if not yet paid'
    )
    remarks = models.TextField(
        blank=True,
        help_text='Optional notes e.g. partial payment, scholarship etc.'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Fee Status'
        verbose_name_plural = 'Fee Status Records'
        ordering = ['-month', 'student']
        unique_together = ['student', 'month']
        # Prevents duplicate fee records for same student same month

    def __str__(self):
        return (
            f"{self.student.user.get_full_name()} "
            f"({self.student.roll_number}) — "
            f"{self.month} — {self.get_status_display()}"
        )

    def save(self, *args, **kwargs):
        """
        Auto-update parent's PendingAmount when fee status changes.
        Also auto-set paid_date when status changes to paid.
        """
        from datetime import date as today_date

        # Auto-set paid_date when marked as paid
        if self.status == 'paid' and not self.paid_date:
            self.paid_date = today_date.today()

        # Clear paid_date if status changed away from paid
        if self.status != 'paid':
            self.paid_date = None

        super().save(*args, **kwargs)

        # Update parent's running PendingAmount
        self._update_parent_pending()

        # Check discontinuation flag (2+ overdue payments)
        self._check_discontinuation()

    def _update_parent_pending(self):
        """Recalculate and update parent's PendingAmount."""
        try:
            parent_user = self.student.parent
            if not parent_user:
                return

            # Sum all unpaid + overdue fees for this student
            from django.db.models import Sum
            total_pending = FeesStatus.objects.filter(
                student=self.student,
                status__in=['unpaid', 'overdue']
            ).aggregate(total=Sum('fees'))['total'] or 0

            # Update UserProfile of parent — store in a new field
            # (we add pending_amount to UserProfile in the next step)
            profile = parent_user.profile
            profile.pending_amount = total_pending
            profile.save(update_fields=['pending_amount'])
        except Exception:
            pass

    def _check_discontinuation(self):
        """Flag student if 2 or more payments are overdue."""
        try:
            overdue_count = FeesStatus.objects.filter(
                student=self.student,
                status='overdue'
            ).count()

            student = self.student
            if overdue_count >= 2:
                student.is_active = False
            else:
                student.is_active = True
            student.save(update_fields=['is_active'])
        except Exception:
            pass

    def is_overdue(self):
        """Returns True if unpaid and past due date."""
        from datetime import date as today_date
        return self.status == 'unpaid' and self.due_date < today_date.today()

# =====================
# TEACHER ATTENDANCE MODEL
# =====================

class TeacherAttendance(models.Model):
    """
    Teacher attendance — marked by Admin.
    Separate from student Attendance for clean querying,
    salary calculation, and permission separation.
    """

    STATUS_CHOICES = [
        ('present',  'Present'),
        ('absent',   'Absent'),
        ('late',     'Late'),
        ('excused',  'Excused'),
        ('half_day', 'Half Day'),
    ]

    teacher = models.ForeignKey(
        'UserProfile',
        on_delete=models.CASCADE,
        related_name='teacher_attendance',
        limit_choices_to={'role': 'teacher'},
        help_text='Teacher whose attendance is being marked'
    )
    date = models.DateField(
        default=date.today,
        help_text='Date of attendance'
    )
    status = models.CharField(
        max_length=10,
        choices=STATUS_CHOICES,
        help_text='Attendance status'
    )
    marked_by = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='marked_teacher_attendance',
        help_text='Admin who marked this attendance'
    )
    notes = models.TextField(
        blank=True,
        help_text='Reason for absence or any relevant note'
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'Teacher Attendance'
        verbose_name_plural = 'Teacher Attendance Records'
        ordering = ['-date', 'teacher']
        unique_together = ['teacher', 'date']
        # Prevents duplicate attendance for same teacher same day

    def __str__(self):
        return (
            f"{self.teacher.user.get_full_name()} — "
            f"{self.date} — {self.get_status_display()}"
        )

    def get_attendance_rate(self):
        """Calculate attendance percentage for this teacher."""
        total = TeacherAttendance.objects.filter(teacher=self.teacher).count()
        if total == 0:
            return 0
        present = TeacherAttendance.objects.filter(
            teacher=self.teacher,
            status__in=['present', 'late', 'half_day']
        ).count()
        return round((present / total) * 100, 2)
    
# =====================
# PETTY CASH MODELS
# =====================
class PettyExpense(models.Model):
    CATEGORY_CHOICES = [
        ('rent',       'Rent'),
        ('stationary', 'Stationary'),
        ('events',     'Events'),
        ('utilities',  'Utilities'),
        ('other',      'Other'),
    ]
    description = models.CharField(max_length=200)
    amount      = models.DecimalField(max_digits=10, decimal_places=2)
    date        = models.DateField(default=date.today)
    category    = models.CharField(max_length=20, choices=CATEGORY_CHOICES, default='other')
    added_by    = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    created_at  = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-date']
        verbose_name = 'Petty Expense'

    def __str__(self):
        return f"{self.description} — ₹{self.amount} ({self.date})"

# =====================
# SIGNAL HANDLERS
# =====================

from django.db.models.signals import post_save
from django.dispatch import receiver


@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """Auto-create UserProfile when User is created."""
    if created and not hasattr(instance, 'profile'):
        UserProfile.objects.get_or_create(user=instance, defaults={'role': 'student'})


@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    """Save UserProfile when User is saved."""
    if hasattr(instance, 'profile'):
        try:
            instance.profile.save()
        except Exception:
            pass

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\signals.py
<<code:
"""
EduTrack Core Signals
Automated notifications and profile management.
NOTE: UserProfile creation signal is also in models.py — 
      signals.py is the canonical location, models.py version is a safety net.
"""

from django.db.models.signals import post_save, pre_delete
from django.dispatch import receiver
from django.contrib.auth.models import User
from django.utils import timezone


# Import models lazily to avoid circular imports
def get_models():
    from .models import (
        UserProfile, Student, Assignment, Submission,
        Attendance, Comment, Holiday, StatusPost,
        AssignmentTicket, BrushUpRequest, TestScore,
        Notification, Feedback
    )
    return (UserProfile, Student, Assignment, Submission,
            Attendance, Comment, Holiday, StatusPost,
            AssignmentTicket, BrushUpRequest, TestScore,
            Notification, Feedback)


# =====================
# USER PROFILE — auto-create on user creation
# =====================

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """Auto-create UserProfile when a new user is registered."""
    if created:
        UserProfile, *_ = get_models()
        UserProfile.objects.get_or_create(user=instance, defaults={'role': 'student'})


# =====================
# ASSIGNMENT — notify students and auto-create submission records
# =====================

@receiver(post_save, sender='core.Assignment')
def on_assignment_created(sender, instance, created, **kwargs):
    """
    When a new active assignment is created:
    1. Create 'not_submitted' Submission records for all students.
    2. Send notifications to all students.
    """
    if not created or instance.status != 'active':
        return

    _, Student, _, Submission, _, _, _, _, _, _, _, Notification, _ = get_models()

    students = Student.objects.all().select_related('user')

    submissions_to_create = []
    notifications_to_create = []

    for student in students:
        if not Submission.objects.filter(assignment=instance, student=student).exists():
            submissions_to_create.append(
                Submission(assignment=instance, student=student, status='not_submitted')
            )
        notifications_to_create.append(
            Notification(
                user=student.user,
                notification_type='assignment',
                title='New Assignment Posted',
                message=f'"{instance.title}" — Due: {instance.due_date}',
                link=f'/student/assignment/{instance.id}/',
            )
        )

    if submissions_to_create:
        Submission.objects.bulk_create(submissions_to_create, ignore_conflicts=True)
    if notifications_to_create:
        Notification.objects.bulk_create(notifications_to_create)


# =====================
# SUBMISSION — notify teacher when submitted; notify student when graded
# =====================

@receiver(post_save, sender='core.Submission')
def on_submission_updated(sender, instance, created, **kwargs):
    """Notify teacher on submission; notify student on grading."""
    _, _, _, _, _, _, _, _, _, _, _, Notification, _ = get_models()

    if not created and instance.status == 'graded' and instance.graded_by:
        # Notify the student
        Notification.objects.create(
            user=instance.student.user,
            notification_type='grade',
            title='Assignment Graded',
            message=f'Your submission for "{instance.assignment.title}" has been graded. '
                    f'Score: {instance.score}/{instance.assignment.max_score}',
            link=f'/student/assignment/{instance.assignment.id}/',
        )

    elif instance.status == 'submitted':
        # Notify the teacher who owns the assignment
        teacher = instance.assignment.created_by
        Notification.objects.get_or_create(
            user=teacher,
            notification_type='assignment',
            title='New Submission',
            message=f'{instance.student.user.get_full_name()} submitted "{instance.assignment.title}"',
            link=f'/teacher/submission/{instance.id}/',
        )


# =====================
# HOLIDAY — notify all users when broadcast
# (Additional signal — primary notification is in the view)
# =====================

@receiver(post_save, sender='core.Holiday')
def on_holiday_created(sender, instance, created, **kwargs):
    """Already handled in HolidayBroadcastView — this is a safety net."""
    pass


# =====================
# COMMENT — notify target user
# =====================

@receiver(post_save, sender='core.Comment')
def on_comment_posted(sender, instance, created, **kwargs):
    if not created or instance.is_private:
        return
    _, _, _, _, _, _, _, _, _, _, _, Notification, _ = get_models()
    Notification.objects.create(
        user=instance.target_user,
        notification_type='comment',
        title='New Comment',
        message=f'{instance.author.get_full_name()} posted a comment on your profile.',
        link=f'/comments/{instance.target_user.id}/',
    )


# =====================
# BRUSHUP REQUEST — notify teacher when student requests
# =====================

@receiver(post_save, sender='core.BrushUpRequest')
def on_brushup_requested(sender, instance, created, **kwargs):
    if not created:
        return
    _, _, _, _, _, _, _, _, _, _, _, Notification, _ = get_models()
    teacher = instance.topic.created_by
    Notification.objects.create(
        user=teacher,
        notification_type='brushup',
        title='New Brush-Up Request',
        message=f'{instance.student.user.get_full_name()} requested '
                f'{instance.get_request_type_display()} for "{instance.topic.title}".',
        link=f'/teacher/brushup-requests/',
    )

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\templatetags\__init__.py
<<code:

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\templatetags\dict_extras.py
<<code:
"""
EduTrack Template Extras
Place this file at:
  core/templatetags/dict_extras.py

Also make sure core/templatetags/__init__.py exists (even if empty).
Load in templates with: {% load dict_extras %}
"""
from django import template

register = template.Library()


@register.filter
def get_item(dictionary, key):
    """
    Get a value from a dict by key in Django templates.
    Usage: {{ my_dict|get_item:key_variable }}
    """
    if dictionary is None:
        return None
    return dictionary.get(key)

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\urls.py
<<code:
"""
EduTrack Core URL Configuration
All routes for all roles: admin, teacher, parent, student.
"""

from django.urls import path
from django.contrib.auth import views as auth_views

from .views import (
    # Auth
    LoginView, LogoutView, DashboardView,

    # Admin
    AdminDashboardView, AdminStudentListView, StudentCreateView,
    StudentUpdateView, StudentDeleteView, StudentDetailView, StudentGridView,
    ParentCreateView, ParentListView, ParentUpdateView, ParentDeleteView,
    TeacherListView, TeacherCreateView, TeacherUpdateView, TeacherDeleteView,
    AllTeachersRoadmapView, HolidayBroadcastView, HolidayListView, HolidayDeleteView,
    StatusPostCreateView, StatusPostListView, StatusPostDeleteView,
    AdminAnalyticsView,AdminNotificationListView,AdminMarkNotificationReadView,
    AdminMarkAllNotificationsReadView,AdminTicketListView,AdminBrushUpListView,AdminAssignmentListView,
    AdminTeacherAttendanceView, AdminFinanceView, AdminTeacherPerformanceView,PettyExpense,

    # Teacher
    TeacherDashboardView, StudentListView, TeacherStudentDetailView,
    AssignmentListView, AssignmentCreateView, AssignmentUpdateView,
    AssignmentDeleteView, AssignmentDetailView,
    SubmissionListView, SubmissionDetailView, SubmissionGradeView, GradeSubmissionView,
    RoadmapTopicListView, RoadmapTopicCreateView, RoadmapTopicUpdateView,
    RoadmapTopicDeleteView, RoadmapTreeView, RoadmapCSVUploadView,
    download_roadmap_template,
    AttendanceMarkView, AttendanceHistoryView, BulkAttendanceView,
    TicketListViewTeacher, TicketResponseView,
    BrushUpRequestListViewTeacher, BrushUpResponseView,

    # Parent
    ParentDashboardView, ParentStudentProgressView, ParentAssignmentStatusView,
    ParentRoadmapView, ParentFeedbackView, ParentStudentAttendanceView, ParentAttendanceView,

    # Student
    StudentDashboardView, StudentAssignmentListView, StudentAssignmentDetailView,
    StudentSubmissionCreateView, StudentProgressView, StudentRoadmapView,
    StudentAttendanceView, StudentTestScoresView,
    RaiseTicketView, TicketListView, TicketDetailView,
    BrushUpRequestView, BrushUpRequestListView, RetestRequestView,

    # Common
    ProfilePhotoUpdateView, ProfileUpdateView, ProfileDetailView,
    CommentCreateView, CommentListView, CommentDeleteView,
    NotificationListView, MarkNotificationReadView, MarkAllNotificationsReadView,

    # API
    RoadmapTreeAPIView, AssignmentStatusAPIView, StudentProgressAPIView,
    AttendanceAPIView, NotificationCountAPIView,
)

# NOTE: No app_name here — all views use plain URL names (no namespace)

urlpatterns = [

    # =====================
    # AUTH
    # =====================
    path('', LoginView.as_view(), name='login'),
    path('login/', LoginView.as_view(), name='login'),
    path('logout/', LogoutView.as_view(), name='logout'),
    path('dashboard/', DashboardView.as_view(), name='dashboard'),

    # Password Reset
    path('password-reset/', auth_views.PasswordResetView.as_view(
        template_name='registration/password_reset.html'), name='password_reset'),
    path('password-reset/done/', auth_views.PasswordResetDoneView.as_view(
        template_name='registration/password_reset_done.html'), name='password_reset_done'),
    path('password-reset-confirm/<uidb64>/<token>/', auth_views.PasswordResetConfirmView.as_view(
        template_name='registration/password_reset_confirm.html'), name='password_reset_confirm'),
    path('password-reset-complete/', auth_views.PasswordResetCompleteView.as_view(
        template_name='registration/password_reset_complete.html'), name='password_reset_complete'),

    # Password Change
    path('password-change/', auth_views.PasswordChangeView.as_view(
        template_name='registration/password_change.html',
        success_url='/password-change/done/'), name='password_change'),
    path('password-change/done/', auth_views.PasswordChangeDoneView.as_view(
        template_name='registration/password_change_done.html'), name='password_change_done'),

    # =====================
    # ADMIN PANEL
    # =====================
    path('admin-panel/', AdminDashboardView.as_view(), name='admin_dashboard'),
    path('admin-panel/analytics/', AdminAnalyticsView.as_view(), name='admin_analytics'),

    path('admin-panel/students/', AdminStudentListView.as_view(), name='admin_student_list'),
    path('admin-panel/students/grid/', StudentGridView.as_view(), name='student_grid'),
    path('admin-panel/student/add/', StudentCreateView.as_view(), name='student_add'),
    path('admin-panel/student/<int:pk>/', StudentDetailView.as_view(), name='student_detail'),
    path('admin-panel/student/<int:pk>/edit/', StudentUpdateView.as_view(), name='student_edit'),
    path('admin-panel/student/<int:pk>/delete/', StudentDeleteView.as_view(), name='student_delete'),

    path('admin-panel/parents/', ParentListView.as_view(), name='parent_list'),
    path('admin-panel/parent/add/', ParentCreateView.as_view(), name='parent_add'),
    path('admin-panel/parent/<int:pk>/edit/', ParentUpdateView.as_view(), name='parent_edit'),
    path('admin-panel/parent/<int:pk>/delete/', ParentDeleteView.as_view(), name='parent_delete'),

    path('admin-panel/teachers/', TeacherListView.as_view(), name='teacher_list'),
    path('admin-panel/teacher/add/', TeacherCreateView.as_view(), name='teacher_add'),
    path('admin-panel/teacher/<int:pk>/edit/', TeacherUpdateView.as_view(), name='teacher_edit'),
    path('admin-panel/teacher/<int:pk>/delete/', TeacherDeleteView.as_view(), name='teacher_delete'),

    path('admin-panel/roadmaps/', AllTeachersRoadmapView.as_view(), name='all_roadmaps'),

    path('admin-panel/holidays/', HolidayListView.as_view(), name='holiday_list'),
    path('admin-panel/holiday/add/', HolidayBroadcastView.as_view(), name='holiday_add'),
    path('admin-panel/holiday/<int:pk>/delete/', HolidayDeleteView.as_view(), name='holiday_delete'),

    path('admin-panel/status/post/', StatusPostCreateView.as_view(), name='status_post'),
    path('admin-panel/status/list/', StatusPostListView.as_view(), name='status_list'),
    path('admin-panel/status/<int:pk>/delete/', StatusPostDeleteView.as_view(), name='status_delete'),
    path('admin-panel/notifications/', AdminNotificationListView.as_view(), name='admin_notifications'),
    path('admin-panel/notification/<int:pk>/read/', AdminMarkNotificationReadView.as_view(), name='admin_mark_notification_read'),
    path('admin-panel/notifications/read-all/', AdminMarkAllNotificationsReadView.as_view(), name='admin_mark_all_notifications_read'),
    path('admin-panel/tickets/', AdminTicketListView.as_view(), name='admin_tickets'),
    path('admin-panel/brushups/', AdminBrushUpListView.as_view(), name='admin_brushups'),
    path('admin-panel/assignments/', AdminAssignmentListView.as_view(), name='admin_assignment_list'),
    path('admin-panel/teacher-attendance/', AdminTeacherAttendanceView.as_view(), name='admin_teacher_attendance'),
    path('admin-panel/finance/', AdminFinanceView.as_view(), name='admin_finance'),
    path('admin-panel/teacher-performance/', AdminTeacherPerformanceView.as_view(), name='admin_teacher_performance'),

    # =====================
    # TEACHER
    # =====================
    path('teacher/dashboard/', TeacherDashboardView.as_view(), name='teacher_dashboard'),

    path('teacher/students/', StudentListView.as_view(), name='student_list'),
    path('teacher/student/<int:pk>/', TeacherStudentDetailView.as_view(), name='teacher_student_detail'),

    path('teacher/assignments/', AssignmentListView.as_view(), name='assignment_list'),
    path('teacher/assignment/create/', AssignmentCreateView.as_view(), name='assignment_create'),
    path('teacher/assignment/<int:pk>/', AssignmentDetailView.as_view(), name='assignment_detail'),
    path('teacher/assignment/<int:pk>/edit/', AssignmentUpdateView.as_view(), name='assignment_edit'),
    path('teacher/assignment/<int:pk>/delete/', AssignmentDeleteView.as_view(), name='assignment_delete'),

    path('teacher/assignment/<int:assignment_id>/submissions/', SubmissionListView.as_view(), name='submission_list'),
    path('teacher/submission/<int:pk>/', SubmissionDetailView.as_view(), name='submission_detail'),
    path('teacher/submission/<int:pk>/grade/', SubmissionGradeView.as_view(), name='submission_grade'),
    path('teacher/submission/<int:pk>/grade-quick/', GradeSubmissionView.as_view(), name='grade_submission'),

    path('teacher/roadmap/', RoadmapTopicListView.as_view(), name='roadmap_list'),
    path('teacher/roadmap/create/', RoadmapTopicCreateView.as_view(), name='roadmap_create'),
    path('teacher/roadmap/<int:pk>/edit/', RoadmapTopicUpdateView.as_view(), name='roadmap_edit'),
    path('teacher/roadmap/<int:pk>/delete/', RoadmapTopicDeleteView.as_view(), name='roadmap_delete'),
    path('teacher/roadmap/tree/', RoadmapTreeView.as_view(), name='roadmap_tree'),
    path('teacher/roadmap/upload/', RoadmapCSVUploadView.as_view(), name='roadmap_upload'),
    path('teacher/roadmap/template/', download_roadmap_template, name='download_roadmap_template'),

    path('teacher/attendance/', AttendanceMarkView.as_view(), name='mark_attendance'),
    path('teacher/attendance/bulk/', BulkAttendanceView.as_view(), name='bulk_attendance'),
    path('teacher/attendance/history/', AttendanceHistoryView.as_view(), name='attendance_history'),
    path('teacher/attendance/student/<int:student_id>/', AttendanceHistoryView.as_view(), name='student_attendance_history'),

    path('teacher/tickets/', TicketListViewTeacher.as_view(), name='teacher_tickets'),
    path('teacher/ticket/<int:pk>/respond/', TicketResponseView.as_view(), name='ticket_respond'),

    path('teacher/brushup-requests/', BrushUpRequestListViewTeacher.as_view(), name='teacher_brushup_requests'),
    path('teacher/brushup/<int:pk>/respond/', BrushUpResponseView.as_view(), name='brushup_respond'),
    path('teacher/assignment/add/', AssignmentCreateView.as_view(), name='assignment_add'),

    # =====================
    # PARENT
    # =====================
    path('parent/dashboard/', ParentDashboardView.as_view(), name='parent_dashboard'),
    path('parent/student/<int:student_id>/progress/', ParentStudentProgressView.as_view(), name='parent_student_progress'),
    path('parent/student/<int:student_id>/assignments/', ParentAssignmentStatusView.as_view(), name='parent_assignment_status'),
    path('parent/student/<int:student_id>/roadmap/', ParentRoadmapView.as_view(), name='parent_roadmap'),
    path('parent/student/<int:student_id>/attendance/', ParentStudentAttendanceView.as_view(), name='parent_student_attendance'),
    path('parent/attendance/<int:student_id>/', ParentAttendanceView.as_view(), name='parent_attendance'),
    path('parent/feedback/', ParentFeedbackView.as_view(), name='parent_feedback'),

    # =====================
    # STUDENT
    # =====================
    path('student/dashboard/', StudentDashboardView.as_view(), name='student_dashboard'),
    path('student/assignments/', StudentAssignmentListView.as_view(), name='student_assignments'),
    path('student/assignment/<int:pk>/', StudentAssignmentDetailView.as_view(), name='student_assignment_detail'),
    path('student/assignment/<int:assignment_id>/submit/', StudentSubmissionCreateView.as_view(), name='student_submit_assignment'),
    path('student/progress/', StudentProgressView.as_view(), name='student_progress'),
    path('student/roadmap/', StudentRoadmapView.as_view(), name='student_roadmap'),
    path('student/attendance/', StudentAttendanceView.as_view(), name='student_attendance'),
    path('student/attendance/<int:pk>/', StudentAttendanceView.as_view(), name='student_attendance_detail'),
    path('student/test-scores/', StudentTestScoresView.as_view(), name='student_test_scores'),
    path('student/ticket/raise/', RaiseTicketView.as_view(), name='raise_ticket'),
    path('student/tickets/', TicketListView.as_view(), name='ticket_list'),
    path('student/ticket/<int:pk>/', TicketDetailView.as_view(), name='ticket_detail'),
    path('student/brushup/request/', BrushUpRequestView.as_view(), name='brushup_request'),
    path('student/brushup/list/', BrushUpRequestListView.as_view(), name='brushup_list'),
    path('student/retest/request/<int:test_id>/', RetestRequestView.as_view(), name='retest_request'),

    # =====================
    # COMMON (All Roles)
    # =====================
    path('profile/', ProfileDetailView.as_view(), name='profile_detail'),
    path('profile/update/', ProfileUpdateView.as_view(), name='profile_update'),
    path('profile/photo/update/', ProfilePhotoUpdateView.as_view(), name='profile_photo_update'),

    path('comment/add/<int:user_id>/', CommentCreateView.as_view(), name='comment_add'),
    path('comments/<int:user_id>/', CommentListView.as_view(), name='comment_list'),
    path('comment/<int:pk>/delete/', CommentDeleteView.as_view(), name='comment_delete'),

    path('roadmaps/', AllTeachersRoadmapView.as_view(), name='public_roadmaps'),
    path('roadmap/tree/', RoadmapTreeView.as_view(), name='roadmap_tree_public'),

    path('notifications/', NotificationListView.as_view(), name='notifications'),
    path('notification/<int:pk>/read/', MarkNotificationReadView.as_view(), name='mark_notification_read'),
    path('notifications/read-all/', MarkAllNotificationsReadView.as_view(), name='mark_all_notifications_read'),

    # =====================
    # API ENDPOINTS
    # =====================
    path('api/roadmap/tree/', RoadmapTreeAPIView.as_view(), name='api_roadmap_tree'),
    path('api/roadmap/tree/<int:teacher_id>/', RoadmapTreeAPIView.as_view(), name='api_teacher_roadmap_tree'),
    path('api/assignment/<int:assignment_id>/status/', AssignmentStatusAPIView.as_view(), name='api_assignment_status'),
    path('api/student/<int:student_id>/progress/', StudentProgressAPIView.as_view(), name='api_student_progress'),
    path('api/attendance/<int:student_id>/', AttendanceAPIView.as_view(), name='api_attendance'),
    path('api/notifications/count/', NotificationCountAPIView.as_view(), name='api_notification_count'),
]

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\core\views.py
<<code:
"""
EduTrack Core Views
Fixed: Adding student/parent (page hanging), clicking student on dashboard,
       assignment creation, comments, submission status, roadmap tree view.
New:   Photo update for all roles, profile update, roadmap tree badges,
       admin analytics, all-teachers roadmap view, holiday broadcast.
"""

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.models import User
from django.views.generic import ListView, CreateView, UpdateView, DeleteView
from django.views import View
from django.urls import reverse_lazy, reverse
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponse, HttpResponseRedirect, JsonResponse, HttpResponseForbidden
from django.db.models import Avg, Sum, Count, Q
from django.db.models.functions import TruncMonth
from datetime import date, datetime, timedelta
import csv
import json

from .models import (
    Student, Assignment, Submission, RoadmapTopic, UserProfile,
    TestScore, Comment, StatusPost, Holiday, Attendance,
    AssignmentTicket, BrushUpRequest, Feedback, Notification,
    TeacherAttendance, TeacherProfile, FeesStatus, PettyExpense, Subject,
)
from .forms import (
    StudentForm, AssignmentForm, SubmissionForm, RoadmapTopicForm,
    FeedbackForm, ParentForm, TeacherForm, CommentForm, ProfilePhotoForm,
    ProfileUpdateForm, UserNameForm, AttendanceForm, StatusPostForm,
    HolidayForm, GradeSubmissionForm, AssignmentTicketForm,
    BrushUpRequestForm, BrushUpResponseForm, TicketResponseForm
)

# ============================================================================
# ROLE-BASED ACCESS MIXINS
# ============================================================================

class AdminRequiredMixin(UserPassesTestMixin):
    def test_func(self):
        return (
            self.request.user.is_superuser or
            (hasattr(self.request.user, 'profile') and
             self.request.user.profile.role == 'admin')
        )

    def handle_no_permission(self):
        messages.error(self.request, 'Admin access required.')
        return redirect('dashboard')
#---------------------------------------------------------------------------------------------------

class TeacherOrAdminMixin(UserPassesTestMixin):
    def test_func(self):
        if not hasattr(self.request.user, 'profile'):
            return False
        return self.request.user.profile.role in ('teacher', 'admin') or self.request.user.is_superuser

    def handle_no_permission(self):
        messages.error(self.request, 'Teacher or Admin access required.')
        return redirect('dashboard')
#---------------------------------------------------------------------------------------------------

class TeacherRequiredMixin(UserPassesTestMixin):
    def test_func(self):
        return (
            hasattr(self.request.user, 'profile') and
            self.request.user.profile.is_teacher()
        )

    def handle_no_permission(self):
        messages.error(self.request, 'Teacher access only.')
        return redirect('dashboard')
#---------------------------------------------------------------------------------------------------

class StudentRequiredMixin(UserPassesTestMixin):
    def test_func(self):
        return (
            hasattr(self.request.user, 'profile') and
            self.request.user.profile.is_student()
        )

    def handle_no_permission(self):
        messages.error(self.request, 'Student access only.')
        return redirect('dashboard')
#---------------------------------------------------------------------------------------------------

class ParentRequiredMixin(UserPassesTestMixin):
    def test_func(self):
        return (
            hasattr(self.request.user, 'profile') and
            self.request.user.profile.is_parent()
        )

    def handle_no_permission(self):
        messages.error(self.request, 'Parent access only.')
        return redirect('dashboard')


# ============================================================================
# AUTHENTICATION VIEWS
# ============================================================================

class LoginView(View):
    """Login with profile photo support — works for all roles."""
    template_name = 'login.html'

    def get(self, request):
        if request.user.is_authenticated:
            return redirect('dashboard')
        return render(request, self.template_name)

    def post(self, request):
        username = request.POST.get('username', '').strip()
        password = request.POST.get('password', '')
        user = authenticate(request, username=username, password=password)

        if user is not None:
            login(request, user)
            messages.success(request, f'Welcome back, {user.get_full_name() or user.username}!')
            return redirect('dashboard')
        else:
            messages.error(request, 'Invalid username or password.')
            return render(request, self.template_name)
#---------------------------------------------------------------------------------------------------

class LogoutView(View):
    def get(self, request):
        logout(request)
        messages.info(request, 'You have been logged out.')
        return redirect('login')
#---------------------------------------------------------------------------------------------------

class DashboardView(LoginRequiredMixin, View):
    """Redirects to role-specific dashboard. FIXED: handles missing UserProfile."""
    def get(self, request):
        # Auto-create profile if missing (e.g. superuser created via createsuperuser)
        profile, _ = UserProfile.objects.get_or_create(
            user=request.user,
            defaults={'role': 'admin' if request.user.is_superuser else 'student'}
        )
        role = profile.role
        if role == 'admin' or request.user.is_superuser:
            return redirect('admin_dashboard')
        elif role == 'teacher':
            return redirect('teacher_dashboard')
        elif role == 'student':
            return redirect('student_dashboard')
        elif role == 'parent':
            return redirect('parent_dashboard')
        messages.error(request, 'Your account has no role. Contact admin.')
        return redirect('login')


# ============================================================================
# COMMON VIEWS — All Roles
# ============================================================================

class ProfilePhotoUpdateView(LoginRequiredMixin, View):
    """All roles can update their profile photo."""
    def post(self, request):
        profile, _ = UserProfile.objects.get_or_create(user=request.user)
        form = ProfilePhotoForm(request.POST, request.FILES, instance=profile)
        if form.is_valid():
            form.save()
            messages.success(request, 'Profile photo updated!')
        else:
            messages.error(request, 'Error updating photo. Use JPG/PNG/GIF.')
        return redirect(request.META.get('HTTP_REFERER', 'dashboard'))
#---------------------------------------------------------------------------------------------------

class ProfileDetailView(LoginRequiredMixin, View):
    """View own profile."""
    template_name = 'profile/profile_detail.html'

    def get(self, request):
        profile, _ = UserProfile.objects.get_or_create(user=request.user)
        return render(request, self.template_name, {'profile': profile})
#---------------------------------------------------------------------------------------------------

class ProfileUpdateView(LoginRequiredMixin, View):
    """Update profile info and name."""
    template_name = 'profile/profile_update.html'

    def get(self, request):
        profile, _ = UserProfile.objects.get_or_create(user=request.user)
        profile_form = ProfileUpdateForm(instance=profile)
        name_form = UserNameForm(instance=request.user)
        return render(request, self.template_name, {
            'profile_form': profile_form,
            'name_form': name_form
        })

    def post(self, request):
        profile, _ = UserProfile.objects.get_or_create(user=request.user)
        profile_form = ProfileUpdateForm(request.POST, instance=profile)
        name_form = UserNameForm(request.POST, instance=request.user)
        if profile_form.is_valid() and name_form.is_valid():
            profile_form.save()
            name_form.save()
            messages.success(request, 'Profile updated successfully!')
            return redirect('profile_detail')
        return render(request, self.template_name, {
            'profile_form': profile_form,
            'name_form': name_form
        })
#---------------------------------------------------------------------------------------------------

class CommentCreateView(LoginRequiredMixin, View):
    """Admin or teacher posts a comment on any user's profile."""
    def post(self, request, user_id):
        target_user = get_object_or_404(User, pk=user_id)
        form = CommentForm(request.POST)
        if form.is_valid():
            comment = form.save(commit=False)
            comment.author = request.user
            comment.target_user = target_user
            comment.save()
            messages.success(request, 'Comment posted.')
        else:
            messages.error(request, 'Error posting comment.')
        return redirect(request.META.get('HTTP_REFERER', 'dashboard'))
#---------------------------------------------------------------------------------------------------
    
class CommentListView(LoginRequiredMixin, ListView):
    model = Comment
    template_name = 'comments/comment_list.html'
    context_object_name = 'comments'
    paginate_by = 20

    def get_queryset(self):
        user_id = self.kwargs.get('user_id')
        qs = Comment.objects.filter(target_user_id=user_id)
        # Non-admins cannot see private comments
        if not (self.request.user.is_superuser or
                (hasattr(self.request.user, 'profile') and self.request.user.profile.role == 'admin')):
            qs = qs.filter(is_private=False)
        return qs
#---------------------------------------------------------------------------------------------------

class CommentDeleteView(LoginRequiredMixin, View):
    def post(self, request, pk):
        comment = get_object_or_404(Comment, pk=pk)
        if comment.author == request.user or request.user.is_superuser:
            comment.delete()
            messages.success(request, 'Comment deleted.')
        else:
            messages.error(request, 'Permission denied.')
        return redirect(request.META.get('HTTP_REFERER', 'dashboard'))
#---------------------------------------------------------------------------------------------------

class NotificationListView(LoginRequiredMixin, ListView):
    model = Notification
    template_name = 'notifications/notification_list.html'
    context_object_name = 'notifications'
    paginate_by = 20

    def get_queryset(self):
        return Notification.objects.filter(user=self.request.user).order_by('-created_at')
#---------------------------------------------------------------------------------------------------

class MarkNotificationReadView(LoginRequiredMixin, View):
    def post(self, request, pk):
        notif = get_object_or_404(Notification, pk=pk, user=request.user)
        notif.is_read = True
        notif.save()
        return JsonResponse({'status': 'ok'})
#---------------------------------------------------------------------------------------------------

class MarkAllNotificationsReadView(LoginRequiredMixin, View):
    def post(self, request):
        Notification.objects.filter(user=request.user, is_read=False).update(is_read=True)
        messages.success(request, 'All notifications marked as read.')
        return redirect('notifications')


# ============================================================================
# ADMIN VIEWS
# ============================================================================

class AdminDashboardView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/dashboard.html'

    def get(self, request):
        context = {
            'total_students': Student.objects.count(),
            'total_teachers': User.objects.filter(profile__role='teacher').count(),
            'total_parents': User.objects.filter(profile__role='parent').count(),
            'total_assignments': Assignment.objects.count(),
            'active_assignments': Assignment.objects.filter(status='active').count(),
            'recent_students': Student.objects.select_related('user').order_by('-id')[:5],
            'recent_assignments': Assignment.objects.order_by('-created_at')[:5],
            'upcoming_holidays': Holiday.objects.filter(date__gte=date.today()).order_by('date')[:5],
            'status_posts': StatusPost.objects.order_by('-is_pinned', '-created_at')[:5],
            'pending_tickets': AssignmentTicket.objects.filter(status='open').count(),
            'pending_brushup': BrushUpRequest.objects.filter(status='pending').count(),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class AdminNotificationListView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/notification_list.html'
    paginate_by = 30

    def get(self, request):
        role_filter = request.GET.get('role', '')

        all_qs = Notification.objects.select_related('user', 'user__profile').order_by('-created_at')
        unread_qs = all_qs.filter(is_read=False)

        if role_filter:
            all_qs = all_qs.filter(user__profile__role=role_filter)
            unread_qs = unread_qs.filter(user__profile__role=role_filter)

        from django.core.paginator import Paginator
        paginator = Paginator(all_qs, self.paginate_by)
        page = request.GET.get('page', 1)
        all_notifications = paginator.get_page(page)

        context = {
            'unread_notifications': unread_qs[:50],
            'all_notifications':    all_notifications,
            'unread_count':         unread_qs.count(),
            'total_count':          Notification.objects.count(),
            'open_tickets':         AssignmentTicket.objects.filter(status='open').count(),
            'pending_brushups':     BrushUpRequest.objects.filter(status='pending').count(),
            'role_filter':          role_filter,
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class AdminMarkNotificationReadView(LoginRequiredMixin, AdminRequiredMixin, View):
    def post(self, request, pk):
        notif = get_object_or_404(Notification, pk=pk)
        notif.is_read = True
        notif.save()
        return redirect('admin_notifications')


class AdminMarkAllNotificationsReadView(LoginRequiredMixin, AdminRequiredMixin, View):
    def post(self, request):
        Notification.objects.filter(is_read=False).update(is_read=True)
        messages.success(request, 'All notifications marked as read.')
        return redirect('admin_notifications')
#---------------------------------------------------------------------------------------------------

class AdminTicketListView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/ticket_list.html'

    def get(self, request):
        status_filter = request.GET.get('status', '')
        tickets = AssignmentTicket.objects.select_related(
            'student__user', 'assignment', 'resolved_by'
        ).order_by('-created_at')

        if status_filter:
            tickets = tickets.filter(status=status_filter)

        context = {
            'tickets':        tickets,
            'status_filter':  status_filter,
            'all_count':      AssignmentTicket.objects.count(),
            'open_count':     AssignmentTicket.objects.filter(status='open').count(),
            'ack_count':      AssignmentTicket.objects.filter(status='acknowledged').count(),
            'verified_count': AssignmentTicket.objects.filter(status='verified').count(),
            'rejected_count': AssignmentTicket.objects.filter(status='rejected').count(),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class AdminBrushUpListView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/brushup_list.html'

    def get(self, request):
        status_filter = request.GET.get('status', '')
        brushups = BrushUpRequest.objects.select_related(
            'student__user', 'topic'
        ).order_by('-created_at')

        if status_filter:
            brushups = brushups.filter(status=status_filter)

        context = {
            'brushups':        brushups,
            'status_filter':   status_filter,
            'all_count':       BrushUpRequest.objects.count(),
            'pending_count':   BrushUpRequest.objects.filter(status='pending').count(),
            'approved_count':  BrushUpRequest.objects.filter(status='approved').count(),
            'scheduled_count': BrushUpRequest.objects.filter(status='scheduled').count(),
            'completed_count': BrushUpRequest.objects.filter(status='completed').count(),
            'rejected_count':  BrushUpRequest.objects.filter(status='rejected').count(),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class StudentDetailView(LoginRequiredMixin, View):
    """
    FIXED: Clicking student on dashboard now leads to this detailed student page.
    Available to admin AND teacher (TeacherOrAdminMixin).
    """
    template_name = 'admin/student_detail.html'

    def get(self, request, pk):
        student = get_object_or_404(Student, pk=pk)
        submissions = Submission.objects.filter(student=student).select_related('assignment')
        test_scores = TestScore.objects.filter(student=student).order_by('-date')

        total_assignments = submissions.count()
        completed = submissions.filter(status='graded').count()
        pending = submissions.filter(status='submitted').count()
        avg_score = submissions.filter(
            status='graded', score__isnull=False
        ).aggregate(Avg('score'))['score__avg'] or 0

        attendance_records = Attendance.objects.filter(student=student)
        total_days = attendance_records.count()
        present_days = attendance_records.filter(status='present').count()
        attendance_rate = (present_days / total_days * 100) if total_days > 0 else 0

        comments = Comment.objects.filter(target_user=student.user).order_by('-created_at')

        roadmap_topics = RoadmapTopic.objects.all()
        completed_topics = roadmap_topics.filter(status='completed').count()
        total_topics = roadmap_topics.count()
        roadmap_progress = (completed_topics / total_topics * 100) if total_topics > 0 else 0

        comment_form = CommentForm()

        context = {
            'student': student,
            'total_assignments': total_assignments,
            'completed_assignments': completed,
            'pending_assignments': pending,
            'average_score': round(avg_score, 2),
            'attendance_rate': round(attendance_rate, 2),
            'recent_scores': test_scores[:5],
            'recent_submissions': submissions.order_by('-submitted_at')[:5],
            'comments': comments,
            'comment_form': comment_form,
            'roadmap_progress': round(roadmap_progress, 2),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class StudentGridView(LoginRequiredMixin, AdminRequiredMixin, View):
    """Complex grid/list reporting system for admin."""
    template_name = 'admin/student_grid.html'

    def get(self, request):
        students = Student.objects.all().select_related('user', 'user__profile')
        grades = sorted(Student.objects.values_list('grade', flat=True).distinct())

        # Filter by grade if requested
        grade_filter = request.GET.get('grade', '')
        section_filter = request.GET.get('section', '')
        search = request.GET.get('search', '')

        if grade_filter:
            students = students.filter(grade=grade_filter)
        if section_filter:
            students = students.filter(section=section_filter)
        if search:
            students = students.filter(
                Q(user__first_name__icontains=search) |
                Q(user__last_name__icontains=search) |
                Q(roll_number__icontains=search)
            )

        students_data = []
        for student in students:
            submissions = Submission.objects.filter(student=student)
            att = Attendance.objects.filter(student=student)
            total_att = att.count()
            present = att.filter(status='present').count()
            avg_score = submissions.filter(
                status='graded', score__isnull=False
            ).aggregate(Avg('score'))['score__avg'] or 0

            students_data.append({
                'student': student,
                'attendance_rate': round((present / total_att * 100), 1) if total_att > 0 else 0,
                'average_score': round(avg_score, 2),
                'total_assignments': submissions.count(),
                'graded': submissions.filter(status='graded').count(),
                'pending': submissions.filter(status='submitted').count(),
            })

        context = {
            'students_data': students_data,
            'grades': grades,
            'grade_filter': grade_filter,
            'section_filter': section_filter,
            'search': search,
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class AdminStudentListView(LoginRequiredMixin, AdminRequiredMixin, ListView):
    model = Student
    template_name = 'admin/student_list.html'
    context_object_name = 'students'
    paginate_by = 20

    def get_queryset(self):
        return Student.objects.select_related('user', 'parent').all()
#---------------------------------------------------------------------------------------------------

class StudentCreateView(LoginRequiredMixin, TeacherOrAdminMixin, View):
    """
    FIXED: Student creation — uses plain Form.save() in atomic transaction.
    No more hanging page.
    """
    template_name = 'admin/student_form.html'

    def get(self, request):
        rolls = Student.objects.values_list('roll_number', flat=True)
        numeric_rolls = []
        for r in rolls:
            r_stripped = r.lstrip('S').lstrip('s')
            if r_stripped.isdigit():
                numeric_rolls.append(int(r_stripped))
        next_num = max(numeric_rolls) + 1 if numeric_rolls else 1
        next_roll = f'S{str(next_num).zfill(3)}'
        form = StudentForm(initial={'roll_number': next_roll})
        return render(request, self.template_name, {'form': form})

    def post(self, request):
        form = StudentForm(request.POST)
        if form.is_valid():
            try:
                student = form.save()
                messages.success(request, f'Student {student.user.get_full_name()} added successfully!')
                return redirect('admin_student_list')
            except Exception as e:
                messages.error(request, f'Error creating student: {str(e)}')
        return render(request, self.template_name, {'form': form})
#---------------------------------------------------------------------------------------------------

class StudentUpdateView(LoginRequiredMixin, TeacherOrAdminMixin, View):
    template_name = 'admin/student_edit.html'

    def get(self, request, pk):
        student = get_object_or_404(Student, pk=pk)
        from core.models import Subject, SubjectsTaken
        all_subjects = Subject.objects.select_related('teacher').order_by('name')
        enrolled_ids = set(
            SubjectsTaken.objects.filter(student=student).values_list('subject_id', flat=True)
        )
        return render(request, self.template_name, {
            'object': student,
            'all_subjects': all_subjects,
            'enrolled_ids': enrolled_ids,
            'SECTION_CHOICES': [('A','A'),('B','B'),('C','C'),('D','D')],
            'BLOOD_GROUP_CHOICES': [
                ('','—'),('A+','A+'),('A-','A-'),('B+','B+'),('B-','B-'),
                ('AB+','AB+'),('AB-','AB-'),('O+','O+'),('O-','O-'),
            ],
            'parents': User.objects.filter(profile__role='parent').order_by('first_name'),
        })

    def post(self, request, pk):
        student = get_object_or_404(Student, pk=pk)
        from core.models import Subject, SubjectsTaken

        # Update basic fields
        student.grade    = request.POST.get('grade', student.grade)
        student.section  = request.POST.get('section', student.section)
        student.phone_number = request.POST.get('phone_number', student.phone_number)
        student.address  = request.POST.get('address', student.address)
        student.blood_group = request.POST.get('blood_group', student.blood_group)
        student.medical_conditions = request.POST.get('medical_conditions', student.medical_conditions)
        student.is_active = request.POST.get('is_active') == 'on'

        parent_id = request.POST.get('parent')
        if parent_id:
            try:
                student.parent = User.objects.get(pk=parent_id)
            except User.DoesNotExist:
                pass
        else:
            student.parent = None

        student.save()

        # Update subject enrolments
        selected_subject_ids = set(
            int(x) for x in request.POST.getlist('subjects') if x.isdigit()
        )
        current_subject_ids = set(
            SubjectsTaken.objects.filter(student=student).values_list('subject_id', flat=True)
        )

        # Add new enrolments
        to_add = selected_subject_ids - current_subject_ids
        SubjectsTaken.objects.bulk_create([
            SubjectsTaken(student=student, subject_id=sid) for sid in to_add
        ], ignore_conflicts=True)

        # Remove removed enrolments
        to_remove = current_subject_ids - selected_subject_ids
        SubjectsTaken.objects.filter(student=student, subject_id__in=to_remove).delete()

        messages.success(request, f'Student {student.user.get_full_name()} updated successfully!')
        return redirect('admin_student_list')
    
#---------------------------------------------------------------------------------------------------

class StudentDeleteView(LoginRequiredMixin, AdminRequiredMixin, DeleteView):
    model = Student
    template_name = 'admin/student_confirm_delete.html'
    success_url = reverse_lazy('admin_student_list')

    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Student deleted.')
        return super().delete(request, *args, **kwargs)
#---------------------------------------------------------------------------------------------------

class AdminAssignmentListView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/assignment_list.html'

    def get(self, request):
        from django.core.paginator import Paginator
        status_filter = request.GET.get('status', 'active')  # default to active

        assignments = Assignment.objects.select_related(
            'created_by'
        ).prefetch_related('submissions').order_by('-created_at')

        if status_filter:
            assignments = assignments.filter(status=status_filter)

        paginator = Paginator(assignments, 20)
        page = request.GET.get('page', 1)
        assignments = paginator.get_page(page)

        context = {
            'assignments':   assignments,
            'status_filter': status_filter,
            'all_count':     Assignment.objects.count(),
            'active_count':  Assignment.objects.filter(status='active').count(),
            'draft_count':   Assignment.objects.filter(status='draft').count(),
            'closed_count':  Assignment.objects.filter(status='closed').count(),
        }
        return render(request, self.template_name, context)

class AdminTeacherAttendanceView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/teacher_attendance.html'

    def get(self, request):
        from datetime import date as dt
        teachers = UserProfile.objects.filter(role='teacher').select_related('user')
        teacher_filter = request.GET.get('teacher_filter', '')
        month_filter   = request.GET.get('month_filter', dt.today().strftime('%Y-%m'))

        records = TeacherAttendance.objects.select_related(
            'teacher__user', 'marked_by'
        ).order_by('-date')

        if teacher_filter:
            records = records.filter(teacher__pk=teacher_filter)

        if month_filter:
            year, month = month_filter.split('-')
            records = records.filter(date__year=year, date__month=month)

        # Attendance rate per teacher (all time)
        teacher_stats = []
        for tp in teachers:
            all_rec  = TeacherAttendance.objects.filter(teacher=tp)
            total    = all_rec.count()
            present  = all_rec.filter(status__in=['present', 'late', 'half_day']).count()
            rate     = round(present / total * 100, 1) if total else 0
            teacher_stats.append({'name': tp.user.get_full_name(), 'present': present,
                                   'total': total, 'rate': rate})

        return render(request, self.template_name, {
            'teachers':       teachers,
            'records':        records,
            'teacher_stats':  teacher_stats,
            'teacher_filter': teacher_filter,
            'month_filter':   month_filter,
            'today':          dt.today().strftime('%Y-%m-%d'),
        })

    def post(self, request):
        from datetime import date as dt
        action = request.POST.get('action')
        date_str = request.POST.get('date', dt.today().strftime('%Y-%m-%d'))

        if action == 'single':
            teacher_id = request.POST.get('teacher_id')
            status     = request.POST.get('status')
            notes      = request.POST.get('notes', '')
            try:
                teacher = UserProfile.objects.get(pk=teacher_id, role='teacher')
                TeacherAttendance.objects.update_or_create(
                    teacher=teacher,
                    date=date_str,
                    defaults={'status': status, 'notes': notes, 'marked_by': request.user}
                )
                messages.success(request, f'Attendance marked for {teacher.user.get_full_name()}.')
            except UserProfile.DoesNotExist:
                messages.error(request, 'Teacher not found.')

        elif action == 'bulk':
            teachers = UserProfile.objects.filter(role='teacher')
            count = 0
            for teacher in teachers:
                status = request.POST.get(f'status_{teacher.pk}')
                if status:
                    TeacherAttendance.objects.update_or_create(
                        teacher=teacher,
                        date=date_str,
                        defaults={'status': status, 'notes': '', 'marked_by': request.user}
                    )
                    count += 1
            messages.success(request, f'Bulk attendance marked for {count} teachers.')

        return redirect('admin_teacher_attendance')


class AdminFinanceView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/finance.html'

    def get(self, request):
        from datetime import date as dt
        from django.db.models import Sum
        selected_month = request.GET.get('month', dt.today().strftime('%Y-%m'))
        year, month    = selected_month.split('-')
        month_str      = f"{month}/{year}"  # MM/YYYY format used in FeesStatus

        # Fee income for selected month
        fee_records  = FeesStatus.objects.filter(month=month_str).select_related('student__user')
        paid_fees    = fee_records.filter(status='paid')
        pending_fees = fee_records.filter(status__in=['unpaid', 'overdue'])
        total_income  = paid_fees.aggregate(t=Sum('fees'))['t'] or 0
        total_pending = pending_fees.aggregate(t=Sum('fees'))['t'] or 0

        # Salary expenses (all teachers + admin)
        salary_records = []
        total_salary   = 0
        for tp in TeacherProfile.objects.select_related('profile__user'):
            salary_records.append({
                'name':   tp.profile.user.get_full_name(),
                'role':   'Teacher',
                'salary': tp.salary,
            })
            total_salary += float(tp.salary)

        # Petty expenses for selected month
        petty_expenses = PettyExpense.objects.filter(
            date__year=year, date__month=month
        )
        total_petty = petty_expenses.aggregate(t=Sum('amount'))['t'] or 0

        total_expenses = total_salary + float(total_petty)
        net_balance    = float(total_income) - total_expenses

        return render(request, self.template_name, {
            'selected_month':    selected_month,
            'fee_records':       fee_records,
            'paid_fees_count':   paid_fees.count(),
            'pending_fees_count':pending_fees.count(),
            'total_income':      total_income,
            'total_pending':     total_pending,
            'salary_records':    salary_records,
            'total_salary':      total_salary,
            'petty_expenses':    petty_expenses,
            'total_petty':       total_petty,
            'total_expenses':    total_expenses,
            'net_balance':       net_balance,
            'today':             dt.today().strftime('%Y-%m-%d'),
        })

    def post(self, request):
        action = request.POST.get('action')
        if action == 'add_expense':
            PettyExpense.objects.create(
                description  = request.POST.get('description'),
                amount       = request.POST.get('amount'),
                date         = request.POST.get('expense_date'),
                added_by     = request.user,
            )
            messages.success(request, 'Petty expense added.')
        elif action == 'delete_expense':
            PettyExpense.objects.filter(pk=request.POST.get('expense_id')).delete()
            messages.success(request, 'Expense deleted.')
        return redirect('admin_finance')


class AdminTeacherPerformanceView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/teacher_performance.html'

    def get(self, request):
        from django.db.models import Avg
        teachers = User.objects.filter(profile__role='teacher').select_related('profile')
        teacher_data = []

        for teacher in teachers:
            assignments   = Assignment.objects.filter(created_by=teacher)
            all_subs      = Submission.objects.filter(assignment__in=assignments)
            graded_subs   = all_subs.filter(status='graded', score__isnull=False)
            pending_subs  = all_subs.filter(status='submitted')
            topics        = RoadmapTopic.objects.filter(created_by=teacher)
            completed     = topics.filter(status='completed')
            tests_sched   = topics.filter(test_scheduled__isnull=False).count()
            avg_score_val = graded_subs.aggregate(a=Avg('score'))['a'] or 0
            roadmap_pct   = round(completed.count() / topics.count() * 100, 1) if topics.count() else 0
            grading_rate  = round(graded_subs.count() / all_subs.count() * 100, 1) if all_subs.count() else 0

            # Average grading time (submitted_at → updated_at for graded)
            avg_grading_days = 0
            graded_with_dates = graded_subs.exclude(submitted_at=None)
            if graded_with_dates.exists():
                total_days = sum(
                    (s.updated_at.date() - s.submitted_at.date()).days
                    for s in graded_with_dates
                    if s.updated_at and s.submitted_at
                )
                avg_grading_days = round(total_days / graded_with_dates.count(), 1)

            # Student progress cards
            student_scores = []
            seen = set()
            for sub in graded_subs.select_related('student__user').order_by('-score'):
                sid = sub.student.pk
                if sid not in seen:
                    seen.add(sid)
                    pct = round(float(sub.score) / float(sub.assignment.max_score) * 100, 1) \
                          if sub.assignment.max_score else 0
                    student_scores.append({'name': sub.student.user.get_full_name(), 'score': pct})

            # Subjects
            subjects = list(
                Subject.objects.filter(teacher=teacher.profile).values_list('name', flat=True)
            )

            # Qualification
            qualification = ''
            try:
                qualification = teacher.profile.teacher_profile.get_qualification_display()
            except Exception:
                pass

            # Overall performance score (weighted)
            overall = round(
                (grading_rate * 0.3) + (roadmap_pct * 0.3) + (float(avg_score_val) * 0.4), 1
            )

            teacher_data.append({
                'teacher':          teacher,
                'subjects':         subjects,
                'qualification':    qualification,
                'total_assignments':assignments.count(),
                'graded_count':     graded_subs.count(),
                'pending_count':    pending_subs.count(),
                'avg_grading_days': avg_grading_days,
                'total_topics':     topics.count(),
                'completed_topics': completed.count(),
                'tests_scheduled':  tests_sched,
                'avg_student_score':round(float(avg_score_val), 1),
                'grading_rate':     grading_rate,
                'roadmap_pct':      roadmap_pct,
                'students':         student_scores,
                'overall_score':    overall,
            })

        # Sort by overall score descending
        teacher_data.sort(key=lambda x: x['overall_score'], reverse=True)

        return render(request, self.template_name, {'teacher_data': teacher_data})

    
#===================================================================================================
# --- Parent Management ---
#===================================================================================================

class ParentCreateView(LoginRequiredMixin, AdminRequiredMixin, View):
    """FIXED: Parent creation — atomic, no hanging."""
    template_name = 'admin/parent_form.html'

    def get(self, request):
        return render(request, self.template_name, {'form': ParentForm()})

    def post(self, request):
        form = ParentForm(request.POST)
        if form.is_valid():
            try:
                user = form.save()
                messages.success(request, f'Parent {user.get_full_name()} added successfully!')
                return redirect('parent_list')
            except Exception as e:
                messages.error(request, f'Error: {str(e)}')
        return render(request, self.template_name, {'form': form})
#---------------------------------------------------------------------------------------------------

class ParentListView(LoginRequiredMixin, AdminRequiredMixin, ListView):
    model = User
    template_name = 'admin/parent_list.html'
    context_object_name = 'parents'
    paginate_by = 20

    def get_queryset(self):
        return User.objects.filter(profile__role='parent').select_related('profile')
#---------------------------------------------------------------------------------------------------

class ParentUpdateView(LoginRequiredMixin, AdminRequiredMixin, UpdateView):
    model = User
    fields = ['first_name', 'last_name', 'email']
    template_name = 'admin/parent_edit.html'
    success_url = reverse_lazy('parent_list')

    def form_valid(self, form):
        messages.success(self.request, 'Parent updated!')
        return super().form_valid(form)
#---------------------------------------------------------------------------------------------------

class ParentDeleteView(LoginRequiredMixin, AdminRequiredMixin, DeleteView):
    model = User
    template_name = 'admin/parent_confirm_delete.html'
    success_url = reverse_lazy('parent_list')

    def get_queryset(self):
        return User.objects.filter(profile__role='parent')

    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Parent deleted.')
        return super().delete(request, *args, **kwargs)

#=======================================
# --- Teacher Management ---
#=======================================

class TeacherListView(LoginRequiredMixin, AdminRequiredMixin, ListView):
    model = User
    template_name = 'admin/teacher_list.html'
    context_object_name = 'teachers'
    paginate_by = 20

    def get_queryset(self):
        return User.objects.filter(profile__role='teacher').select_related('profile')
#---------------------------------------------------------------------------------------------------

class TeacherCreateView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/teacher_form.html'

    def get(self, request):
        return render(request, self.template_name, {'form': TeacherForm()})

    def post(self, request):
        form = TeacherForm(request.POST)
        if form.is_valid():
            try:
                user = form.save()
                messages.success(request, f'Teacher {user.get_full_name()} added!')
                return redirect('teacher_list')
            except Exception as e:
                messages.error(request, f'Error: {str(e)}')
        return render(request, self.template_name, {'form': form})

#---------------------------------------------------------------------------------------------------
class TeacherUpdateView(LoginRequiredMixin, AdminRequiredMixin, UpdateView):
    model = User
    fields = ['first_name', 'last_name', 'email']
    template_name = 'admin/teacher_edit.html'
    success_url = reverse_lazy('teacher_list')

    def get_queryset(self):
        return User.objects.filter(profile__role='teacher')

    def form_valid(self, form):
        messages.success(self.request, 'Teacher updated!')
        return super().form_valid(form)
#---------------------------------------------------------------------------------------------------

class TeacherDeleteView(LoginRequiredMixin, AdminRequiredMixin, DeleteView):
    model = User
    template_name = 'admin/teacher_confirm_delete.html'
    success_url = reverse_lazy('teacher_list')

    def get_queryset(self):
        return User.objects.filter(profile__role='teacher')

    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Teacher deleted.')
        return super().delete(request, *args, **kwargs)
#---------------------------------------------------------------------------------------------------

# --- Status / Holiday / Analytics ---

class StatusPostCreateView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/status_post_form.html'

    def get(self, request):
        return render(request, self.template_name, {'form': StatusPostForm()})

    def post(self, request):
        form = StatusPostForm(request.POST)
        if form.is_valid():
            post = form.save(commit=False)
            post.author = request.user
            post.save()
            messages.success(request, 'Status posted!')
        else:
            messages.error(request, 'Error posting status.')
        return redirect('admin_dashboard')
#---------------------------------------------------------------------------------------------------

class StatusPostListView(LoginRequiredMixin, AdminRequiredMixin, ListView):
    model = StatusPost
    template_name = 'admin/status_list.html'
    context_object_name = 'status_posts'
    paginate_by = 20
#---------------------------------------------------------------------------------------------------

class StatusPostDeleteView(LoginRequiredMixin, AdminRequiredMixin, View):
    def post(self, request, pk):
        post = get_object_or_404(StatusPost, pk=pk)
        post.delete()
        messages.success(request, 'Post deleted.')
        return redirect('status_list')
#---------------------------------------------------------------------------------------------------

class HolidayBroadcastView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/holiday_form.html'

    def get(self, request):
        return render(request, self.template_name, {'form': HolidayForm()})

    def post(self, request):
        form = HolidayForm(request.POST)
        if form.is_valid():
            holiday = form.save(commit=False)
            holiday.created_by = request.user
            holiday.save()
            # Create notifications for ALL users
            all_users = User.objects.filter(is_active=True)
            notifications = [
                Notification(
                    user=u,
                    notification_type='holiday',
                    title=f'Holiday: {holiday.title}',
                    message=f'{holiday.title} on {holiday.date}. {holiday.description}',
                )
                for u in all_users
            ]
            Notification.objects.bulk_create(notifications)
            messages.success(request, f'Holiday "{holiday.title}" broadcast to all users!')
            return redirect('holiday_list')
        return render(request, self.template_name, {'form': form})
#---------------------------------------------------------------------------------------------------

class HolidayListView(LoginRequiredMixin, ListView):
    model = Holiday
    template_name = 'admin/holiday_list.html'
    context_object_name = 'holidays'

    def get_queryset(self):
        return Holiday.objects.all().order_by('date')
#---------------------------------------------------------------------------------------------------

class HolidayDeleteView(LoginRequiredMixin, AdminRequiredMixin, View):
    def post(self, request, pk):
        holiday = get_object_or_404(Holiday, pk=pk)
        holiday.delete()
        messages.success(request, 'Holiday deleted.')
        return redirect('holiday_list')
#---------------------------------------------------------------------------------------------------

class AllTeachersRoadmapView(LoginRequiredMixin, View):
    """
    All roles can view all teachers' roadmaps.
    Admin can edit; others view only.
    """
    template_name = 'admin/all_roadmaps.html'

    def get(self, request):
        teachers = User.objects.filter(profile__role='teacher').select_related('profile')
        roadmaps_data = []
        for teacher in teachers:
            topics = RoadmapTopic.objects.filter(created_by=teacher)
            root_topics = topics.filter(parent_topic__isnull=True).order_by('order')
            roadmaps_data.append({
                'teacher': teacher,
                'total_topics': topics.count(),
                'completed_topics': topics.filter(status='completed').count(),
                'in_progress_topics': topics.filter(status='in_progress').count(),
                'upcoming_topics': topics.filter(status='upcoming').count(),
                'root_topics': root_topics[:5],
            })
        return render(request, self.template_name, {'roadmaps_data': roadmaps_data})
#---------------------------------------------------------------------------------------------------

class AdminAnalyticsView(LoginRequiredMixin, AdminRequiredMixin, View):
    template_name = 'admin/analytics.html'

    def get(self, request):
        students = Student.objects.all()
        submissions = Submission.objects.filter(status='graded', score__isnull=False)
        avg_score = submissions.aggregate(Avg('score'))['score__avg'] or 0

        # ── Grade-wise breakdown ─────────────────────────────────────────
        grade_stats = []
        for grade in sorted(Student.objects.values_list('grade', flat=True).distinct()):
            grade_students = students.filter(grade=grade)
            grade_submissions = Submission.objects.filter(
                student__in=grade_students, status='graded', score__isnull=False
            )
            grade_stats.append({
                'grade': grade,
                'student_count': grade_students.count(),
                'avg_score': round(
                    grade_submissions.aggregate(Avg('score'))['score__avg'] or 0, 1
                ),
            })

        # ── Per-student stats (for student performance list) ─────────────
        student_stats = []
        for student in students.select_related('user', 'user__profile'):
            subs = Submission.objects.filter(student=student)
            att  = Attendance.objects.filter(student=student)
            total_att = att.count()
            present   = att.filter(status='present').count()
            graded    = subs.filter(status='graded', score__isnull=False)
            avg       = graded.aggregate(Avg('score'))['score__avg'] or 0

            # pending fees from parent profile
            pending_fees = 0
            if student.parent:
                try:
                    pending_fees = student.parent.profile.pending_amount or 0
                except Exception:
                    pending_fees = 0

            student_stats.append({
                'student':       student,
                'avg_score':     round(avg, 1),
                'attendance_rate': round(present / total_att * 100, 1) if total_att else 0,
                'total':         subs.count(),
                'graded':        graded.count(),
                'pending_fees':  pending_fees,
            })

        # Sort by avg_score descending
        student_stats.sort(key=lambda x: x['avg_score'], reverse=True)

        # ── Per-teacher stats ────────────────────────────────────────────
        teachers = User.objects.filter(profile__role='teacher').select_related('profile')
        teacher_stats = []
        teacher_stats_json = []

        for teacher in teachers:
            t_assignments = Assignment.objects.filter(created_by=teacher)
            t_submissions = Submission.objects.filter(assignment__in=t_assignments)
            graded_subs   = t_submissions.filter(status='graded', score__isnull=False)
            pending_subs  = t_submissions.filter(status='submitted')
            t_avg         = graded_subs.aggregate(Avg('score'))['score__avg'] or 0

            # Roadmap progress
            roadmap_topics    = RoadmapTopic.objects.filter(created_by=teacher)
            total_topics      = roadmap_topics.count()
            completed_topics  = roadmap_topics.filter(status='completed').count()
            roadmap_pct       = round(completed_topics / total_topics * 100, 1) if total_topics else 0

            # Individual student scores under this teacher
            student_scores = []
            for sub in graded_subs.select_related('student__user')[:8]:
                student_scores.append({
                    'name':  sub.student.user.get_full_name(),
                    'score': round(sub.score, 1),
                })

            teacher_stats.append({
                'teacher':            teacher,
                'total_assignments':  t_assignments.count(),
                'graded_submissions': graded_subs.count(),
                'pending_submissions':pending_subs.count(),
                'avg_student_score':  round(t_avg, 1),
                'roadmap_progress':   roadmap_pct,
                'student_scores':     student_scores,
            })

            teacher_stats_json.append({
                'name':             teacher.get_full_name(),
                'avg_student_score':round(t_avg, 1),
                'graded':           graded_subs.count(),
                'pending':          pending_subs.count(),
            })

        # ── Monthly trend ────────────────────────────────────────────────
        monthly_data = list(
            Submission.objects.filter(status='graded')
            .annotate(month=TruncMonth('submitted_at'))
            .values('month')
            .annotate(count=Count('id'), avg=Avg('score'))
            .order_by('month')
        )

        context = {
            'total_students':    students.count(),
            'average_score':     round(avg_score, 1),
            'grade_stats':       grade_stats,
            'grade_stats_json':  json.dumps(grade_stats, default=lambda o: float(o) if hasattr(o, '__float__') else str(o)),
            'student_stats':     student_stats,
            'teacher_stats':     teacher_stats,
            'teacher_stats_json':json.dumps(teacher_stats_json, default=lambda o: float(o) if hasattr(o, '__float__') else str(o)),
            'monthly_data':      json.dumps(monthly_data, default=str),
            'open_tickets':      AssignmentTicket.objects.filter(status='open').count(),
            'pending_brushup':   BrushUpRequest.objects.filter(status='pending').count(),
        }
        return render(request, self.template_name, context)
    
# ============================================================================
# TEACHER VIEWS
# ============================================================================

class TeacherDashboardView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/dashboard.html'

    def get(self, request):
        teacher_assignments = Assignment.objects.filter(created_by=request.user)
        recent_submissions = Submission.objects.filter(
            assignment__created_by=request.user,
            status='submitted'
        ).select_related('student__user', 'assignment').order_by('-submitted_at')[:10]

        # Roadmap topics with tree for badge display
        roadmap_topics = RoadmapTopic.objects.filter(
            created_by=request.user, parent_topic__isnull=True
        ).prefetch_related('subtopics').order_by('order')

        context = {
            'total_students': Student.objects.count(),
            'total_assignments': teacher_assignments.count(),
            'active_assignments': teacher_assignments.filter(status='active').count(),
            'pending_reviews': Submission.objects.filter(
                assignment__created_by=request.user,
                status='submitted',
                score__isnull=True
            ).count(),
            'recent_submissions': recent_submissions,
            'upcoming_deadlines': teacher_assignments.filter(
                status='active', due_date__gte=date.today()
            ).order_by('due_date')[:5],
            'roadmap_topics': roadmap_topics,
            'roadmap_count': RoadmapTopic.objects.filter(created_by=request.user).count(),
            'open_tickets': AssignmentTicket.objects.filter(
                assignment__created_by=request.user, status='open'
            ).count(),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

class StudentListView(LoginRequiredMixin, TeacherRequiredMixin, ListView):
    """Teacher list of all students — clicking goes to student detail."""
    model = Student
    template_name = 'teacher/student_list.html'
    context_object_name = 'students'
    paginate_by = 20

    def get_queryset(self):
        qs = Student.objects.all().select_related('user', 'parent')
        search = self.request.GET.get('search', '')
        grade = self.request.GET.get('grade', '')
        if search:
            qs = qs.filter(
                Q(user__first_name__icontains=search) |
                Q(user__last_name__icontains=search) |
                Q(roll_number__icontains=search)
            )
        if grade:
            qs = qs.filter(grade=grade)
        return qs

    def get_context_data(self, **kwargs):
        ctx = super().get_context_data(**kwargs)
        ctx['grades'] = sorted(Student.objects.values_list('grade', flat=True).distinct())
        return ctx
#---------------------------------------------------------------------------------------------------

class TeacherStudentDetailView(LoginRequiredMixin, TeacherRequiredMixin, View):
    """FIXED: Teacher clicks student → goes to this detail page."""
    template_name = 'teacher/student_detail.html'

    def get(self, request, pk):
        student = get_object_or_404(Student, pk=pk)
        submissions = Submission.objects.filter(student=student).select_related('assignment')
        attendance = Attendance.objects.filter(student=student).order_by('-date')
        test_scores = TestScore.objects.filter(student=student).order_by('-date')
        comments = Comment.objects.filter(target_user=student.user)
        comment_form = CommentForm()

        total = attendance.count()
        present = attendance.filter(status='present').count()
        att_rate = round((present / total * 100), 1) if total > 0 else 0

        context = {
            'student': student,
            'submissions': submissions.order_by('-submitted_at')[:10],
            'attendance': attendance[:10],
            'attendance_rate': att_rate,
            'test_scores': test_scores[:10],
            'comments': comments,
            'comment_form': comment_form,
            'avg_score': round(
                submissions.filter(status='graded', score__isnull=False).aggregate(Avg('score'))['score__avg'] or 0, 2
            ),
        }
        return render(request, self.template_name, context)
#---------------------------------------------------------------------------------------------------

# --- Assignment Management ---

class AssignmentListView(LoginRequiredMixin, TeacherRequiredMixin, ListView):
    model = Assignment
    template_name = 'teacher/assignment_list.html'
    context_object_name = 'assignments'
    paginate_by = 20

    def get_queryset(self):
        return Assignment.objects.filter(created_by=self.request.user).order_by('-created_at')


class AssignmentDetailView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/assignment_detail.html'

    def get(self, request, pk):
        assignment = get_object_or_404(Assignment, pk=pk, created_by=request.user)
        submissions = Submission.objects.filter(assignment=assignment).select_related('student__user')
        stats = assignment.get_submission_stats()
        return render(request, self.template_name, {
            'assignment': assignment,
            'submissions': submissions,
            'stats': stats,
        })


class AssignmentCreateView(LoginRequiredMixin, TeacherRequiredMixin, View):
    """
    FIXED: Assignment creation — plain View to avoid ModelForm CSRF + file upload issues.
    Surfaces form errors clearly instead of silently swallowing them.
    """
    template_name = 'teacher/assignment_form.html'

    def get(self, request):
        return render(request, self.template_name, {'form': AssignmentForm(), 'action': 'Create'})

    def post(self, request):
        form = AssignmentForm(request.POST, request.FILES)
        if form.is_valid():
            assignment = form.save(commit=False)
            assignment.created_by = request.user
            assignment.save()
            # Auto-create submission records for all students
            students = Student.objects.all()
            Submission.objects.bulk_create([
                Submission(assignment=assignment, student=s, status='not_submitted')
                for s in students
                if not Submission.objects.filter(assignment=assignment, student=s).exists()
            ])
            messages.success(request, f'Assignment "{assignment.title}" created!')
            return redirect('assignment_list')
        return render(request, self.template_name, {'form': form, 'action': 'Create'})


class AssignmentUpdateView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/assignment_form.html'

    def get(self, request, pk):
        assignment = get_object_or_404(Assignment, pk=pk, created_by=request.user)
        form = AssignmentForm(instance=assignment)
        return render(request, self.template_name, {'form': form, 'action': 'Update', 'assignment': assignment})

    def post(self, request, pk):
        assignment = get_object_or_404(Assignment, pk=pk, created_by=request.user)
        form = AssignmentForm(request.POST, request.FILES, instance=assignment)
        if form.is_valid():
            form.save()
            messages.success(request, 'Assignment updated!')
            return redirect('assignment_list')
        return render(request, self.template_name, {'form': form, 'action': 'Update', 'assignment': assignment})


class AssignmentDeleteView(LoginRequiredMixin, TeacherRequiredMixin, DeleteView):
    model = Assignment
    template_name = 'teacher/assignment_confirm_delete.html'
    success_url = reverse_lazy('assignment_list')

    def get_queryset(self):
        return Assignment.objects.filter(created_by=self.request.user)

    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Assignment deleted.')
        return super().delete(request, *args, **kwargs)

#---------------------------------------------------------------------------------------------------
    
# --- Submission Management ---

class SubmissionListView(LoginRequiredMixin, TeacherRequiredMixin, ListView):
    """Shows submission STATUS for each student — teacher dashboard."""
    model = Submission
    template_name = 'teacher/submission_list.html'
    context_object_name = 'submissions'
    paginate_by = 20

    def get_queryset(self):
        return Submission.objects.filter(
            assignment_id=self.kwargs['assignment_id']
        ).select_related('student', 'student__user').order_by('status', 'student__roll_number')

    def get_context_data(self, **kwargs):
        ctx = super().get_context_data(**kwargs)
        ctx['assignment'] = get_object_or_404(Assignment, pk=self.kwargs['assignment_id'])
        return ctx


class SubmissionDetailView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/submission_detail.html'

    def get(self, request, pk):
        submission = get_object_or_404(Submission, pk=pk)
        form = GradeSubmissionForm(initial={
            'score': submission.score,
            'feedback': submission.feedback,
            'status': submission.status if submission.status in ('graded', 'resubmit') else 'graded',
        })
        return render(request, self.template_name, {'submission': submission, 'form': form})


class SubmissionGradeView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/grade_submission.html'

    def get(self, request, pk):
        submission = get_object_or_404(Submission, pk=pk)
        form = GradeSubmissionForm()
        return render(request, self.template_name, {'submission': submission, 'form': form})

    def post(self, request, pk):
        submission = get_object_or_404(Submission, pk=pk)
        form = GradeSubmissionForm(request.POST)
        if form.is_valid():
            score = form.cleaned_data['score']
            if score > submission.assignment.max_score:
                messages.error(request, f'Score cannot exceed {submission.assignment.max_score}')
                return render(request, self.template_name, {'submission': submission, 'form': form})
            submission.score = score
            submission.feedback = form.cleaned_data['feedback']
            submission.status = form.cleaned_data['status']
            submission.graded_at = timezone.now()
            submission.graded_by = request.user
            submission.save()
            messages.success(request, 'Submission graded!')
            return redirect('submission_list', assignment_id=submission.assignment.id)
        return render(request, self.template_name, {'submission': submission, 'form': form})

#---------------------------------------------------------------------------------------------------
# Alias for URL compatibility
GradeSubmissionView = SubmissionGradeView
#---------------------------------------------------------------------------------------------------

# --- Roadmap Management ---

class RoadmapTopicListView(LoginRequiredMixin, TeacherRequiredMixin, View):
    """
    UPDATED: Topics displayed in hierarchy tree with badges.
    """
    template_name = 'teacher/roadmap_list.html'

    def get(self, request):
        # Only root topics, subtopics loaded via tree
        root_topics = RoadmapTopic.objects.filter(
            created_by=request.user, parent_topic__isnull=True
        ).prefetch_related('subtopics__subtopics').order_by('order')

        total = RoadmapTopic.objects.filter(created_by=request.user).count()
        completed = RoadmapTopic.objects.filter(created_by=request.user, status='completed').count()

        return render(request, self.template_name, {
            'root_topics': root_topics,
            'total': total,
            'completed': completed,
        })
#---------------------------------------------------------------------------------------------------

class RoadmapTopicCreateView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/roadmap_form.html'

    def get(self, request):
        form = RoadmapTopicForm(user=request.user)
        return render(request, self.template_name, {'form': form, 'action': 'Create'})

    def post(self, request):
        form = RoadmapTopicForm(request.POST, user=request.user)
        if form.is_valid():
            topic = form.save(commit=False)
            topic.created_by = request.user
            topic.save()
            messages.success(request, f'Topic "{topic.title}" created!')
            return redirect('roadmap_list')
        return render(request, self.template_name, {'form': form, 'action': 'Create'})
#---------------------------------------------------------------------------------------------------

class RoadmapTopicUpdateView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/roadmap_form.html'

    def get(self, request, pk):
        topic = get_object_or_404(RoadmapTopic, pk=pk, created_by=request.user)
        form = RoadmapTopicForm(instance=topic, user=request.user)
        return render(request, self.template_name, {'form': form, 'action': 'Update', 'topic': topic})

    def post(self, request, pk):
        topic = get_object_or_404(RoadmapTopic, pk=pk, created_by=request.user)
        form = RoadmapTopicForm(request.POST, instance=topic, user=request.user)
        if form.is_valid():
            form.save()
            messages.success(request, 'Topic updated!')
            return redirect('roadmap_list')
        return render(request, self.template_name, {'form': form, 'action': 'Update', 'topic': topic})
#---------------------------------------------------------------------------------------------------

class RoadmapTopicDeleteView(LoginRequiredMixin, TeacherRequiredMixin, DeleteView):
    model = RoadmapTopic
    template_name = 'teacher/roadmap_confirm_delete.html'
    success_url = reverse_lazy('roadmap_list')

    def get_queryset(self):
        return RoadmapTopic.objects.filter(created_by=self.request.user)

    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Topic deleted.')
        return super().delete(request, *args, **kwargs)
#---------------------------------------------------------------------------------------------------

class RoadmapTreeView(LoginRequiredMixin, View):
    """Tree view of teacher's roadmap with badges."""
    template_name = 'teacher/roadmap_tree.html'

    def get(self, request):
        # Show own roadmap for teachers, pick teacher_id for admin
        teacher_id = request.GET.get('teacher_id')
        if teacher_id and (request.user.is_superuser or
                           (hasattr(request.user, 'profile') and request.user.profile.role == 'admin')):
            owner = get_object_or_404(User, pk=teacher_id)
        else:
            owner = request.user

        topics = RoadmapTopic.objects.filter(created_by=owner).order_by('order')
        tree_data = _build_topic_tree(topics)

        return render(request, self.template_name, {
            'tree_data': json.dumps(tree_data),
            'total_topics': topics.count(),
            'completed': topics.filter(status='completed').count(),
            'owner': owner,
        })
#---------------------------------------------------------------------------------------------------

class RoadmapCSVUploadView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/roadmap_csv_upload.html'

    def get(self, request):
        return render(request, self.template_name)

    def post(self, request):
        csv_file = request.FILES.get('csv_file')
        if not csv_file or not csv_file.name.endswith('.csv'):
            messages.error(request, 'Please upload a valid CSV file.')
            return redirect('roadmap_list')

        try:
            decoded = csv_file.read().decode('utf-8').splitlines()
            reader = csv.DictReader(decoded)
            created = 0
            errors = []

            for i, row in enumerate(reader, start=2):
                try:
                    parent_id = row.get('parent_id', '').strip()
                    parent_topic = None
                    if parent_id:
                        try:
                            parent_topic = RoadmapTopic.objects.get(id=int(parent_id))
                        except (RoadmapTopic.DoesNotExist, ValueError):
                            errors.append(f'Row {i}: Parent topic {parent_id} not found')
                            continue

                    RoadmapTopic.objects.create(
                        title=row['title'].strip(),
                        description=row.get('description', '').strip(),
                        order=int(row.get('order', 0) or 0),
                        status=row.get('status', 'upcoming').strip(),
                        parent_topic=parent_topic,
                        created_by=request.user,
                        subject=row.get('subject', '').strip(),
                        grade=row.get('grade', '').strip(),
                    )
                    created += 1
                except Exception as e:
                    errors.append(f'Row {i}: {str(e)}')

            if created:
                messages.success(request, f'{created} topics imported!')
            for err in errors[:5]:
                messages.warning(request, err)
            if len(errors) > 5:
                messages.warning(request, f'...and {len(errors) - 5} more errors.')

        except Exception as e:
            messages.error(request, f'CSV error: {str(e)}')

        return redirect('roadmap_list')
    
#---------------------------------------------------------------------------------------------------

def download_roadmap_template(request):
    """Download CSV template for roadmap upload."""
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = 'attachment; filename="roadmap_template.csv"'
    writer = csv.writer(response)
    writer.writerow(['title', 'description', 'order', 'status', 'parent_id', 'subject', 'grade'])
    writer.writerow(['Introduction to Python', 'Basic syntax', '1', 'completed', '', 'CS', '10'])
    writer.writerow(['Variables', 'Data types', '2', 'in_progress', '1', 'CS', '10'])
    writer.writerow(['Control Flow', 'Loops and conditionals', '3', 'upcoming', '1', 'CS', '10'])
    return response
#---------------------------------------------------------------------------------------------------

# --- Attendance ---


class AttendanceMarkView(LoginRequiredMixin, TeacherRequiredMixin, View):
    """Teacher marks student attendance from dashboard with date selector."""
    template_name = 'teacher/attendance_form.html'

    def get(self, request):
        selected_date = request.GET.get('date', str(date.today()))
        try:
            att_date = datetime.strptime(selected_date, '%Y-%m-%d').date()
        except ValueError:
            att_date = date.today()

        students = Student.objects.filter(is_active=True).select_related('user').order_by('grade', 'section', 'roll_number')

        # Build a map of grade → list of unique subjects (from assignments)
        from .models import Assignment
        grade_subjects_map = {}
        for assignment in Assignment.objects.values('grade', 'subject').distinct():
            g = assignment['grade']
            s = assignment['subject']
            if g not in grade_subjects_map:
                grade_subjects_map[g] = []
            if s and s not in grade_subjects_map[g]:
                grade_subjects_map[g].append(s)

        # Attach subjects to each student object for template access
        for student in students:
            student.grade_subjects = grade_subjects_map.get(student.grade, [])

        existing = {
            a.student_id: a
            for a in Attendance.objects.filter(date=att_date)
        }

        return render(request, self.template_name, {
            'students': students,
            'att_date': att_date,
            'existing': existing,
        })

    def post(self, request):
        att_date_str = request.POST.get('date', str(date.today()))
        try:
            att_date = datetime.strptime(att_date_str, '%Y-%m-%d').date()
        except ValueError:
            att_date = date.today()

        marked = 0
        for key, value in request.POST.items():
            if key.startswith('status_') and value:
                student_id = key.replace('status_', '')
                try:
                    student = Student.objects.get(id=student_id)
                    Attendance.objects.update_or_create(
                        student=student,
                        date=att_date,
                        defaults={
                            'status': value,
                            'marked_by': request.user,
                            'notes': request.POST.get(f'notes_{student_id}', ''),
                        }
                    )
                    marked += 1
                except Student.DoesNotExist:
                    continue

        messages.success(request, f'Attendance marked for {marked} students on {att_date}!')
        return redirect('mark_attendance')   # Stay on attendance page, not dashboard
#---------------------------------------------------------------------------------------------------

class AttendanceHistoryView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/attendance_report.html'

    def get(self, request, student_id=None):
        start = request.GET.get('start_date')
        end = request.GET.get('end_date')
        try:
            start_date = datetime.strptime(start, '%Y-%m-%d').date() if start else date.today() - timedelta(days=30)
            end_date = datetime.strptime(end, '%Y-%m-%d').date() if end else date.today()
        except ValueError:
            start_date = date.today() - timedelta(days=30)
            end_date = date.today()

        students = Student.objects.filter(id=student_id) if student_id else Student.objects.all()
        data = []
        for s in students:
            records = Attendance.objects.filter(student=s, date__range=[start_date, end_date])
            total = records.count()
            present = records.filter(status='present').count()
            data.append({
                'student': s,
                'total': total,
                'present': present,
                'absent': records.filter(status='absent').count(),
                'late': records.filter(status='late').count(),
                'rate': round(present / total * 100, 1) if total else 0,
            })
        return render(request, self.template_name, {
            'attendance_data': data,
            'start_date': start_date,
            'end_date': end_date,
        })
#---------------------------------------------------------------------------------------------------

class BulkAttendanceView(AttendanceMarkView):
    """Alias for bulk attendance marking."""
    pass
#---------------------------------------------------------------------------------------------------

# --- Ticket Management (Teacher) ---

class TicketListViewTeacher(LoginRequiredMixin, TeacherRequiredMixin, ListView):
    model = AssignmentTicket
    template_name = 'teacher/ticket_list.html'
    context_object_name = 'tickets'
    paginate_by = 20

    def get_queryset(self):
        return AssignmentTicket.objects.filter(
            assignment__created_by=self.request.user
        ).select_related('student__user', 'assignment').order_by('-created_at')
#---------------------------------------------------------------------------------------------------

class TicketResponseView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/ticket_respond.html'

    def get(self, request, pk):
        ticket = get_object_or_404(AssignmentTicket, pk=pk)
        form = TicketResponseForm(instance=ticket)
        return render(request, self.template_name, {'ticket': ticket, 'form': form})

    def post(self, request, pk):
        ticket = get_object_or_404(AssignmentTicket, pk=pk)
        form = TicketResponseForm(request.POST, instance=ticket)
        if form.is_valid():
            t = form.save(commit=False)
            if t.status in ('verified', 'rejected', 'closed'):
                t.resolved_at = timezone.now()
                t.resolved_by = request.user
            t.save()
            messages.success(request, 'Ticket updated!')
            return redirect('teacher_tickets')
        return render(request, self.template_name, {'ticket': ticket, 'form': form})


# --- Brush-Up (Teacher) ---

class BrushUpRequestListViewTeacher(LoginRequiredMixin, TeacherRequiredMixin, ListView):
    model = BrushUpRequest
    template_name = 'teacher/brushup_list.html'
    context_object_name = 'requests'
    paginate_by = 20

    def get_queryset(self):
        return BrushUpRequest.objects.filter(
            topic__created_by=self.request.user
        ).select_related('student__user', 'topic').order_by('-created_at')
#---------------------------------------------------------------------------------------------------

class BrushUpResponseView(LoginRequiredMixin, TeacherRequiredMixin, View):
    template_name = 'teacher/brushup_respond.html'

    def get(self, request, pk):
        req = get_object_or_404(BrushUpRequest, pk=pk)
        form = BrushUpResponseForm(instance=req)
        return render(request, self.template_name, {'brushup_request': req, 'form': form})

    def post(self, request, pk):
        req = get_object_or_404(BrushUpRequest, pk=pk)
        form = BrushUpResponseForm(request.POST, instance=req)
        if form.is_valid():
            form.save()
            messages.success(request, 'Response saved!')
            return redirect('teacher_brushup_requests')
        return render(request, self.template_name, {'brushup_request': req, 'form': form})


# ============================================================================
# PARENT VIEWS
# ============================================================================

class ParentDashboardView(LoginRequiredMixin, ParentRequiredMixin, View):
    template_name = 'parent/dashboard.html'

    def get(self, request):
        children = Student.objects.filter(parent=request.user).select_related('user')
        holidays = Holiday.objects.filter(date__gte=date.today()).order_by('date')[:5]
        status_posts = StatusPost.objects.filter(
            target_role__in=['all', 'parent']
        ).order_by('-is_pinned', '-created_at')[:5]

        children_data = []
        for child in children:
            submissions = Submission.objects.filter(student=child)
            children_data.append({
                'student': child,
                'total_assignments': submissions.count(),
                'completed': submissions.filter(status='graded').count(),
                'pending': submissions.filter(status='submitted').count(),
                'not_submitted': submissions.filter(status='not_submitted').count(),
                'average_score': round(
                    submissions.filter(status='graded', score__isnull=False).aggregate(Avg('score'))['score__avg'] or 0, 2
                ),
                'recent_scores': TestScore.objects.filter(student=child).order_by('-date')[:3],
            })

        return render(request, self.template_name, {
            'children_data': children_data,
            'holidays': holidays,
            'status_posts': status_posts,
        })


class ParentStudentProgressView(LoginRequiredMixin, ParentRequiredMixin, View):
    template_name = 'parent/student_progress.html'

    def get(self, request, student_id):
        student = get_object_or_404(Student, pk=student_id, parent=request.user)
        submissions = Submission.objects.filter(student=student, status='graded', score__isnull=False)
        test_scores = TestScore.objects.filter(student=student).order_by('-date')

        monthly = list(
            submissions.annotate(month=TruncMonth('submitted_at'))
            .values('month').annotate(avg=Avg('score')).order_by('month')
        )

        return render(request, self.template_name, {
            'student': student,
            'monthly_data': json.dumps(monthly, default=str),
            'test_scores': test_scores,
            'avg_score': round(submissions.aggregate(Avg('score'))['score__avg'] or 0, 2),
        })


class ParentAssignmentStatusView(LoginRequiredMixin, ParentRequiredMixin, View):
    template_name = 'parent/assignment_status.html'

    def get(self, request, student_id):
        student = get_object_or_404(Student, pk=student_id, parent=request.user)
        submissions = Submission.objects.filter(student=student).select_related('assignment').order_by('-submitted_at')
        return render(request, self.template_name, {'student': student, 'submissions': submissions})


class ParentRoadmapView(LoginRequiredMixin, ParentRequiredMixin, View):
    template_name = 'parent/roadmap.html'

    def get(self, request, student_id):
        student = get_object_or_404(Student, pk=student_id, parent=request.user)
        topics = RoadmapTopic.objects.all().order_by('order')
        tree_data = _build_topic_tree(topics)
        completed = topics.filter(status='completed').count()
        total = topics.count()
        return render(request, self.template_name, {
            'student': student,
            'tree_data': json.dumps(tree_data),
            'completed_count': completed,
            'total_count': total,
            'progress_percentage': round(completed / total * 100, 1) if total else 0,
        })


class ParentStudentAttendanceView(LoginRequiredMixin, View):
    template_name = 'parent/student_attendance.html'
    
    def get(self, request, *args, **kwargs):
        try:
            # Get the student - adjust based on your URL pattern
            student = get_object_or_404(Student, pk=kwargs.get('student_id'))
            
            # Verify this parent is allowed to view this student
            if hasattr(request.user, 'profile') and request.user.profile.role == 'parent':
                if student.parent != request.user:
                    return HttpResponseForbidden("You don't have permission to view this student")
            
            # Get attendance records - DON'T slice before filtering
            records = Attendance.objects.filter(student=student)
            
            # Now filter
            present = records.filter(status='present').count()
            absent = records.filter(status='absent').count()
            total = present + absent
            
            # Now you can slice if needed for recent records
            recent_records = records.order_by('-date')[:10]
            
            # Calculate percentage
            percentage = 0
            if total > 0:
                percentage = (present / total * 100)
            
            context = {
                'student': student,
                'present': present,
                'absent': absent,
                'total': total,
                'percentage': percentage,
                'recent_records': recent_records,
            }
            
            return render(request, self.template_name, context)
            
        except Exception as e:
            print(f"Error in parent attendance view: {e}")
            return render(request, self.template_name, {'error': str(e)})


class ParentAttendanceView(ParentStudentAttendanceView):
    """Alias for ParentStudentAttendanceView for URL compatibility"""
    pass


class ParentFeedbackView(LoginRequiredMixin, ParentRequiredMixin, View):
    template_name = 'parent/feedback.html'

    def get(self, request):
        feedbacks = Feedback.objects.filter(submitted_by=request.user).order_by('-created_at')
        form = FeedbackForm()
        return render(request, self.template_name, {'feedbacks': feedbacks, 'form': form})

    def post(self, request):
        form = FeedbackForm(request.POST)
        if form.is_valid():
            fb = form.save(commit=False)
            fb.submitted_by = request.user
            fb.save()
            messages.success(request, 'Feedback submitted!')
            return redirect('parent_feedback')
        feedbacks = Feedback.objects.filter(submitted_by=request.user)
        return render(request, self.template_name, {'feedbacks': feedbacks, 'form': form})


# ============================================================================
# STUDENT VIEWS
# ============================================================================

class StudentDashboardView(LoginRequiredMixin, StudentRequiredMixin, View):
    template_name = 'student/dashboard.html'

    def get(self, request):
        student = request.user.student
        all_submissions = Submission.objects.filter(student=student)
        submitted_ids = all_submissions.filter(
            status__in=['submitted', 'graded']
        ).values_list('assignment_id', flat=True)

        pending = Assignment.objects.filter(
            status='active', due_date__gte=date.today()
        ).exclude(id__in=submitted_ids)

        overdue = Assignment.objects.filter(
            status='active', due_date__lt=date.today()
        ).exclude(id__in=submitted_ids)

        avg_score = all_submissions.filter(
            status='graded', score__isnull=False
        ).aggregate(Avg('score'))['score__avg'] or 0

        status_posts = StatusPost.objects.filter(
            target_role__in=['all', 'student']
        ).order_by('-is_pinned', '-created_at')[:5]

        holidays = Holiday.objects.filter(date__gte=date.today()).order_by('date')[:5]

        return render(request, self.template_name, {
            'completed_assignments': all_submissions.filter(status='graded'),
            'pending_assignments': pending,
            'overdue_assignments': overdue,
            'submitted_assignments': all_submissions.filter(status='submitted'),
            'average_score': round(avg_score, 2),
            'total_assignments': all_submissions.count(),
            'status_posts': status_posts,
            'holidays': holidays,
            'unread_notifications': Notification.objects.filter(user=request.user, is_read=False).count(),
        })


class StudentAssignmentListView(LoginRequiredMixin, StudentRequiredMixin, ListView):
    model = Assignment
    template_name = 'student/assignment_list.html'
    context_object_name = 'assignments'
    paginate_by = 20

    def get_queryset(self):
        return Assignment.objects.filter(status='active').order_by('due_date')

    def get_context_data(self, **kwargs):
        ctx = super().get_context_data(**kwargs)
        student = self.request.user.student
        submitted_ids = Submission.objects.filter(
            student=student
        ).exclude(status='not_submitted').values_list('assignment_id', flat=True)
        ctx['submitted_ids'] = set(submitted_ids)
        return ctx


class StudentAssignmentDetailView(LoginRequiredMixin, StudentRequiredMixin, View):
    template_name = 'student/assignment_detail.html'

    def get(self, request, pk):
        assignment = get_object_or_404(Assignment, pk=pk)
        student = request.user.student
        submission = Submission.objects.filter(assignment=assignment, student=student).first()
        return render(request, self.template_name, {
            'assignment': assignment,
            'submission': submission,
        })


class StudentSubmissionCreateView(LoginRequiredMixin, StudentRequiredMixin, View):
    template_name = 'student/submit_assignment.html'

    def get(self, request, assignment_id):
        assignment = get_object_or_404(Assignment, pk=assignment_id)
        form = SubmissionForm()
        return render(request, self.template_name, {'assignment': assignment, 'form': form})

    def post(self, request, assignment_id):
        assignment = get_object_or_404(Assignment, pk=assignment_id)
        student = request.user.student
        form = SubmissionForm(request.POST, request.FILES)

        if form.is_valid():
            submission, _ = Submission.objects.get_or_create(
                assignment=assignment,
                student=student,
                defaults={'status': 'not_submitted'}
            )
            submission.file = form.cleaned_data.get('file') or submission.file
            submission.submission_text = form.cleaned_data.get('submission_text', '')
            submission.submission_method = form.cleaned_data.get('submission_method', 'online')
            submission.status = 'submitted'
            submission.submitted_at = timezone.now()
            submission.save()
            messages.success(request, 'Assignment submitted successfully!')
            return redirect('student_dashboard')

        return render(request, self.template_name, {'assignment': assignment, 'form': form})


class StudentProgressView(LoginRequiredMixin, StudentRequiredMixin, View):
    """Progress form with graph and progress card per topic."""
    template_name = 'student/progress.html'

    def get(self, request):
        student = request.user.student
        submissions = Submission.objects.filter(student=student, status='graded', score__isnull=False)

        monthly = list(
            submissions.annotate(month=TruncMonth('submitted_at'))
            .values('month').annotate(avg=Avg('score'), count=Count('id')).order_by('month')
        )

        test_scores = TestScore.objects.filter(student=student).order_by('-date')
        topics = RoadmapTopic.objects.all()
        topic_progress = {}
        for topic in topics:
            topic_progress[topic.title] = {
                'status': topic.status,
                'badge_class': topic.get_badge_class(),
                'completion': {'completed': 100, 'in_progress': 50, 'upcoming': 10, 'not_started': 0}.get(topic.status, 0),
            }

        avg = submissions.aggregate(Avg('score'))['score__avg'] or 0

        return render(request, self.template_name, {
            'monthly_scores': json.dumps(monthly, default=str),
            'topic_progress': json.dumps(topic_progress),
            'topic_progress_raw': list(topic_progress.items()),
            'test_scores': test_scores[:10],
            'total_assignments': submissions.count(),
            'average_score': round(avg, 2),
            'attendance_rate': student.get_attendance_rate(),
        })


class StudentRoadmapView(LoginRequiredMixin, StudentRequiredMixin, View):
    """
    Roadmap as tree view with future topics, test dates visible.
    Student can request brush-up from here.
    """
    template_name = 'student/roadmap.html'

    def get(self, request):
        topics = RoadmapTopic.objects.all().order_by('order')
        tree_data = _build_topic_tree(topics, include_tests=True)
        completed = topics.filter(status='completed').count()
        total = topics.count()
        return render(request, self.template_name, {
            'tree_data': json.dumps(tree_data),
            'completion_percentage': round(completed / total * 100, 1) if total else 0,
            'completed_topics': completed,
            'total_topics': total,
        })


class StudentAttendanceView(LoginRequiredMixin, View):
    template_name = 'student/attendance.html'
    
    def get(self, request, *args, **kwargs):
        try:
            # Get the student - adjust based on how you're getting the student
            # Option 1: If using DetailView with pk
            student = get_object_or_404(Student, pk=kwargs.get('pk'))
            
            # Option 2: If getting from logged-in user
            # student = request.user.student_profile  # or however you access it
            
            # Get attendance records - DON'T slice before filtering
            records = Attendance.objects.filter(student=student)
            
            # Now filter
            present = records.filter(status='present').count()
            absent = records.filter(status='absent').count()
            total = present + absent
            
            # Now you can slice if needed for recent records
            recent_records = records.order_by('-date')[:10]
            
            # Calculate percentage
            percentage = 0
            if total > 0:
                percentage = (present / total * 100)
            
            context = {
                'student': student,
                'present': present,
                'absent': absent,
                'total': total,
                'percentage': percentage,
                'recent_records': recent_records,
            }
            
            return render(request, self.template_name, context)
            
        except Exception as e:
            print(f"Error in student attendance view: {e}")
            return render(request, self.template_name, {'error': str(e)})


class StudentTestScoresView(LoginRequiredMixin, StudentRequiredMixin, ListView):
    model = TestScore
    template_name = 'student/test_scores.html'
    context_object_name = 'test_scores'
    paginate_by = 20

    def get_queryset(self):
        return TestScore.objects.filter(student=self.request.user.student).order_by('-date')


# --- Tickets ---

class RaiseTicketView(LoginRequiredMixin, StudentRequiredMixin, View):
    """Student raises a ticket after submitting via email/WhatsApp/physical."""
    template_name = 'student/raise_ticket.html'

    def get(self, request):
        form = AssignmentTicketForm()
        return render(request, self.template_name, {'form': form})

    def post(self, request):
        form = AssignmentTicketForm(request.POST)
        if form.is_valid():
            ticket = form.save(commit=False)
            ticket.student = request.user.student
            ticket.save()
            messages.success(request, 'Ticket raised! Teacher will review it soon.')
            return redirect('ticket_list')
        return render(request, self.template_name, {'form': form})


class TicketListView(LoginRequiredMixin, StudentRequiredMixin, ListView):
    model = AssignmentTicket
    template_name = 'student/ticket_list.html'
    context_object_name = 'tickets'
    paginate_by = 20

    def get_queryset(self):
        return AssignmentTicket.objects.filter(
            student=self.request.user.student
        ).select_related('assignment').order_by('-created_at')


class TicketDetailView(LoginRequiredMixin, StudentRequiredMixin, View):
    template_name = 'student/ticket_detail.html'

    def get(self, request, pk):
        ticket = get_object_or_404(AssignmentTicket, pk=pk, student=request.user.student)
        return render(request, self.template_name, {'ticket': ticket})


# --- Brush-up / Retest ---

class BrushUpRequestView(LoginRequiredMixin, StudentRequiredMixin, View):
    """Student requests brush-up or re-test from roadmap."""
    template_name = 'student/brushup_request.html'

    def get(self, request):
        form = BrushUpRequestForm()
        return render(request, self.template_name, {'form': form})

    def post(self, request):
        form = BrushUpRequestForm(request.POST)
        if form.is_valid():
            req = form.save(commit=False)
            req.student = request.user.student
            req.save()
            label = 'Brush-up session' if req.request_type == 'brushup' else 'Re-test'
            messages.success(request, f'{label} request submitted!')
            return redirect('brushup_list')
        return render(request, self.template_name, {'form': form})


class BrushUpRequestListView(LoginRequiredMixin, StudentRequiredMixin, ListView):
    model = BrushUpRequest
    template_name = 'student/brushup_list.html'
    context_object_name = 'requests'
    paginate_by = 20

    def get_queryset(self):
        return BrushUpRequest.objects.filter(
            student=self.request.user.student
        ).order_by('-created_at')


class RetestRequestView(LoginRequiredMixin, StudentRequiredMixin, View):
    """Apply for re-test from a failed test entry."""
    template_name = 'student/retest_request.html'

    def get(self, request, test_id):
        test = get_object_or_404(TestScore, pk=test_id, student=request.user.student)
        return render(request, self.template_name, {'test': test})

    def post(self, request, test_id):
        test = get_object_or_404(TestScore, pk=test_id, student=request.user.student)
        reason = request.POST.get('reason', '')
        if test.roadmap_topic:
            BrushUpRequest.objects.create(
                student=request.user.student,
                topic=test.roadmap_topic,
                request_type='retest',
                reason=reason or f'Re-test request for {test.test_name}'
            )
            messages.success(request, 'Re-test request submitted!')
        else:
            messages.error(request, 'No roadmap topic linked to this test.')
        return redirect('brushup_list')


# ============================================================================
# API ENDPOINTS
# ============================================================================

class RoadmapTreeAPIView(LoginRequiredMixin, View):
    def get(self, request, teacher_id=None):
        if teacher_id:
            topics = RoadmapTopic.objects.filter(created_by_id=teacher_id).order_by('order')
        else:
            topics = RoadmapTopic.objects.all().order_by('order')
        return JsonResponse(_build_topic_tree(topics, include_tests=True), safe=False)


class AssignmentStatusAPIView(LoginRequiredMixin, View):
    def get(self, request, assignment_id):
        assignment = get_object_or_404(Assignment, pk=assignment_id)
        return JsonResponse(assignment.get_submission_stats())


class StudentProgressAPIView(LoginRequiredMixin, View):
    def get(self, request, student_id):
        try:
            student = Student.objects.get(pk=student_id)
            submissions = Submission.objects.filter(student=student)
            return JsonResponse({
                'total': submissions.count(),
                'graded': submissions.filter(status='graded').count(),
                'pending': submissions.filter(status='submitted').count(),
                'average_score': round(
                    submissions.filter(status='graded', score__isnull=False)
                    .aggregate(Avg('score'))['score__avg'] or 0, 2
                ),
            })
        except Student.DoesNotExist:
            return JsonResponse({'error': 'Not found'}, status=404)


class AttendanceAPIView(LoginRequiredMixin, View):
    def get(self, request, student_id):
        student = get_object_or_404(Student, pk=student_id)
        records = Attendance.objects.filter(student=student).order_by('-date')[:30]
        data = [
            {'date': str(r.date), 'status': r.status}
            for r in records
        ]
        return JsonResponse(data, safe=False)


class NotificationCountAPIView(LoginRequiredMixin, View):
    def get(self, request):
        count = Notification.objects.filter(user=request.user, is_read=False).count()
        return JsonResponse({'unread_count': count})


# ============================================================================
# HELPERS
# ============================================================================

def _build_topic_tree(topics, include_tests=False):
    """
    Build hierarchical tree JSON from a queryset of RoadmapTopic.
    Used by all roadmap views.
    """
    topic_dict = {}
    for topic in topics:
        node = {
            'id': topic.id,
            'name': topic.title,
            'status': topic.status,
            'badge_class': topic.get_badge_class(),
            'description': topic.description,
            'children': [],
        }
        if include_tests:
            node['test_scheduled'] = str(topic.test_scheduled) if topic.test_scheduled else None
            node['test_title'] = topic.test_title
            node['has_upcoming_test'] = topic.has_upcoming_test()
        topic_dict[topic.id] = node

    tree = []
    for topic in topics:
        if topic.parent_topic_id and topic.parent_topic_id in topic_dict:
            topic_dict[topic.parent_topic_id]['children'].append(topic_dict[topic.id])
        else:
            tree.append(topic_dict[topic.id])

    return tree

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\edutrack\__init__.py
<<code:
# Django project initialization

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\edutrack\asgi.py
<<code:
"""
ASGI config for edutrack project.
"""

import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'edutrack.settings')

application = get_asgi_application()
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\edutrack\settings.py
<<code:
"""
Django settings for edutrack project.
Updated: SQLite for production (ready to migrate to PostgreSQL — see comments).
"""

from pathlib import Path
import os

BASE_DIR = Path(__file__).resolve().parent.parent

# IMPORTANT: Change this in production!
SECRET_KEY = 'django-insecure-edu-track-secret-key-change-in-production-2024'

DEBUG = True

ALLOWED_HOSTS = ['192.168.1.38', '127.0.0.1']

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'core',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'edutrack.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'edutrack.wsgi.application'

# =====================
# DATABASE CONFIGURATION
# =====================
# Currently using SQLite for local/production use.
# To migrate to PostgreSQL:
#   1. pip install psycopg2-binary
#   2. Replace the DATABASES block below with the PostgreSQL config (commented out).
#   3. Run: python manage.py migrate
#   4. Optionally export SQLite data: python manage.py dumpdata > data.json
#      then load it: python manage.py loaddata data.json

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
        # SQLite tuning for better concurrency (WAL mode is set via migration or signal)
        'OPTIONS': {
            'timeout': 30,
        },
    }
}

# PostgreSQL config (uncomment and replace DATABASES above when ready to migrate):
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': os.environ.get('DB_NAME', 'edutrack'),
#         'USER': os.environ.get('DB_USER', 'edutrack_user'),
#         'PASSWORD': os.environ.get('DB_PASSWORD', ''),
#         'HOST': os.environ.get('DB_HOST', 'localhost'),
#         'PORT': os.environ.get('DB_PORT', '5432'),
#     }
# }

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'Asia/Kolkata'   # Updated to IST
USE_I18N = True
USE_TZ = True

STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
STATIC_ROOT = BASE_DIR / 'staticfiles'   # for collectstatic in production

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

LOGIN_URL = 'login'
LOGIN_REDIRECT_URL = 'dashboard'
LOGOUT_REDIRECT_URL = 'login'

# File upload size limit (10 MB)
DATA_UPLOAD_MAX_MEMORY_SIZE = 10485760
FILE_UPLOAD_MAX_MEMORY_SIZE = 10485760

# Session security
SESSION_COOKIE_AGE = 86400  # 24 hours
SESSION_SAVE_EVERY_REQUEST = True

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\edutrack\urls.py
<<code:
"""
URL configuration for edutrack project.
"""
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('core.urls')),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\edutrack\wsgi.py
<<code:
"""
WSGI config for edutrack project.
"""

import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'edutrack.settings')

application = get_wsgi_application()
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\manage.py
<<code:
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'edutrack.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\static\css\style.css
<<code:
/* EduTrack Custom Styles */

:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #48bb78;
    --danger-color: #f56565;
    --warning-color: #ed8936;
    --info-color: #4299e1;
    --dark-color: #2d3748;
    --light-color: #f7fafc;
}

/* General Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
}

/* Navbar Enhancements */
.navbar-brand {
    font-weight: 700;
    font-size: 1.5rem;
}

.navbar {
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

/* Card Enhancements */
.card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
}

/* Statistics Cards */
.stat-card {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 20px;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Button Styles */
.btn {
    border-radius: 6px;
    font-weight: 500;
    padding: 10px 20px;
    transition: all 0.3s;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,.2);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
}

/* Form Styles */
.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 8px;
}

/* Table Styles */
.table {
    background: white;
}

.table thead th {
    background-color: var(--light-color);
    color: var(--dark-color);
    font-weight: 600;
    border: none;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
}

/* Badge Styles */
.badge {
    padding: 6px 12px;
    font-weight: 500;
    border-radius: 6px;
}

/* Progress Bar */
.progress {
    height: 10px;
    border-radius: 5px;
    background-color: #e2e8f0;
}

.progress-bar {
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 5px;
}

/* List Group */
.list-group-item {
    border: 1px solid #e2e8f0;
    margin-bottom: 8px;
    border-radius: 8px !important;
    transition: all 0.2s;
}

.list-group-item:hover {
    background-color: #f7fafc;
    transform: translateX(5px);
}

/* Alert Styles */
.alert {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.1);
}

/* Dashboard Specific */
.dashboard-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
}

/* Assignment Card */
.assignment-card {
    border-left: 4px solid var(--primary-color);
    padding: 20px;
    margin-bottom: 15px;
    background: white;
    border-radius: 8px;
}

.assignment-card.pending {
    border-left-color: var(--warning-color);
}

.assignment-card.completed {
    border-left-color: var(--success-color);
}

/* Student Progress */
.progress-item {
    margin-bottom: 20px;
}

.progress-item .progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

/* Roadmap Timeline */
.roadmap-item {
    position: relative;
    padding-left: 40px;
    margin-bottom: 25px;
}

.roadmap-item::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: -25px;
    width: 2px;
    background: #e2e8f0;
}

.roadmap-item::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-color);
}

.roadmap-item.completed::after {
    background: var(--success-color);
}

.roadmap-item.in-progress::after {
    background: var(--warning-color);
}

/* Footer */
.footer {
    margin-top: 50px;
    padding: 20px 0;
    background-color: var(--light-color);
    text-align: center;
    color: #718096;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-value {
        font-size: 2rem;
    }
    
    .card {
        margin-bottom: 15px;
    }
    
    .navbar-brand {
        font-size: 1.2rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

/* Loading Spinner */
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\static\js\main.js
<<code:
// EduTrack Main JavaScript — Updated

document.addEventListener('DOMContentLoaded', function () {

  // ─── Auto-hide alerts after 5 seconds ─────────────────────────
  document.querySelectorAll('.alert:not(.alert-permanent)').forEach(alert => {
    setTimeout(() => {
      const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
      if (bsAlert) bsAlert.close();
    }, 5000);
  });

  // ─── Confirm deletes ──────────────────────────────────────────
  document.querySelectorAll('[data-confirm]').forEach(el => {
    el.addEventListener('click', function (e) {
      const msg = this.getAttribute('data-confirm') || 'Are you sure? This cannot be undone.';
      if (!confirm(msg)) e.preventDefault();
    });
  });

  // ─── Bootstrap tooltips ───────────────────────────────────────
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
  });

  // ─── Progress bar animation ───────────────────────────────────
  document.querySelectorAll('.progress-bar[data-width]').forEach(bar => {
    const w = bar.getAttribute('data-width');
    bar.style.width = '0';
    setTimeout(() => {
      bar.style.transition = 'width 1s ease-in-out';
      bar.style.width = w + '%';
    }, 200);
  });

  // ─── Live table search ────────────────────────────────────────
  const searchInput = document.getElementById('table-search');
  if (searchInput) {
    searchInput.addEventListener('keyup', function () {
      const val = this.value.toLowerCase();
      document.querySelectorAll('table tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(val) ? '' : 'none';
      });
    });
  }

  // ─── Image preview on file select ────────────────────────────
  document.querySelectorAll('input[type="file"][accept*="image"]').forEach(input => {
    input.addEventListener('change', function () {
      if (!this.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => {
        let prev = document.getElementById('img-preview-' + (this.id || 'default'));
        if (!prev) {
          prev = document.createElement('img');
          prev.id = 'img-preview-' + (this.id || 'default');
          prev.className = 'img-thumbnail mt-2 rounded-circle';
          prev.style.cssText = 'width:80px;height:80px;object-fit:cover;';
          this.parentNode.appendChild(prev);
        }
        prev.src = e.target.result;
      };
      reader.readAsDataURL(this.files[0]);
    });
  });

  // ─── Character counter for textareas with maxlength ──────────
  document.querySelectorAll('textarea[maxlength]').forEach(ta => {
    const max = parseInt(ta.getAttribute('maxlength'));
    const counter = document.createElement('small');
    counter.className = 'text-muted d-block text-end';
    counter.textContent = `0 / ${max}`;
    ta.parentNode.appendChild(counter);
    ta.addEventListener('input', () => {
      const len = ta.value.length;
      counter.textContent = `${len} / ${max}`;
      counter.className = len > max * 0.9 ? 'text-warning d-block text-end' : 'text-muted d-block text-end';
    });
  });

  // ─── Smooth scroll ────────────────────────────────────────────
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        e.preventDefault();
        target.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });

  // ─── Mark notification as read on click ──────────────────────
  document.querySelectorAll('[data-mark-read]').forEach(el => {
    el.addEventListener('click', function () {
      const id = this.getAttribute('data-mark-read');
      fetch(`/notification/${id}/read/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        }
      });
    });
  });

  // ─── CSRF cookie helper ───────────────────────────────────────
  function getCookie(name) {
    const val = `; ${document.cookie}`;
    const parts = val.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

});

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\all_roadmaps.html
<<code:
{% extends 'base.html' %}
{% block title %}All Roadmaps - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-map"></i> All Teacher Roadmaps</h2>
      <p class="text-muted mb-0">Curriculum progress across all teachers</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  {% if roadmaps_data %}
  <div class="row g-4">
    {% for item in roadmaps_data %}
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex align-items-center gap-3">
          {% if item.teacher.profile.profile_photo %}
            <img src="{{ item.teacher.profile.profile_photo.url }}" class="rounded-circle" width="40" height="40" style="object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white fw-bold" style="width:40px;height:40px;">
              {{ item.teacher.first_name|first }}{{ item.teacher.last_name|first }}
            </div>
          {% endif %}
          <div>
            <strong>{{ item.teacher.get_full_name }}</strong>
            <div class="text-muted small">
              {% for subject in item.teacher.profile.subjects.all %}
                <span class="badge bg-info text-dark me-1">{{ subject.name }}</span>
              {% empty %}
                No subjects assigned
              {% endfor %}
            </div>
          </div>
          <div class="ms-auto text-end">
            <div class="fw-semibold fs-5">
              {% if item.total_topics > 0 %}
                {{ item.completed_topics }}/{{ item.total_topics }}
              {% else %}0{% endif %}
            </div>
            <small class="text-muted">topics done</small>
          </div>
        </div>
        <div class="card-body">

          <!-- Progress bar -->
          {% if item.total_topics > 0 %}
          {% with pct=item.completed_topics|floatformat:0 %}
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="text-muted">Overall Progress</small>
              <small class="fw-semibold">
                {% widthratio item.completed_topics item.total_topics 100 %}%
              </small>
            </div>
            <div class="progress" style="height:10px;">
              <div class="progress-bar bg-success"
                   style="width:{% widthratio item.completed_topics item.total_topics 100 %}%"></div>
            </div>
          </div>
          {% endwith %}
          {% endif %}

          <!-- Status breakdown -->
          <div class="row text-center g-2 mb-3">
            <div class="col-4">
              <div class="border rounded p-2">
                <div class="fs-5 fw-bold text-success">{{ item.completed_topics }}</div>
                <small class="text-muted">Completed</small>
              </div>
            </div>
            <div class="col-4">
              <div class="border rounded p-2">
                <div class="fs-5 fw-bold text-warning">{{ item.in_progress_topics }}</div>
                <small class="text-muted">In Progress</small>
              </div>
            </div>
            <div class="col-4">
              <div class="border rounded p-2">
                <div class="fs-5 fw-bold text-secondary">{{ item.upcoming_topics }}</div>
                <small class="text-muted">Upcoming</small>
              </div>
            </div>
          </div>

          <!-- Root topics preview -->
          {% if item.root_topics %}
          <div class="border-top pt-3">
            <small class="text-muted fw-semibold d-block mb-2">Topics Preview</small>
            {% for topic in item.root_topics %}
            <div class="d-flex align-items-center gap-2 mb-1">
              {% if topic.status == 'completed' %}
                <i class="bi bi-check-circle-fill text-success"></i>
              {% elif topic.status == 'in_progress' %}
                <i class="bi bi-arrow-right-circle-fill text-warning"></i>
              {% else %}
                <i class="bi bi-circle text-secondary"></i>
              {% endif %}
              <span class="small">{{ topic.title }}</span>
            </div>
            {% endfor %}
            {% if item.total_topics > 5 %}
            <small class="text-muted">...and {{ item.total_topics|add:"-5" }} more topics</small>
            {% endif %}
          </div>
          {% else %}
          <p class="text-muted small mb-0">No topics added yet.</p>
          {% endif %}

        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="text-center text-muted py-5">
    <i class="bi bi-map fs-1"></i>
    <p class="mt-2">No teachers or roadmaps found.</p>
  </div>
  {% endif %}

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\analytics.html
<<code:
{% extends 'base.html' %}
{% block title %}Analytics - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .analytics-card { border-radius: 12px; }
  .teacher-card { border-left: 4px solid #667eea; }
  .student-row:hover { background: #f8f9fa; cursor: pointer; }
  .progress { border-radius: 10px; }
  .chart-container { position: relative; height: 300px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-bar-chart-line"></i> Analytics</h2>
      <p class="text-muted mb-0">Student progress & teacher performance overview</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Dashboard
    </a>
  </div>

  <!-- Top Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card text-center analytics-card border-primary">
        <div class="card-body py-3">
          <div class="fs-2 fw-bold text-primary">{{ total_students }}</div>
          <div class="text-muted small">Total Students</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center analytics-card border-success">
        <div class="card-body py-3">
          <div class="fs-2 fw-bold text-success">{{ average_score }}%</div>
          <div class="text-muted small">Overall Avg Score</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <a href="{% url 'admin_tickets' %}" class="text-decoration-none">
        <div class="card text-center analytics-card border-warning h-100">
          <div class="card-body py-3">
            <div class="fs-2 fw-bold text-warning">{{ open_tickets }}</div>
            <div class="text-muted small">Open Tickets</div>
            <small class="text-warning"><i class="bi bi-arrow-right-circle"></i> View All</small>
          </div>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a href="{% url 'admin_brushups' %}" class="text-decoration-none">
        <div class="card text-center analytics-card border-info h-100">
          <div class="card-body py-3">
            <div class="fs-2 fw-bold text-info">{{ pending_brushup }}</div>
            <div class="text-muted small">Pending Brush-ups</div>
            <small class="text-info"><i class="bi bi-arrow-right-circle"></i> View All</small>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- View Toggle -->
  <ul class="nav nav-tabs mb-4" id="analyticsTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#students-tab" data-bs-toggle="tab">
        <i class="bi bi-people"></i> Student Performance
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#teachers-tab" data-bs-toggle="tab">
        <i class="bi bi-mortarboard"></i> Teacher Performance
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#trends-tab" data-bs-toggle="tab">
        <i class="bi bi-graph-up"></i> Monthly Trends
      </a>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ── STUDENT PERFORMANCE TAB ─────────────────────────────────────── -->
    <div class="tab-pane fade show active" id="students-tab">

      <!-- Grade-wise chart -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-bar-chart"></i> Average Score by Grade</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="gradeScoreChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-people"></i> Students per Grade</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="gradeCountChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Student list with progress bars -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-list-ol"></i> Individual Student Performance</strong>
          <span class="badge bg-secondary">{{ student_stats|length }} students</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Student</th>
                  <th>Grade</th>
                  <th>Avg Score</th>
                  <th>Attendance</th>
                  <th>Assignments</th>
                  <th>Fees</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for s in student_stats %}
                <tr class="student-row" onclick="window.location='{% url 'student_detail' s.student.pk %}'">
                  <td class="text-muted small">{{ forloop.counter }}</td>
                  <td>
                    <div class="fw-semibold">{{ s.student.user.get_full_name }}</div>
                    <small class="text-muted">{{ s.student.roll_number }}</small>
                  </td>
                  <td><span class="badge bg-primary">{{ s.student.grade }}{{ s.student.section }}</span></td>
                  <td style="min-width:120px;">
                    <div class="d-flex align-items-center gap-2">
                      <div class="progress flex-grow-1" style="height:8px;">
                        <div class="progress-bar {% if s.avg_score >= 75 %}bg-success{% elif s.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             style="width:{{ s.avg_score }}%"></div>
                      </div>
                      <small class="fw-semibold">{{ s.avg_score }}%</small>
                    </div>
                  </td>
                  <td style="min-width:120px;">
                    <div class="d-flex align-items-center gap-2">
                      <div class="progress flex-grow-1" style="height:8px;">
                        <div class="progress-bar {% if s.attendance_rate >= 75 %}bg-success{% elif s.attendance_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             style="width:{{ s.attendance_rate }}%"></div>
                      </div>
                      <small class="fw-semibold">{{ s.attendance_rate }}%</small>
                    </div>
                  </td>
                  <td>
                    <small>{{ s.graded }}/{{ s.total }} done</small>
                  </td>
                  <td>
                    {% if s.pending_fees > 0 %}
                      <span class="badge bg-danger">₹{{ s.pending_fees }}</span>
                    {% else %}
                      <span class="badge bg-success">Clear</span>
                    {% endif %}
                  </td>
                  <td>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center text-muted py-3">No student data yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ── TEACHER PERFORMANCE TAB ─────────────────────────────────────── -->
    <div class="tab-pane fade" id="teachers-tab">

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-bar-chart"></i> Avg Student Score per Teacher</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="teacherScoreChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-journal-check"></i> Assignments Graded per Teacher</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="teacherGradedChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Teacher cards -->
      <div class="row g-3">
        {% for t in teacher_stats %}
        <div class="col-md-6">
          <div class="card shadow-sm teacher-card">
            <div class="card-body">
              <div class="d-flex align-items-center gap-3 mb-3">
                {% if t.teacher.profile.profile_photo %}
                  <img src="{{ t.teacher.profile.profile_photo.url }}" class="rounded-circle" width="50" height="50" style="object-fit:cover;">
                {% else %}
                  <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white fw-bold" style="width:50px;height:50px;">
                    {{ t.teacher.first_name|first }}{{ t.teacher.last_name|first }}
                  </div>
                {% endif %}
                <div>
                  <h6 class="mb-0 fw-semibold">{{ t.teacher.get_full_name }}</h6>
                  <small class="text-muted">
                    {% for subj in t.teacher.profile.subjects.all %}
                      <span class="badge bg-info text-dark me-1">{{ subj.name }}</span>
                    {% endfor %}
                  </small>
                </div>
                <div class="ms-auto text-end">
                  <div class="fs-4 fw-bold text-primary">{{ t.avg_student_score }}%</div>
                  <small class="text-muted">avg score</small>
                </div>
              </div>

              <div class="row text-center g-2 mb-3">
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-primary">{{ t.total_assignments }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Assignments</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-success">{{ t.graded_submissions }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Graded</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-warning">{{ t.pending_submissions }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Pending</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-info">{{ t.roadmap_progress }}%</div>
                    <small class="text-muted" style="font-size:0.7rem;">Roadmap</small>
                  </div>
                </div>
              </div>

              <!-- Student scores under this teacher -->
              {% if t.student_scores %}
              <div class="border-top pt-2">
                <small class="text-muted fw-semibold d-block mb-2">Students' Progress</small>
                {% for ss in t.student_scores %}
                <div class="mb-1">
                  <div class="d-flex justify-content-between">
                    <small>{{ ss.name }}</small>
                    <small class="fw-semibold">{{ ss.score }}%</small>
                  </div>
                  <div class="progress" style="height:5px;">
                    <div class="progress-bar {% if ss.score >= 75 %}bg-success{% elif ss.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                         style="width:{{ ss.score }}%"></div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12 text-center text-muted py-4">No teacher data available.</div>
        {% endfor %}
      </div>
    </div>

    <!-- ── MONTHLY TRENDS TAB ──────────────────────────────────────────── -->
    <div class="tab-pane fade" id="trends-tab">
      <div class="card shadow-sm">
        <div class="card-header"><strong><i class="bi bi-graph-up"></i> Monthly Submission Trend</strong></div>
        <div class="card-body">
          <div style="height:350px;">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end tab-content -->
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ── Data from Django ─────────────────────────────────────────────────────
  const gradeStats   = {{ grade_stats_json|safe }};
  const monthlyData  = {{ monthly_data|safe }};
  const teacherStats = {{ teacher_stats_json|safe }};

  const COLORS = ['#667eea','#48bb78','#ed8936','#4299e1','#9f7aea','#f56565','#38b2ac','#ecc94b'];

  // ── Grade Score Chart ─────────────────────────────────────────────────
  new Chart(document.getElementById('gradeScoreChart'), {
    type: 'bar',
    data: {
      labels: gradeStats.map(g => 'Grade ' + g.grade),
      datasets: [{
        label: 'Avg Score (%)',
        data: gradeStats.map(g => g.avg_score),
        backgroundColor: COLORS,
        borderRadius: 6,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, max: 100 } },
      plugins: { legend: { display: false } }
    }
  });

  // ── Grade Count Chart ─────────────────────────────────────────────────
  new Chart(document.getElementById('gradeCountChart'), {
    type: 'doughnut',
    data: {
      labels: gradeStats.map(g => 'Grade ' + g.grade),
      datasets: [{
        data: gradeStats.map(g => g.student_count),
        backgroundColor: COLORS,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right' } }
    }
  });

  // ── Teacher Score Chart ───────────────────────────────────────────────
  new Chart(document.getElementById('teacherScoreChart'), {
    type: 'bar',
    data: {
      labels: teacherStats.map(t => t.name),
      datasets: [{
        label: 'Avg Student Score (%)',
        data: teacherStats.map(t => t.avg_student_score),
        backgroundColor: COLORS,
        borderRadius: 6,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, max: 100 } },
      plugins: { legend: { display: false } }
    }
  });

  // ── Teacher Graded Chart ──────────────────────────────────────────────
  new Chart(document.getElementById('teacherGradedChart'), {
    type: 'bar',
    data: {
      labels: teacherStats.map(t => t.name),
      datasets: [
        { label: 'Graded', data: teacherStats.map(t => t.graded), backgroundColor: '#48bb78', borderRadius: 4 },
        { label: 'Pending', data: teacherStats.map(t => t.pending), backgroundColor: '#ed8936', borderRadius: 4 },
      ]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
    }
  });

  // ── Monthly Trend Chart ───────────────────────────────────────────────
  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: monthlyData.map(m => m.month ? m.month.slice(0,7) : ''),
      datasets: [{
        label: 'Avg Score (%)',
        data: monthlyData.map(m => m.avg ? parseFloat(m.avg).toFixed(1) : 0),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102,126,234,0.1)',
        tension: 0.4,
        fill: true,
      },{
        label: 'Submissions Count',
        data: monthlyData.map(m => m.count || 0),
        borderColor: '#48bb78',
        backgroundColor: 'rgba(72,187,120,0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y1',
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: {
        y:  { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } },
        y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' }, grid: { drawOnChartArea: false } },
      }
    }
  });
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\analytics_bk.html
<<code:
{% extends 'admin/base_admin.html' %}

{% block admin_content %}
<div class="container">
    <h2>Analytics Dashboard</h2>
    
    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Total Students</div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_students }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Total Teachers</div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_teachers }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">Total Parents</div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_parents }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Total Assignments</div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_assignments }}</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Attendance Overview</h4>
                </div>
                <div class="card-body">
                    <p>Average Attendance: {{ avg_attendance|floatformat:2 }}%</p>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: {{ avg_attendance }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Assignment Completion</h4>
                </div>
                <div class="card-body">
                    <p>Completed: {{ completed_assignments }}</p>
                    <p>Pending: {{ pending_assignments }}</p>
                    <p>Overdue: {{ overdue_assignments }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\assignment_list.html
<<code:
{% extends 'base.html' %}
{% block title %}All Active Assignments - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-journal-text"></i> All Assignments</h2>
      <p class="text-muted mb-0">Assignments created by all teachers</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Status filter -->
  <div class="d-flex gap-2 mb-3 flex-wrap">
    <a href="?status=" class="btn btn-sm {% if not status_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">
      All ({{ all_count }})
    </a>
    <a href="?status=active" class="btn btn-sm {% if status_filter == 'active' %}btn-success{% else %}btn-outline-success{% endif %}">
      Active ({{ active_count }})
    </a>
    <a href="?status=draft" class="btn btn-sm {% if status_filter == 'draft' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
      Draft ({{ draft_count }})
    </a>
    <a href="?status=closed" class="btn btn-sm {% if status_filter == 'closed' %}btn-danger{% else %}btn-outline-danger{% endif %}">
      Closed ({{ closed_count }})
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Teacher</th>
              <th>Subject</th>
              <th>Grade</th>
              <th>Due Date</th>
              <th>Max Score</th>
              <th>Submissions</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for assignment in assignments %}
            <tr>
              <td class="text-muted small">{{ forloop.counter }}</td>
              <td>
                <div class="fw-semibold">{{ assignment.title }}</div>
                {% if assignment.description %}
                  <small class="text-muted">{{ assignment.description|truncatechars:50 }}</small>
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ assignment.created_by.get_full_name }}</div>
                <small class="text-muted">{{ assignment.created_by.username }}</small>
              </td>
              <td>{{ assignment.subject|default:"—" }}</td>
              <td>
                {% if assignment.grade %}
                  <span class="badge bg-primary">Grade {{ assignment.grade }}</span>
                {% else %}—{% endif %}
              </td>
              <td>
                {% if assignment.due_date %}
                  <span class="{% if assignment.is_overdue %}text-danger fw-semibold{% endif %}">
                    {{ assignment.due_date|date:"d M Y" }}
                  </span>
                  {% if assignment.is_overdue %}
                    <span class="badge bg-danger ms-1">Overdue</span>
                  {% elif assignment.days_until_due <= 3 %}
                    <span class="badge bg-warning text-dark ms-1">Due soon</span>
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td>{{ assignment.max_score }}</td>
              <td>
                <span class="badge bg-info text-dark">
                  {{ assignment.submissions.count }} submitted
                </span>
              </td>
              <td>
                {% if assignment.status == 'active' %}
                  <span class="badge bg-success">Active</span>
                {% elif assignment.status == 'draft' %}
                  <span class="badge bg-secondary">Draft</span>
                {% elif assignment.status == 'closed' %}
                  <span class="badge bg-danger">Closed</span>
                {% else %}
                  <span class="badge bg-secondary">{{ assignment.get_status_display }}</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                <i class="bi bi-journal-x fs-2"></i>
                <p class="mt-2">No assignments found.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if assignments.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if assignments.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ assignments.previous_page_number }}&status={{ status_filter }}">Previous</a>
        </li>
      {% endif %}
      <li class="page-item disabled">
        <span class="page-link">Page {{ assignments.number }} of {{ assignments.paginator.num_pages }}</span>
      </li>
      {% if assignments.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ assignments.next_page_number }}&status={{ status_filter }}">Next</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\brushup_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Brush-Up Requests - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-arrow-repeat"></i> Brush-Up Requests</h2>
      <p class="text-muted mb-0">Student requests for brush-up sessions and re-tests</p>
    </div>
    <a href="{% url 'admin_notifications' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Notifications
    </a>
  </div>

  <!-- Status filter -->
  <div class="d-flex gap-2 mb-3 flex-wrap">
    <a href="?status=" class="btn btn-sm {% if not status_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">
      All ({{ all_count }})
    </a>
    <a href="?status=pending" class="btn btn-sm {% if status_filter == 'pending' %}btn-warning{% else %}btn-outline-warning{% endif %}">
      Pending ({{ pending_count }})
    </a>
    <a href="?status=approved" class="btn btn-sm {% if status_filter == 'approved' %}btn-info{% else %}btn-outline-info{% endif %}">
      Approved ({{ approved_count }})
    </a>
    <a href="?status=scheduled" class="btn btn-sm {% if status_filter == 'scheduled' %}btn-primary{% else %}btn-outline-primary{% endif %}">
      Scheduled ({{ scheduled_count }})
    </a>
    <a href="?status=completed" class="btn btn-sm {% if status_filter == 'completed' %}btn-success{% else %}btn-outline-success{% endif %}">
      Completed ({{ completed_count }})
    </a>
    <a href="?status=rejected" class="btn btn-sm {% if status_filter == 'rejected' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
      Rejected ({{ rejected_count }})
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Student</th>
              <th>Topic</th>
              <th>Type</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Scheduled</th>
              <th>Teacher Response</th>
              <th>Requested</th>
            </tr>
          </thead>
          <tbody>
            {% for req in brushups %}
            <tr>
              <td class="text-muted small">{{ req.id }}</td>
              <td>
                <div class="fw-semibold">{{ req.student.user.get_full_name }}</div>
                <small class="text-muted">{{ req.student.roll_number }}</small>
              </td>
              <td>
                <div>{{ req.topic.title }}</div>
                <small class="text-muted">
                  {{ req.topic.subject|default:"—" }}
                  {% if req.topic.grade %} · Grade {{ req.topic.grade }}{% endif %}
                </small>
              </td>
              <td>
                {% if req.request_type == 'brushup' %}
                  <span class="badge bg-info text-dark"><i class="bi bi-arrow-repeat"></i> Brush-Up</span>
                {% else %}
                  <span class="badge bg-primary"><i class="bi bi-pencil-square"></i> Re-test</span>
                {% endif %}
              </td>
              <td>
                <span class="text-muted small">{{ req.reason|truncatechars:60 }}</span>
              </td>
              <td>
                {% if req.status == 'pending' %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif req.status == 'approved' %}
                  <span class="badge bg-info text-dark">Approved</span>
                {% elif req.status == 'scheduled' %}
                  <span class="badge bg-primary">Scheduled</span>
                {% elif req.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% elif req.status == 'rejected' %}
                  <span class="badge bg-secondary">Rejected</span>
                {% endif %}
              </td>
              <td>
                {% if req.scheduled_date %}
                  <small>{{ req.scheduled_date|date:"d M Y, H:i" }}</small>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td>
                {% if req.teacher_response %}
                  <span class="text-muted small">{{ req.teacher_response|truncatechars:50 }}</span>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td>
                <small>{{ req.created_at|date:"d M Y" }}</small><br>
                <small class="text-muted">{{ req.created_at|timesince }} ago</small>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                <i class="bi bi-arrow-repeat fs-2"></i>
                <p class="mt-2">No brush-up requests found.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\dashboard.html
<<code:
{% extends 'base.html' %}
{% block title %}Admin Dashboard - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>
        <p class="mb-0">Welcome, {{ request.user.get_full_name }}</p>
      </div>
      <div class="col-md-4 text-end">
        <!-- Profile photo update -->
        <form method="post" action="{% url 'profile_photo_update' %}" enctype="multipart/form-data" class="d-inline" id="photo-form-admin">
          {% csrf_token %}
          <label style="cursor:pointer;" title="Click to change photo">
            {% if request.user.profile.profile_photo %}
              <img src="{{ request.user.profile.profile_photo.url }}"
                   class="rounded-circle border border-3 border-light shadow"
                   width="55" height="55" style="object-fit:cover;transition:opacity 0.2s;"
                   onmouseover="this.style.opacity='0.75'" onmouseout="this.style.opacity='1'">
            {% else %}
              <span class="rounded-circle bg-white bg-opacity-25 d-inline-flex align-items-center justify-content-center border border-2 border-light"
                    style="width:55px;height:55px;font-size:1.6rem;">
                <i class="bi bi-person-circle text-white"></i>
              </span>
            {% endif %}
            <input type="file" name="profile_photo" accept="image/*" class="d-none"
                   onchange="document.getElementById('photo-form-admin').submit()">
          </label>
          <small class="text-white-50 d-block mt-1" style="font-size:0.65rem;">click photo to change</small>
        </form>
      </div>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card">
        <div class="stat-value">{{ total_students }}</div>
        <div class="stat-label"><i class="bi bi-people"></i> Students</div>
        <a href="{% url 'admin_student_list' %}" class="btn btn-sm btn-outline-light mt-2">View All</a>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background: linear-gradient(135deg,#48bb78,#276749)">
        <div class="stat-value">{{ total_teachers }}</div>
        <div class="stat-label"><i class="bi bi-mortarboard"></i> Teachers</div>
        <a href="{% url 'teacher_list' %}" class="btn btn-sm btn-outline-light mt-2">View All</a>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background: linear-gradient(135deg,#ed8936,#c05621)">
        <div class="stat-value">{{ total_parents }}</div>
        <div class="stat-label"><i class="bi bi-house-heart"></i> Parents</div>
        <a href="{% url 'parent_list' %}" class="btn btn-sm btn-outline-light mt-2">View All</a>
      </div>
    </div>
    <div class="col-6 col-md-3">
       <div class="stat-card" style="background: linear-gradient(135deg,#4299e1,#2b6cb0)">
         <div class="stat-value">{{ active_assignments }}</div>
         <div class="stat-label"><i class="bi bi-journal-text"></i> Active Assignments</div>
         <a href="{% url 'admin_assignment_list' %}" class="btn btn-sm btn-outline-light mt-2">View All</a>
       </div>
     </div>
  </div>

  <div class="row g-3">

    <!-- Recent Students — FIXED: each student is clickable -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-people-fill"></i> Recent Students</strong>
          <div>
            <a href="{% url 'student_add' %}" class="btn btn-sm btn-success me-1">
              <i class="bi bi-plus-circle"></i> Add
            </a>
            <a href="{% url 'admin_student_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Student</th><th>Grade</th><th>Roll No</th><th></th></tr>
            </thead>
            <tbody>
              {% for student in recent_students %}
              <tr style="cursor:pointer;" onclick="window.location='{% url 'student_detail' student.pk %}'">
                <td>
                  {% if student.user.profile.profile_photo %}
                    <img src="{{ student.user.profile.profile_photo.url }}" class="rounded-circle me-2" width="30" height="30" style="object-fit:cover;">
                  {% endif %}
                  {{ student.user.get_full_name }}
                </td>
                <td><span class="badge bg-primary">{{ student.grade }}{{ student.section }}</span></td>
                <td>{{ student.roll_number }}</td>
                <td>
                  <a href="{% url 'student_detail' student.pk %}" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center text-muted py-3">No students yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Status Microblog + Post -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between">
          <strong><i class="bi bi-megaphone"></i> Status / Announcements</strong>
          <a href="{% url 'status_post' %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus"></i> Post
          </a>
        </div>
        <div class="card-body">
          {% for post in status_posts %}
          <div class="border-start border-3 ps-3 mb-3 {% if post.is_pinned %}border-warning{% else %}border-primary{% endif %}">
            {% if post.is_pinned %}<span class="badge bg-warning text-dark me-1"><i class="bi bi-pin"></i> Pinned</span>{% endif %}
            <span class="badge bg-secondary">{{ post.get_target_role_display }}</span>
            <p class="mb-1 mt-1">{{ post.content }}</p>
            <small class="text-muted">{{ post.created_at|date:"d M Y H:i" }}</small>
          </div>
          {% empty %}
          <p class="text-muted">No posts yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upcoming Holidays -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <strong><i class="bi bi-calendar-event"></i> Upcoming Holidays / Working Days</strong>
          <a href="{% url 'holiday_add' %}" class="btn btn-sm btn-warning">
            <i class="bi bi-broadcast"></i> Broadcast
          </a>
        </div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light"><tr><th>Title</th><th>Date</th><th>Type</th></tr></thead>
            <tbody>
              {% for h in upcoming_holidays %}
              <tr>
                <td>{{ h.title }}</td>
                <td>{{ h.date|date:"d M Y" }}</td>
                <td><span class="badge bg-info text-dark">{{ h.get_holiday_type_display }}</span></td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-center text-muted">No upcoming holidays.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-lightning"></i> Quick Actions</strong></div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'student_add' %}" class="btn btn-outline-primary"><i class="bi bi-person-plus"></i> Add Student</a>
            <a href="{% url 'parent_add' %}" class="btn btn-outline-success"><i class="bi bi-person-plus"></i> Add Parent</a>
            <a href="{% url 'teacher_add' %}" class="btn btn-outline-info"><i class="bi bi-person-plus"></i> Add Teacher</a>
            <a href="{% url 'student_grid' %}" class="btn btn-outline-secondary"><i class="bi bi-grid-3x3-gap"></i> Student Grid</a>
            <a href="{% url 'all_roadmaps' %}" class="btn btn-outline-warning"><i class="bi bi-map"></i> All Roadmaps</a>
            <a href="{% url 'admin_analytics' %}" class="btn btn-outline-dark"><i class="bi bi-bar-chart"></i> Analytics</a>
	    <a href="{% url 'admin_teacher_attendance' %}" class="btn btn-outline-primary"><i class="bi bi-person-check"></i> Teacher Attendance </a>
   	    <a href="{% url 'admin_finance' %}" class="btn btn-outline-success"><i class="bi bi-cash-stack"></i> Finance </a>
   	    <a href="{% url 'admin_teacher_performance' %}" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> Teacher Performance </a>
	  </div>
          {% if pending_tickets > 0 %}
          <div class="alert alert-warning mt-3 py-2">
            <i class="bi bi-ticket-perforated"></i>
            <strong>{{ pending_tickets }}</strong> open assignment ticket(s) awaiting review.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\finance.html
<<code:
{% extends 'base.html' %}
{% block title %}Finance Overview - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .finance-card { border-radius: 12px; }
  .income-card  { border-left: 5px solid #48bb78; }
  .expense-card { border-left: 5px solid #f56565; }
  .net-card     { border-left: 5px solid #667eea; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-cash-stack"></i> EduTrack Finance Overview</h2>
      <p class="text-muted mb-0">Fee income vs salary & petty expenses</p>
    </div>
    <div class="d-flex gap-2">
      <!-- Month filter -->
      <form method="get" class="d-flex gap-2 align-items-center">
        <label class="fw-semibold small mb-0">Month:</label>
        <input type="month" name="month" class="form-control form-control-sm" value="{{ selected_month }}">
        <button type="submit" class="btn btn-sm btn-primary">Go</button>
      </form>
      <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card finance-card income-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total Fee Income</div>
          <div class="fs-3 fw-bold text-success">₹{{ total_income|floatformat:2 }}</div>
          <small class="text-muted">{{ paid_fees_count }} payments received</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card expense-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total Expenses</div>
          <div class="fs-3 fw-bold text-danger">₹{{ total_expenses|floatformat:2 }}</div>
          <small class="text-muted">Salary + Petty Expenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card net-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Net Balance</div>
          <div class="fs-3 fw-bold {% if net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
            ₹{{ net_balance|floatformat:2 }}
          </div>
          <small class="text-muted">Income − Expenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Pending Fees</div>
          <div class="fs-3 fw-bold text-warning">₹{{ total_pending|floatformat:2 }}</div>
          <small class="text-muted">{{ pending_fees_count }} unpaid / overdue</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- Fee Income Breakdown -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-arrow-down-circle text-success"></i> Fee Income — {{ selected_month }}</strong>
          <span class="badge bg-success">₹{{ total_income|floatformat:0 }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:300px;overflow-y:auto;">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Student</th><th>Roll</th><th>Month</th><th>Amount</th><th>Status</th></tr>
              </thead>
              <tbody>
                {% for fee in fee_records %}
                <tr>
                  <td class="fw-semibold small">{{ fee.student.user.get_full_name }}</td>
                  <td><small class="text-muted">{{ fee.student.roll_number }}</small></td>
                  <td><small>{{ fee.month }}</small></td>
                  <td class="fw-semibold">₹{{ fee.fees }}</td>
                  <td>
                    {% if fee.status == 'paid' %}<span class="badge bg-success">Paid</span>
                    {% elif fee.status == 'overdue' %}<span class="badge bg-danger">Overdue</span>
                    {% elif fee.status == 'waived' %}<span class="badge bg-secondary">Waived</span>
                    {% else %}<span class="badge bg-warning text-dark">Unpaid</span>{% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-3">No fee records for this month.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Salary Expenses -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-arrow-up-circle text-danger"></i> Salary Expenses</strong>
          <span class="badge bg-danger">₹{{ total_salary|floatformat:0 }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:200px;overflow-y:auto;">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Name</th><th>Role</th><th>Salary / Month</th></tr>
              </thead>
              <tbody>
                {% for s in salary_records %}
                <tr>
                  <td class="fw-semibold small">{{ s.name }}</td>
                  <td><span class="badge bg-info text-dark small">{{ s.role }}</span></td>
                  <td class="fw-semibold">₹{{ s.salary|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted py-3">No salary records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Petty Expenses -->
        <div class="card-header border-top d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-receipt text-warning"></i> Petty Expenses</strong>
          <span class="badge bg-warning text-dark">₹{{ total_petty|floatformat:0 }}</span>
        </div>
        <div class="card-body">
          <!-- Add petty expense -->
          <form method="post" action="{% url 'admin_finance' %}" class="row g-2 mb-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_expense">
            <div class="col-md-5">
              <input type="text" name="description" class="form-control form-control-sm"
                     placeholder="Description (e.g. Rent)" required>
            </div>
            <div class="col-md-3">
              <input type="number" name="amount" class="form-control form-control-sm"
                     placeholder="Amount ₹" step="0.01" min="0" required>
            </div>
            <div class="col-md-2">
              <input type="date" name="expense_date" class="form-control form-control-sm" value="{{ today }}">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-sm btn-warning w-100">
                <i class="bi bi-plus"></i> Add
              </button>
            </div>
          </form>

          <div class="table-responsive" style="max-height:180px;overflow-y:auto;">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Date</th><th>Description</th><th>Amount</th><th></th></tr>
              </thead>
              <tbody>
                {% for exp in petty_expenses %}
                <tr>
                  <td><small>{{ exp.date|date:"d M Y" }}</small></td>
                  <td><small>{{ exp.description }}</small></td>
                  <td class="fw-semibold">₹{{ exp.amount }}</td>
                  <td>
                    <form method="post" action="{% url 'admin_finance' %}"
                          onsubmit="return confirm('Delete this expense?')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_expense">
                      <input type="hidden" name="expense_id" value="{{ exp.pk }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted">No petty expenses recorded.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(a => bootstrap.Alert.getOrCreateInstance(a).close());
  }, 8000);
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\holiday_form.html
<<code:
{% extends 'base.html' %}
{% block title %}Broadcast Holiday - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-broadcast"></i> Broadcast Holiday / Working Day</h2>
    <a href="{% url 'holiday_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Holidays
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> Holiday Details</h5>
        </div>
        <div class="card-body">

          <div class="alert alert-info small">
            <i class="bi bi-info-circle"></i>
            Broadcasting a holiday sends a <strong>notification to all users</strong>
            (students, parents, teachers) automatically.
          </div>

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-semibold">Title *</label>
              {{ form.title }}
              {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors }}</div>{% endif %}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Start Date *</label>
                {{ form.date }}
                {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">End Date</label>
                {{ form.end_date }}
                <small class="text-muted">Leave blank if single day</small>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Type *</label>
                {{ form.holiday_type }}
              </div>
              <div class="col-md-6 mb-3 d-flex align-items-end">
                <div class="form-check">
                  {{ form.is_recurring }}
                  <label class="form-check-label fw-semibold">Recurring Annually</label>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Description</label>
              {{ form.description }}
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-warning px-4 text-dark fw-semibold">
                <i class="bi bi-broadcast"></i> Broadcast to All Users
              </button>
              <a href="{% url 'holiday_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\holiday_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Holidays - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-calendar-event"></i> Holidays & Working Days</h2>
      <p class="text-muted mb-0">{{ holidays|length }} record(s)</p>
    </div>
    <a href="{% url 'holiday_add' %}" class="btn btn-warning">
      <i class="bi bi-broadcast"></i> Broadcast New Holiday
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th><i class="bi bi-calendar"></i> Title</th>
              <th>Date</th>
              <th>End Date</th>
              <th>Type</th>
              <th>Recurring</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for holiday in holidays %}
            <tr class="{% if holiday.date < today %}text-muted{% endif %}">
              <td class="text-muted small">{{ forloop.counter }}</td>
              <td class="fw-semibold">{{ holiday.title }}</td>
              <td>
                <span class="{% if holiday.date >= today %}text-danger fw-semibold{% endif %}">
                  {{ holiday.date|date:"d M Y" }}
                </span>
              </td>
              <td>{{ holiday.end_date|date:"d M Y"|default:"—" }}</td>
              <td>
                {% if holiday.holiday_type == 'holiday' %}
                  <span class="badge bg-danger">Holiday</span>
                {% elif holiday.holiday_type == 'working' %}
                  <span class="badge bg-success">Working Day</span>
                {% elif holiday.holiday_type == 'half_day' %}
                  <span class="badge bg-warning text-dark">Half Day</span>
                {% else %}
                  <span class="badge bg-info text-dark">{{ holiday.get_holiday_type_display }}</span>
                {% endif %}
              </td>
              <td>
                {% if holiday.is_recurring %}
                  <span class="badge bg-secondary"><i class="bi bi-arrow-repeat"></i> Yes</span>
                {% else %}—{% endif %}
              </td>
              <td>
                <span class="text-muted small">{{ holiday.description|truncatechars:50 }}</span>
              </td>
              <td>
                <form method="post" action="{% url 'holiday_delete' holiday.pk %}" class="d-inline"
                      onsubmit="return confirm('Delete {{ holiday.title }}?')">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-calendar-x fs-3"></i>
                <p class="mt-2">No holidays declared yet. <a href="{% url 'holiday_add' %}">Broadcast one now</a>.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\notification_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Notifications - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .notif-item {
    border-left: 4px solid #dee2e6;
    transition: border-color 0.2s;
  }
  .notif-item.unread {
    border-left-color: #0d6efd;
    background: #f8f9ff;
  }
  .notif-item:hover { background: #f1f3f5; }
  .notif-badge {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 20px;
  }
  .type-icon { font-size: 1.1rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-bell"></i> All Notifications</h2>
      <p class="text-muted mb-0">Communication across students, teachers and parents</p>
    </div>
    <form method="post" action="{% url 'admin_mark_all_notifications_read' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-check2-all"></i> Mark All Read
      </button>
    </form>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Summary Pills -->
  <div class="d-flex gap-3 mb-4 flex-wrap">
    <span class="badge bg-primary fs-6 px-3 py-2">
      <i class="bi bi-envelope"></i> {{ unread_count }} Unread
    </span>
    <span class="badge bg-secondary fs-6 px-3 py-2">
      <i class="bi bi-collection"></i> {{ total_count }} Total
    </span>
    <a href="{% url 'admin_tickets' %}" class="badge bg-warning text-dark fs-6 px-3 py-2 text-decoration-none">
      <i class="bi bi-ticket-perforated"></i> {{ open_tickets }} Open Tickets
    </a>
    <a href="{% url 'admin_brushups' %}" class="badge bg-info text-dark fs-6 px-3 py-2 text-decoration-none">
      <i class="bi bi-arrow-repeat"></i> {{ pending_brushups }} Pending Brush-ups
    </a>
  </div>

  <!-- Filter by role -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="?role=" class="btn btn-sm {% if not role_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">All Roles</a>
    <a href="?role=student" class="btn btn-sm {% if role_filter == 'student' %}btn-primary{% else %}btn-outline-primary{% endif %}">Students</a>
    <a href="?role=teacher" class="btn btn-sm {% if role_filter == 'teacher' %}btn-success{% else %}btn-outline-success{% endif %}">Teachers</a>
    <a href="?role=parent" class="btn btn-sm {% if role_filter == 'parent' %}btn-warning{% else %}btn-outline-warning{% endif %}">Parents</a>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-0" id="notifTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#unread-tab" data-bs-toggle="tab">
        <i class="bi bi-envelope"></i> Unread
        {% if unread_count %}<span class="badge bg-danger ms-1">{{ unread_count }}</span>{% endif %}
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#all-tab" data-bs-toggle="tab" id="all-tab-link">
        <i class="bi bi-collection"></i> All
      </a>
    </li>
  </ul>

  <div class="tab-content border border-top-0 rounded-bottom bg-white">

    <!-- UNREAD TAB -->
    <div class="tab-pane fade show active p-3" id="unread-tab">
      {% for notif in unread_notifications %}
      <div class="notif-item unread rounded p-3 mb-2 d-flex align-items-start gap-3">

        <!-- Type icon -->
        <div class="type-icon text-primary mt-1">
          {% if notif.notification_type == 'assignment' %}<i class="bi bi-journal-text"></i>
          {% elif notif.notification_type == 'grade' %}<i class="bi bi-star"></i>
          {% elif notif.notification_type == 'comment' %}<i class="bi bi-chat-left-text"></i>
          {% elif notif.notification_type == 'holiday' %}<i class="bi bi-calendar-event"></i>
          {% elif notif.notification_type == 'attendance' %}<i class="bi bi-person-check"></i>
          {% elif notif.notification_type == 'ticket' %}<i class="bi bi-ticket-perforated"></i>
          {% elif notif.notification_type == 'brushup' %}<i class="bi bi-arrow-repeat"></i>
          {% else %}<i class="bi bi-bell"></i>{% endif %}
        </div>

        <!-- Content -->
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>{{ notif.title }}</strong>
              <span class="badge bg-primary notif-badge ms-2">{{ notif.get_notification_type_display }}</span>
              <!-- Role badge -->
              {% with role=notif.user.profile.role %}
              {% if role == 'student' %}<span class="badge bg-info text-dark notif-badge ms-1">Student</span>
              {% elif role == 'teacher' %}<span class="badge bg-success notif-badge ms-1">Teacher</span>
              {% elif role == 'parent' %}<span class="badge bg-warning text-dark notif-badge ms-1">Parent</span>
              {% endif %}
              {% endwith %}
            </div>
            <small class="text-muted text-nowrap ms-2">{{ notif.created_at|timesince }} ago</small>
          </div>
          <p class="mb-1 mt-1 text-muted">{{ notif.message }}</p>
          <small class="text-muted">
            <i class="bi bi-person"></i> {{ notif.user.get_full_name }} ({{ notif.user.username }})
          </small>
        </div>

        <!-- Mark read button -->
        <form method="post" action="{% url 'admin_mark_notification_read' notif.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-primary" title="Mark as read">
            <i class="bi bi-check"></i>
          </button>
        </form>

      </div>
      {% empty %}
      <div class="text-center text-muted py-5">
        <i class="bi bi-check2-all fs-1"></i>
        <p class="mt-2">No unread notifications.</p>
      </div>
      {% endfor %}
    </div>

    <!-- ALL TAB -->
    <div class="tab-pane fade p-3" id="all-tab">
      {% for notif in all_notifications %}
      <div class="notif-item {% if not notif.is_read %}unread{% endif %} rounded p-3 mb-2 d-flex align-items-start gap-3">

        <div class="type-icon {% if notif.is_read %}text-muted{% else %}text-primary{% endif %} mt-1">
          {% if notif.notification_type == 'assignment' %}<i class="bi bi-journal-text"></i>
          {% elif notif.notification_type == 'grade' %}<i class="bi bi-star"></i>
          {% elif notif.notification_type == 'comment' %}<i class="bi bi-chat-left-text"></i>
          {% elif notif.notification_type == 'holiday' %}<i class="bi bi-calendar-event"></i>
          {% elif notif.notification_type == 'attendance' %}<i class="bi bi-person-check"></i>
          {% elif notif.notification_type == 'ticket' %}<i class="bi bi-ticket-perforated"></i>
          {% elif notif.notification_type == 'brushup' %}<i class="bi bi-arrow-repeat"></i>
          {% else %}<i class="bi bi-bell"></i>{% endif %}
        </div>

        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong class="{% if notif.is_read %}text-muted{% endif %}">{{ notif.title }}</strong>
              <span class="badge bg-secondary notif-badge ms-2">{{ notif.get_notification_type_display }}</span>
              {% with role=notif.user.profile.role %}
              {% if role == 'student' %}<span class="badge bg-info text-dark notif-badge ms-1">Student</span>
              {% elif role == 'teacher' %}<span class="badge bg-success notif-badge ms-1">Teacher</span>
              {% elif role == 'parent' %}<span class="badge bg-warning text-dark notif-badge ms-1">Parent</span>
              {% endif %}
              {% endwith %}
              {% if notif.is_read %}
                <span class="badge bg-light text-muted notif-badge ms-1">Read</span>
              {% else %}
                <span class="badge bg-primary notif-badge ms-1">Unread</span>
              {% endif %}
            </div>
            <small class="text-muted text-nowrap ms-2">{{ notif.created_at|date:"d M Y, H:i" }}</small>
          </div>
          <p class="mb-1 mt-1 {% if notif.is_read %}text-muted{% endif %}">{{ notif.message }}</p>
          <small class="text-muted">
            <i class="bi bi-person"></i> {{ notif.user.get_full_name }} ({{ notif.user.username }})
          </small>
        </div>

      </div>
      {% empty %}
      <div class="text-center text-muted py-5">
        <i class="bi bi-bell-slash fs-1"></i>
        <p class="mt-2">No notifications found.</p>
      </div>
      {% endfor %}

      <!-- Pagination -->
      {% if all_notifications.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center">
          {% if all_notifications.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ all_notifications.previous_page_number }}&role={{ role_filter }}">Previous</a>
            </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Page {{ all_notifications.number }} of {{ all_notifications.paginator.num_pages }}</span>
          </li>
          {% if all_notifications.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ all_notifications.next_page_number }}&role={{ role_filter }}">Next</a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </div>
  </div>

</div>

<script>
  // Auto-switch to All tab when clicked — marks unread as read via AJAX
  document.getElementById('all-tab-link')?.addEventListener('click', function () {
    fetch("{% url 'admin_mark_all_notifications_read' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    }).then(() => {
      // Update unread badge count to 0 visually
      document.querySelectorAll('.badge.bg-danger').forEach(b => b.remove());
    });
  });

  // Flash message dismiss
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(function (a) {
      bootstrap.Alert.getOrCreateInstance(a).close();
    });
  }, 8000);
</script>

{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\parent_confirm_delete.html
<<code:
{% extends 'base.html' %}
{% block title %}Delete Parent - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card border-danger shadow-sm">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Confirm Delete Parent</h5>
        </div>
        <div class="card-body">
          <p class="lead">Are you sure you want to delete parent <strong>{{ object.get_full_name }}</strong>?</p>

          {% if object.children.exists %}
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-circle"></i>
              <strong>Warning:</strong> This parent has
              <strong>{{ object.children.count }}</strong> linked student(s):
              <ul class="mb-0 mt-1">
                {% for child in object.children.all %}
                  <li>{{ child.user.get_full_name }} — Grade {{ child.grade }}{{ child.section }}</li>
                {% endfor %}
              </ul>
              They will no longer have a parent assigned after deletion.
            </div>
          {% endif %}

          <p class="text-muted">This action cannot be undone.</p>

          <form method="post">
            {% csrf_token %}
            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-danger px-4">
                <i class="bi bi-trash"></i> Yes, Delete Parent
              </button>
              <a href="{% url 'parent_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\parent_edit.html
<<code:
{% extends 'base.html' %}
{% block title %}Edit Parent - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil-square"></i> Edit Parent</h2>
    <a href="{% url 'parent_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Parents
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Parent Info Card -->
      <div class="card mb-3 border-warning">
        <div class="card-body d-flex align-items-center gap-3">
          {% if object.profile.profile_photo %}
            <img src="{{ object.profile.profile_photo.url }}" class="rounded-circle" width="60" height="60" style="object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center text-dark fw-bold" style="width:60px;height:60px;font-size:1.2rem;">
              {{ object.first_name|first }}{{ object.last_name|first }}
            </div>
          {% endif %}
          <div>
            <h5 class="mb-0">{{ object.get_full_name }}</h5>
            <small class="text-muted">{{ object.username }} · {{ object.email }}</small>
            <div class="mt-1">
              {% for child in object.children.all %}
                <span class="badge bg-info text-dark me-1">
                  {{ child.user.get_full_name }} ({{ child.grade }}{{ child.section }})
                </span>
              {% empty %}
                <span class="text-muted small">No children linked</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-pencil"></i> Edit Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">First Name</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Last Name</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Email</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-warning px-4 text-dark fw-semibold">
                <i class="bi bi-check-circle"></i> Save Changes
              </button>
              <a href="{% url 'parent_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\parent_form.html
<<code:
{% extends 'base.html' %}
{% block title %}Add Parent - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-plus"></i> Add New Parent</h2>
    <a href="{% url 'parent_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Parents
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-person-hearts"></i> Parent Account Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">First Name *</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Last Name *</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Username *</label>
              {{ form.username }}
              {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Email *</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Phone Number</label>
              {{ form.phone_number }}
              {% if form.phone_number.errors %}<div class="text-danger small">{{ form.phone_number.errors }}</div>{% endif %}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Password *</label>
                {{ form.password }}
                {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors }}</div>{% endif %}
                <small class="text-muted">Minimum 8 characters</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Confirm Password *</label>
                {{ form.confirm_password }}
                {% if form.confirm_password.errors %}<div class="text-danger small">{{ form.confirm_password.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="alert alert-info small">
              <i class="bi bi-info-circle"></i>
              After creating the parent, link them to their child by editing the student's profile.
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-warning px-4 text-dark fw-semibold">
                <i class="bi bi-check-circle"></i> Create Parent
              </button>
              <a href="{% url 'parent_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\parent_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Parents - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-person-hearts"></i> Parent Management</h2>
      <p class="text-muted mb-0">{{ parents|length }} parent(s) registered</p>
    </div>
    <a href="{% url 'parent_add' %}" class="btn btn-success">
      <i class="bi bi-person-plus"></i> Add Parent
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th><i class="bi bi-person"></i> Name</th>
              <th><i class="bi bi-envelope"></i> Email</th>
              <th><i class="bi bi-telephone"></i> Phone</th>
              <th><i class="bi bi-people"></i> Children</th>
              <th><i class="bi bi-currency-rupee"></i> Pending Fees</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for parent in parents %}
            <tr>
              <td class="text-muted small">{{ forloop.counter }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if parent.profile.profile_photo %}
                    <img src="{{ parent.profile.profile_photo.url }}" class="rounded-circle" width="35" height="35" style="object-fit:cover;">
                  {% else %}
                    <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center text-dark" style="width:35px;height:35px;font-size:0.85rem;">
                      {{ parent.first_name|first }}{{ parent.last_name|first }}
                    </div>
                  {% endif %}
                  <div>
                    <div class="fw-semibold">{{ parent.get_full_name }}</div>
                    <small class="text-muted">{{ parent.username }}</small>
                  </div>
                </div>
              </td>
              <td>{{ parent.email }}</td>
              <td>{{ parent.profile.phone_number|default:"—" }}</td>
              <td>
                {% for child in parent.children.all %}
                  <span class="badge bg-info text-dark me-1">
                    {{ child.user.get_full_name }} ({{ child.grade }}{{ child.section }})
                  </span>
                {% empty %}
                  <span class="text-muted small">No children linked</span>
                {% endfor %}
              </td>
              <td>
                {% if parent.profile.pending_amount > 0 %}
                  <span class="badge bg-danger">
                    ₹{{ parent.profile.pending_amount|floatformat:2 }}
                  </span>
                {% else %}
                  <span class="badge bg-success">Clear</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'parent_edit' parent.pk %}" class="btn btn-sm btn-warning me-1" title="Edit">
                  <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{% url 'parent_delete' parent.pk %}" class="btn btn-sm btn-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="bi bi-person-hearts fs-3"></i>
                <p class="mt-2">No parents found. <a href="{% url 'parent_add' %}">Add your first parent</a></p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\status_post_form.html
<<code:
{% extends 'base.html' %}
{% block title %}Post Status - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-megaphone"></i> Post Status / Announcement</h2>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-chat-square-text"></i> New Announcement</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-semibold">Message *</label>
              {{ form.content }}
              {% if form.content.errors %}<div class="text-danger small">{{ form.content.errors }}</div>{% endif %}
              <small class="text-muted">Max 500 characters</small>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Visible To *</label>
              {{ form.target_role }}
              {% if form.target_role.errors %}<div class="text-danger small">{{ form.target_role.errors }}</div>{% endif %}
            </div>

            <div class="mb-3 form-check">
              {{ form.is_pinned }}
              <label class="form-check-label fw-semibold">
                <i class="bi bi-pin"></i> Pin this announcement (shows at top)
              </label>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-send"></i> Post Announcement
              </button>
              <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>

      <!-- Recent Posts -->
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between">
          <strong>Recent Posts</strong>
          <a href="{% url 'status_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
          <p class="text-muted small">Visit <a href="{% url 'status_list' %}">Status List</a> to manage all posts.</p>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_confirm_delete.html
<<code:
{% extends 'base.html' %}
{% block title %}Delete Student - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card border-danger shadow-sm">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Confirm Delete Student</h5>
        </div>
        <div class="card-body">

          <div class="d-flex align-items-center gap-3 mb-3">
            {% if object.user.profile.profile_photo %}
              <img src="{{ object.user.profile.profile_photo.url }}" class="rounded-circle" width="50" height="50" style="object-fit:cover;">
            {% else %}
              <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center text-white fw-bold" style="width:50px;height:50px;">
                {{ object.user.first_name|first }}{{ object.user.last_name|first }}
              </div>
            {% endif %}
            <div>
              <h5 class="mb-0">{{ object.user.get_full_name }}</h5>
              <small class="text-muted">Roll: {{ object.roll_number }} &bull; Grade {{ object.grade }}{{ object.section }}</small>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle"></i>
            <strong>Warning:</strong> This will permanently delete:
            <ul class="mb-0 mt-1">
              <li>Student account and login</li>
              <li>All attendance records</li>
              <li>All submission records</li>
              <li>All subject enrolments</li>
              <li>All fee records</li>
            </ul>
          </div>

          <p class="text-muted">This action <strong>cannot be undone</strong>.</p>

          <form method="post">
            {% csrf_token %}
            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-danger px-4">
                <i class="bi bi-trash"></i> Yes, Delete Student
              </button>
              <a href="{% url 'student_detail' object.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_detail.html
<<code:
{% extends 'base.html' %}
{% block title %}{{ student.user.get_full_name }} - Student Detail{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
      {% if student.user.profile.profile_photo %}
        <img src="{{ student.user.profile.profile_photo.url }}" class="rounded-circle" width="60" height="60" style="object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white fw-bold" style="width:60px;height:60px;font-size:1.3rem;">
          {{ student.user.first_name|first }}{{ student.user.last_name|first }}
        </div>
      {% endif %}
      <div>
        <h2 class="mb-0">{{ student.user.get_full_name }}</h2>
        <small class="text-muted">
          Roll: <strong>{{ student.roll_number }}</strong> &bull;
          Grade: <strong>{{ student.grade }}{{ student.section }}</strong> &bull;
          {% if student.is_active %}
            <span class="badge bg-success">Active</span>
          {% else %}
            <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </small>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'student_edit' student.pk %}" class="btn btn-warning">
        <i class="bi bi-pencil"></i> Edit
      </a>
      <a href="{% url 'admin_student_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card text-center border-primary">
        <div class="card-body py-3">
          <div class="fs-3 fw-bold text-primary">{{ average_score }}%</div>
          <div class="text-muted small">Average Score</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center border-success">
        <div class="card-body py-3">
          <div class="fs-3 fw-bold text-success">{{ attendance_rate }}%</div>
          <div class="text-muted small">Attendance Rate</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center border-info">
        <div class="card-body py-3">
          <div class="fs-3 fw-bold text-info">{{ completed_assignments }}/{{ total_assignments }}</div>
          <div class="text-muted small">Assignments Done</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center border-warning">
        <div class="card-body py-3">
          <div class="fs-3 fw-bold text-warning">{{ roadmap_progress }}%</div>
          <div class="text-muted small">Roadmap Progress</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">

    <!-- Student Info -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header"><strong><i class="bi bi-person"></i> Student Info</strong></div>
        <div class="card-body">
          <table class="table table-sm table-borderless mb-0">
            <tr><td class="text-muted">Username</td><td>{{ student.user.username }}</td></tr>
            <tr><td class="text-muted">Email</td><td>{{ student.user.email }}</td></tr>
            <tr><td class="text-muted">Phone</td><td>{{ student.phone_number }}</td></tr>
            <tr><td class="text-muted">Address</td><td>{{ student.address }}</td></tr>
            <tr><td class="text-muted">Blood Group</td><td>{{ student.blood_group|default:"—" }}</td></tr>
            <tr><td class="text-muted">Admitted</td><td>{{ student.admission_date|date:"d M Y" }}</td></tr>
            <tr>
              <td class="text-muted">Parent</td>
              <td>
                {% if student.parent %}
                  {{ student.parent.get_full_name }}
                {% else %}
                  <span class="text-muted">Not assigned</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td class="text-muted">Subjects</td>
              <td>
                {% for st in student.subjects_taken.all %}
                  <span class="badge bg-info text-dark me-1">{{ st.subject.name }}</span>
                {% empty %}
                  <span class="text-muted">None</span>
                {% endfor %}
              </td>
            </tr>
            {% if student.medical_conditions %}
            <tr><td class="text-muted">Medical</td><td>{{ student.medical_conditions }}</td></tr>
            {% endif %}
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Submissions -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-journal-check"></i> Recent Submissions</strong></div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Assignment</th><th>Status</th><th>Score</th><th>Submitted</th></tr>
            </thead>
            <tbody>
              {% for sub in recent_submissions %}
              <tr>
                <td>{{ sub.assignment.title }}</td>
                <td>
                  {% if sub.status == 'graded' %}
                    <span class="badge bg-success">Graded</span>
                  {% elif sub.status == 'submitted' %}
                    <span class="badge bg-info">Submitted</span>
                  {% else %}
                    <span class="badge bg-secondary">Not Submitted</span>
                  {% endif %}
                </td>
                <td>
                  {% if sub.score is not None %}
                    {{ sub.score }}/{{ sub.assignment.max_score }}
                  {% else %}—{% endif %}
                </td>
                <td>
                  {% if sub.submitted_at %}
                    {{ sub.submitted_at|date:"d M Y" }}
                  {% else %}—{% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center text-muted py-3">No submissions yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Test Scores -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-clipboard-data"></i> Recent Test Scores</strong></div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Test</th><th>Score</th><th>Date</th></tr>
            </thead>
            <tbody>
              {% for score in recent_scores %}
              <tr>
                <td>{{ score.test_name }}</td>
                <td>{{ score.score }}/{{ score.max_score }}</td>
                <td>{{ score.date|date:"d M Y" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-center text-muted py-3">No test scores yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Comments -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-chat-left-text"></i> Teacher Comments</strong></div>
        <div class="card-body" style="max-height:300px;overflow-y:auto;">
          {% for comment in comments %}
          <div class="border-start border-3 border-primary ps-3 mb-3">
            <p class="mb-1">{{ comment.content }}</p>
            <small class="text-muted">
              {{ comment.author.get_full_name }} &bull; {{ comment.created_at|date:"d M Y" }}
            </small>
          </div>
          {% empty %}
          <p class="text-muted">No comments yet.</p>
          {% endfor %}

          <!-- Add Comment Form -->
          <hr>
          <p class="fw-semibold mb-2">Add Comment</p>
          <form method="post" action="{% url 'comment_add' student.user.pk %}">
            {% csrf_token %}
            {{ comment_form.content }}
            <button type="submit" class="btn btn-sm btn-primary mt-2">
              <i class="bi bi-send"></i> Post Comment
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Fees Status -->
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-currency-rupee"></i> Fee Status</strong>
          <a href="{% url 'admin:core_feesstatus_add' %}" class="btn btn-sm btn-outline-primary" target="_blank">
            Add Fee Record
          </a>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Month</th><th>Amount</th><th>Status</th><th>Due Date</th><th>Paid Date</th></tr>
            </thead>
            <tbody>
              {% for fee in student.fees.all|dictsortreversed:"month" %}
              <tr>
                <td>{{ fee.month }}</td>
                <td>₹{{ fee.fees }}</td>
                <td>
                  {% if fee.status == 'paid' %}
                    <span class="badge bg-success">Paid</span>
                  {% elif fee.status == 'overdue' %}
                    <span class="badge bg-danger">Overdue</span>
                  {% elif fee.status == 'waived' %}
                    <span class="badge bg-secondary">Waived</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Unpaid</span>
                  {% endif %}
                </td>
                <td>{{ fee.due_date|date:"d M Y" }}</td>
                <td>{{ fee.paid_date|date:"d M Y"|default:"—" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-3">No fee records yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_edit.html
<<code:
{% extends 'base.html' %}
{% block title %}Edit Student - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .subject-checkbox-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil-square"></i> Edit Student</h2>
    <div class="d-flex gap-2">
      <a href="{% url 'student_detail' object.pk %}" class="btn btn-outline-info">
        <i class="bi bi-eye"></i> View
      </a>
      <a href="{% url 'admin_student_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-9">

      <!-- Student Info Card -->
      <div class="card mb-3 border-primary">
        <div class="card-body d-flex align-items-center gap-3">
          {% if object.user.profile.profile_photo %}
            <img src="{{ object.user.profile.profile_photo.url }}" class="rounded-circle" width="55" height="55" style="object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white fw-bold" style="width:55px;height:55px;font-size:1.1rem;">
              {{ object.user.first_name|first }}{{ object.user.last_name|first }}
            </div>
          {% endif %}
          <div>
            <h5 class="mb-0">{{ object.user.get_full_name }}</h5>
            <small class="text-muted">
              {{ object.user.username }} &bull;
              Roll: <strong>{{ object.roll_number }}</strong> &bull;
              {{ object.user.email }}
            </small>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-pencil"></i> Edit Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- Academic -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3">Academic</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Grade *</label>
                <input type="text" name="grade" class="form-control" value="{{ object.grade }}" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Section *</label>
                <select name="section" class="form-control" required>
                  {% for val, label in SECTION_CHOICES %}
                    <option value="{{ val }}" {% if object.section == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Subjects -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Subjects Enrolled In</label>
              <div class="subject-checkbox-list">
                {% for subject in all_subjects %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="subjects"
                           value="{{ subject.pk }}" id="subj_{{ subject.pk }}"
                           {% if subject.pk in enrolled_ids %}checked{% endif %}>
                    <label class="form-check-label" for="subj_{{ subject.pk }}">
                      {{ subject.name }}
                      {% if subject.teacher %}
                        <small class="text-muted">({{ subject.teacher.get_full_name }})</small>
                      {% endif %}
                    </label>
                  </div>
                {% empty %}
                  <p class="text-muted small mb-0">No subjects available.</p>
                {% endfor %}
              </div>
              <small class="text-muted">Check/uncheck to update enrolments.</small>
            </div>

            <!-- Contact -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Contact</h6>
            <div class="mb-3">
              <label class="form-label fw-semibold">Phone Number</label>
              <input type="text" name="phone_number" id="edit_phone" class="form-control"
                     value="{{ object.phone_number }}" placeholder="00-00-00-0000">
              <small class="text-muted">Format: 00-00-00-0000</small>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Address</label>
              <textarea name="address" class="form-control" rows="3">{{ object.address }}</textarea>
            </div>

            <!-- Parent & Health -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Parent & Health</h6>
            <div class="mb-3">
              <label class="form-label fw-semibold">Parent</label>
              <select name="parent" class="form-control">
                <option value="">— No Parent —</option>
                {% for parent in parents %}
                  <option value="{{ parent.pk }}"
                    {% if object.parent and object.parent.pk == parent.pk %}selected{% endif %}>
                    {{ parent.get_full_name }} ({{ parent.username }})
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Blood Group</label>
                <select name="blood_group" class="form-control">
                  {% for val, label in BLOOD_GROUP_CHOICES %}
                    <option value="{{ val }}" {% if object.blood_group == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6 mb-3 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="is_active" id="is_active"
                         {% if object.is_active %}checked{% endif %}>
                  <label class="form-check-label fw-semibold" for="is_active">
                    Active Student
                  </label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Medical Conditions</label>
              <textarea name="medical_conditions" class="form-control" rows="2">{{ object.medical_conditions }}</textarea>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-warning px-4 text-dark fw-semibold">
                <i class="bi bi-check-circle"></i> Save Changes
              </button>
              <a href="{% url 'student_detail' object.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  // Phone number auto-formatting: 00-00-00-0000
  const phoneInput = document.getElementById('edit_phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function () {
      let val = this.value.replace(/\D/g, '');
      let formatted = '';
      if (val.length <= 2) {
        formatted = val;
      } else if (val.length <= 4) {
        formatted = val.slice(0, 2) + '-' + val.slice(2);
      } else if (val.length <= 6) {
        formatted = val.slice(0, 2) + '-' + val.slice(2, 4) + '-' + val.slice(4);
      } else {
        formatted = val.slice(0, 2) + '-' + val.slice(2, 4) + '-' + val.slice(4, 6) + '-' + val.slice(6, 10);
      }
      this.value = formatted;
    });
  }

  // Flash messages — 8 seconds
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(function (a) {
      bootstrap.Alert.getOrCreateInstance(a).close();
    });
  }, 8000);
</script>

{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_form.html
<<code:
{% extends 'base.html' %}
{% block title %}Add Student - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .subject-checkbox-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
  }
  .subject-checkbox-list .form-check {
    margin-bottom: 0.4rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-plus"></i> Add New Student</h2>
    <a href="{% url 'admin_student_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Students
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-9">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-person-badge"></i> Student Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- Account Details -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3">Account Details</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">First Name *</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Last Name *</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Username *</label>
                {{ form.username }}
                {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Email *</label>
                {{ form.email }}
                {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Password *</label>
                {{ form.password }}
                {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Confirm Password *</label>
                {{ form.confirm_password }}
                {% if form.confirm_password.errors %}<div class="text-danger small">{{ form.confirm_password.errors }}</div>{% endif %}
              </div>
            </div>

            <!-- Academic Details -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Academic Details</h6>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Roll Number</label>
                {{ form.roll_number }}
                <small class="text-muted">{{ form.roll_number.help_text }}</small>
                {% if form.roll_number.errors %}<div class="text-danger small">{{ form.roll_number.errors }}</div>{% endif %}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Grade *</label>
                {{ form.grade }}
                {% if form.grade.errors %}<div class="text-danger small">{{ form.grade.errors }}</div>{% endif %}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Section *</label>
                {{ form.section }}
                {% if form.section.errors %}<div class="text-danger small">{{ form.section.errors }}</div>{% endif %}
              </div>
            </div>

            <!-- Subjects -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Subjects Enrolled In</label>
              <div class="subject-checkbox-list">
                {% for checkbox in form.subjects %}
                  <div class="form-check">
                    {{ checkbox.tag }}
                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                      {{ checkbox.choice_label }}
                    </label>
                  </div>
                {% empty %}
                  <p class="text-muted small mb-0">
                    No subjects available.
                    <a href="{% url 'admin:core_subject_add' %}" target="_blank">Add subjects first</a>.
                  </p>
                {% endfor %}
              </div>
              <small class="text-muted">{{ form.subjects.help_text }}</small>
            </div>

            <!-- Contact Details -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Contact Details</h6>
            <div class="mb-3">
              <label class="form-label fw-semibold">Phone Number</label>
              {{ form.phone_number }}
              <small class="text-muted">{{ form.phone_number.help_text }}</small>
              {% if form.phone_number.errors %}<div class="text-danger small">{{ form.phone_number.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Address</label>
              {{ form.address }}
              <small class="text-muted">{{ form.address.help_text }}</small>
            </div>

            <!-- Parent & Health -->
            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Parent & Health</h6>
            <div class="mb-3">
              <label class="form-label fw-semibold">Parent</label>
              {{ form.parent }}
              {% if form.parent.errors %}<div class="text-danger small">{{ form.parent.errors }}</div>{% endif %}
              <small class="text-muted">
                Can't find the parent?
                <a href="{% url 'parent_add' %}" target="_blank">Create parent first</a>, then come back.
              </small>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Blood Group</label>
                {{ form.blood_group }}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Admission Date</label>
                {{ form.admission_date }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Medical Conditions</label>
              {{ form.medical_conditions }}
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-circle"></i> Add Student
              </button>
              <a href="{% url 'admin_student_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // Phone number auto-formatting: 00-000-000-000
  const phoneInput = document.getElementById('id_phone_number');
  if (phoneInput) {
    phoneInput.addEventListener('input', function () {
      let val = this.value.replace(/\D/g, '');
      let formatted = '';
      if (val.length <= 2) {
        formatted = val;
      } else if (val.length <= 5) {
        formatted = val.slice(0, 2) + '-' + val.slice(2);
      } else if (val.length <= 8) {
        formatted = val.slice(0, 2) + '-' + val.slice(2, 5) + '-' + val.slice(5);
      } else {
        formatted = val.slice(0, 2) + '-' + val.slice(2, 5) + '-' + val.slice(5, 8) + '-' + val.slice(8, 11);
      }
      this.value = formatted;
    });
  }

  // Keep flash messages visible for 8 seconds
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(function (alert) {
      bootstrap.Alert.getOrCreateInstance(alert).close();
    });
  }, 8000);
</script>

{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_grid.html
<<code:
{% extends 'base.html' %}
{% block title %}Student Grid - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-grid-3x3-gap"></i> Student Grid Report</h2>
      <p class="text-muted mb-0">Performance overview of all students</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Filters -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Grade</label>
          <select name="grade" class="form-control">
            <option value="">All Grades</option>
            {% for grade in grades %}
              <option value="{{ grade }}" {% if grade == grade_filter %}selected{% endif %}>Grade {{ grade }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Section</label>
          <select name="section" class="form-control">
            <option value="">All Sections</option>
            <option value="A" {% if section_filter == 'A' %}selected{% endif %}>A</option>
            <option value="B" {% if section_filter == 'B' %}selected{% endif %}>B</option>
            <option value="C" {% if section_filter == 'C' %}selected{% endif %}>C</option>
            <option value="D" {% if section_filter == 'D' %}selected{% endif %}>D</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Search</label>
          <input type="text" name="search" class="form-control" placeholder="Name or Roll No..." value="{{ search }}">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-funnel"></i> Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Grid -->
  <div class="row g-3">
    {% for item in students_data %}
    <div class="col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm {% if item.attendance_rate < 75 %}border-danger{% elif item.average_score < 40 %}border-warning{% else %}border-success{% endif %}">
        <div class="card-body text-center pb-2">
          {% if item.student.user.profile.profile_photo %}
            <img src="{{ item.student.user.profile.profile_photo.url }}" class="rounded-circle mb-2" width="50" height="50" style="object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white fw-bold mx-auto mb-2" style="width:50px;height:50px;">
              {{ item.student.user.first_name|first }}{{ item.student.user.last_name|first }}
            </div>
          {% endif %}
          <h6 class="mb-0 fw-semibold">{{ item.student.user.get_full_name }}</h6>
          <small class="text-muted">{{ item.student.roll_number }} &bull; Grade {{ item.student.grade }}{{ item.student.section }}</small>
        </div>
        <div class="card-body pt-2">
          <!-- Avg Score Bar -->
          <div class="mb-2">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Avg Score</small>
              <small class="fw-semibold">{{ item.average_score }}%</small>
            </div>
            <div class="progress" style="height:6px;">
              <div class="progress-bar {% if item.average_score >= 75 %}bg-success{% elif item.average_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                   style="width:{{ item.average_score }}%"></div>
            </div>
          </div>
          <!-- Attendance Bar -->
          <div class="mb-2">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Attendance</small>
              <small class="fw-semibold">{{ item.attendance_rate }}%</small>
            </div>
            <div class="progress" style="height:6px;">
              <div class="progress-bar {% if item.attendance_rate >= 75 %}bg-success{% elif item.attendance_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                   style="width:{{ item.attendance_rate }}%"></div>
            </div>
          </div>
          <div class="d-flex justify-content-between text-muted small mt-2">
            <span><i class="bi bi-journal-check"></i> {{ item.graded }}/{{ item.total_assignments }}</span>
            <span><i class="bi bi-clock"></i> {{ item.pending }} pending</span>
          </div>
        </div>
        <div class="card-footer p-2 text-center">
          <a href="{% url 'student_detail' item.student.pk %}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-eye"></i> View
          </a>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center text-muted py-5">
      <i class="bi bi-people fs-1"></i>
      <p class="mt-2">No students match your filters.</p>
    </div>
    {% endfor %}
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\student_list.html
<<code:
{% extends 'base.html' %}
{% load dict_extras %}
{% block title %}Students - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-people"></i> Student Management</h2>
      <p class="text-muted mb-0">{{ students|length }} student(s) registered</p>
    </div>
    <a href="{% url 'student_add' %}" class="btn btn-success">
      <i class="bi bi-person-plus"></i> Add Student
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th><i class="bi bi-person"></i> Name</th>
              <th><i class="bi bi-hash"></i> Roll No</th>
              <th><i class="bi bi-bookmark"></i> Grade</th>
              <th><i class="bi bi-book"></i> Subjects</th>
              <th><i class="bi bi-telephone"></i> Phone</th>
              <th><i class="bi bi-person-hearts"></i> Parent</th>
              <th><i class="bi bi-circle"></i> Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <td class="text-muted small">{{ forloop.counter }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if student.user.profile.profile_photo %}
                    <img src="{{ student.user.profile.profile_photo.url }}" class="rounded-circle" width="35" height="35" style="object-fit:cover;">
                  {% else %}
                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white" style="width:35px;height:35px;font-size:0.85rem;">
                      {{ student.user.first_name|first }}{{ student.user.last_name|first }}
                    </div>
                  {% endif %}
                  <div>
                    <div class="fw-semibold">{{ student.user.get_full_name }}</div>
                    <small class="text-muted">{{ student.user.email }}</small>
                  </div>
                </div>
              </td>
              <td><span class="badge bg-secondary">{{ student.roll_number }}</span></td>
              <td><span class="badge bg-primary">{{ student.grade }}{{ student.section }}</span></td>
              <td>
                {% for st in student.subjects_taken.all %}
                  <span class="badge bg-info text-dark me-1">{{ st.subject.name }}</span>
                {% empty %}
                  <span class="text-muted small">—</span>
                {% endfor %}
              </td>
              <td>{{ student.phone_number }}</td>
              <td>
                {% if student.parent %}
                  <i class="bi bi-check-circle text-success"></i> {{ student.parent.get_full_name }}
                {% else %}
                  <span class="badge bg-warning text-dark">No Parent</span>
                {% endif %}
              </td>
              <td>
                {% if student.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-danger">Inactive</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'student_detail' student.pk %}" class="btn btn-sm btn-info me-1">
  			<i class="bi bi-eye"></i>
		</a>
                <a href="{% url 'student_edit' student.pk %}" class="btn btn-sm btn-warning me-1">
  			<i class="bi bi-pencil"></i>
		</a>
                <a href="{% url 'student_delete' student.pk %}" class="btn btn-sm btn-danger">
  			<i class="bi bi-trash"></i>
		</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                <i class="bi bi-people fs-3"></i>
                <p class="mt-2">No students found. <a href="{% url 'student_add' %}">Add your first student</a></p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_attendance.html
<<code:
{% extends 'base.html' %}
{% block title %}Teacher Attendance - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-person-check"></i> Teacher Attendance</h2>
      <p class="text-muted mb-0">Mark and view teacher attendance records</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row g-4">

    <!-- Left: Mark Attendance -->
    <div class="col-md-5">

      <!-- Single -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-pencil-square"></i> Mark Individual</h6>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="single">
            <div class="mb-3">
              <label class="form-label fw-semibold">Date</label>
              <input type="date" name="date" class="form-control" value="{{ today }}" max="{{ today }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Teacher</label>
              <select name="teacher_id" class="form-control" required>
                <option value="">— Select Teacher —</option>
                {% for t in teachers %}
                  <option value="{{ t.pk }}">{{ t.user.get_full_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Status</label>
              <select name="status" class="form-control" required>
                <option value="present">✅ Present</option>
                <option value="absent">❌ Absent</option>
                <option value="late">🕐 Late</option>
                <option value="half_day">🌓 Half Day</option>
                <option value="excused">📋 Excused</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Notes</label>
              <textarea name="notes" class="form-control" rows="2" placeholder="Optional reason"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> Save
            </button>
          </form>
        </div>
      </div>

      <!-- Bulk -->
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-people"></i> Bulk Mark for Today</h6>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk">
            <input type="hidden" name="date" value="{{ today }}">
            <table class="table table-sm align-middle mb-3">
              <thead class="table-light">
                <tr><th>Teacher</th><th>Status</th></tr>
              </thead>
              <tbody>
                {% for t in teachers %}
                <tr>
                  <td class="small fw-semibold">{{ t.user.get_full_name }}</td>
                  <td>
                    <select name="status_{{ t.pk }}" class="form-select form-select-sm">
                      <option value="present">Present</option>
                      <option value="absent">Absent</option>
                      <option value="late">Late</option>
                      <option value="half_day">Half Day</option>
                      <option value="excused">Excused</option>
                    </select>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-check2-all"></i> Mark All for Today
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Right: Stats + Records -->
    <div class="col-md-7">

      <!-- Rate cards -->
      <div class="row g-2 mb-3">
        {% for stat in teacher_stats %}
        <div class="col-6 col-md-4">
          <div class="card shadow-sm text-center border-0">
            <div class="card-body py-2">
              <div class="fw-semibold small">{{ stat.name }}</div>
              <div class="fs-5 fw-bold {% if stat.rate >= 90 %}text-success{% elif stat.rate >= 75 %}text-warning{% else %}text-danger{% endif %}">
                {{ stat.rate }}%
              </div>
              <div class="progress mt-1" style="height:5px;">
                <div class="progress-bar {% if stat.rate >= 90 %}bg-success{% elif stat.rate >= 75 %}bg-warning{% else %}bg-danger{% endif %}"
                     style="width:{{ stat.rate }}%"></div>
              </div>
              <small class="text-muted">{{ stat.present }}/{{ stat.total }} days</small>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Filter -->
      <div class="card mb-3">
        <div class="card-body py-2">
          <form method="get" class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label fw-semibold small">Teacher</label>
              <select name="teacher_filter" class="form-control form-control-sm">
                <option value="">All Teachers</option>
                {% for t in teachers %}
                  <option value="{{ t.pk }}" {% if teacher_filter == t.pk|stringformat:"s" %}selected{% endif %}>
                    {{ t.user.get_full_name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold small">Month</label>
              <input type="month" name="month_filter" class="form-control form-control-sm" value="{{ month_filter }}">
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-funnel"></i> Filter</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Records -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-table"></i> Records</strong>
          <span class="badge bg-secondary">{{ records|length }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:420px;overflow-y:auto;">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-dark sticky-top">
                <tr><th>Date</th><th>Teacher</th><th>Status</th><th>Notes</th><th>Marked By</th></tr>
              </thead>
              <tbody>
                {% for r in records %}
                <tr>
                  <td>{{ r.date|date:"d M Y" }}</td>
                  <td class="fw-semibold">{{ r.teacher.user.get_full_name }}</td>
                  <td>
                    {% if r.status == 'present' %}<span class="badge bg-success">Present</span>
                    {% elif r.status == 'absent' %}<span class="badge bg-danger">Absent</span>
                    {% elif r.status == 'late' %}<span class="badge bg-warning text-dark">Late</span>
                    {% elif r.status == 'half_day' %}<span class="badge bg-info text-dark">Half Day</span>
                    {% elif r.status == 'excused' %}<span class="badge bg-secondary">Excused</span>
                    {% endif %}
                  </td>
                  <td><small class="text-muted">{{ r.notes|default:"—"|truncatechars:40 }}</small></td>
                  <td><small class="text-muted">{{ r.marked_by.get_full_name }}</small></td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-3">No records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(a => bootstrap.Alert.getOrCreateInstance(a).close());
  }, 8000);
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_confirm_delete.html
<<code:
{% extends 'base.html' %}
{% block title %}Delete Teacher - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card border-danger shadow-sm">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Confirm Delete Teacher</h5>
        </div>
        <div class="card-body">
          <p class="lead">Are you sure you want to delete teacher <strong>{{ object.get_full_name }}</strong>?</p>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle"></i>
            <strong>Warning:</strong> This will permanently delete the teacher's account.
            Their subjects will become <strong>Unassigned</strong> (not deleted).
          </div>

          <form method="post">
            {% csrf_token %}
            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-danger px-4">
                <i class="bi bi-trash"></i> Yes, Delete Teacher
              </button>
              <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_edit.html
<<code:
{% extends 'base.html' %}
{% block title %}Edit Teacher - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil-square"></i> Edit Teacher</h2>
    <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Teachers
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Teacher Info Card -->
      <div class="card mb-3 border-success">
        <div class="card-body d-flex align-items-center gap-3">
          {% if object.profile.profile_photo %}
            <img src="{{ object.profile.profile_photo.url }}" class="rounded-circle" width="60" height="60" style="object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white fw-bold" style="width:60px;height:60px;font-size:1.2rem;">
              {{ object.first_name|first }}{{ object.last_name|first }}
            </div>
          {% endif %}
          <div>
            <h5 class="mb-0">{{ object.get_full_name }}</h5>
            <small class="text-muted">{{ object.username }} · {{ object.email }}</small>
            <div class="mt-1">
              {% for subject in object.profile.subjects.all %}
                <span class="badge bg-info text-dark me-1">{{ subject.name }}</span>
              {% empty %}
                <span class="text-muted small">No subjects assigned</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-pencil"></i> Edit Basic Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">First Name</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Last Name</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">Email</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div class="alert alert-info small">
              <i class="bi bi-info-circle"></i>
              To update salary, qualification or subjects, use
              <a href="{% url 'admin:core_teacherprofile_changelist' %}" target="_blank">Admin → Teacher Profiles</a>
              and
              <a href="{% url 'admin:core_subject_changelist' %}" target="_blank">Admin → Subjects</a>.
            </div>

            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-warning px-4">
                <i class="bi bi-check-circle"></i> Save Changes
              </button>
              <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_form.html
<<code:
{% extends 'base.html' %}
{% block title %}Add Teacher - EduTrack Admin{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-plus"></i> Add New Teacher</h2>
    <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Teachers
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-mortarboard"></i> Teacher Details</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3">Account Details</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">First Name *</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Last Name *</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Username *</label>
              {{ form.username }}
              {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Email *</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Password *</label>
              {{ form.password }}
              <small class="text-muted">Minimum 8 characters</small>
            </div>

            <h6 class="text-muted fw-semibold border-bottom pb-2 mb-3 mt-2">Professional Details</h6>
            <div class="mb-3">
              <label class="form-label fw-semibold">Subject Specialty</label>
              {{ form.subject_specialty }}
              <small class="text-muted">
                Assign subjects via
                <a href="{% url 'admin:core_subject_changelist' %}" target="_blank">Admin → Subjects</a>
                after creation.
              </small>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold"><i class="bi bi-currency-rupee"></i> Monthly Salary (₹) *</label>
                {{ form.salary }}
                {% if form.salary.errors %}<div class="text-danger small">{{ form.salary.errors }}</div>{% endif %}
                <small class="text-muted">{{ form.salary.help_text }}</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Qualification</label>
                {{ form.qualification }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Joining Date</label>
              {{ form.joining_date }}
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-check-circle"></i> Create Teacher
              </button>
              <a href="{% url 'teacher_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(function (a) {
      bootstrap.Alert.getOrCreateInstance(a).close();
    });
  }, 8000);
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Teachers - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-mortarboard"></i> Teacher Management</h2>
      <p class="text-muted mb-0">{{ teachers|length }} teacher(s) registered</p>
    </div>
    <a href="{% url 'teacher_add' %}" class="btn btn-success">
      <i class="bi bi-person-plus"></i> Add Teacher
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th><i class="bi bi-person"></i> Name</th>
              <th><i class="bi bi-envelope"></i> Email</th>
              <th><i class="bi bi-book"></i> Subjects</th>
              <th><i class="bi bi-currency-rupee"></i> Salary</th>
              <th><i class="bi bi-award"></i> Qualification</th>
              <th><i class="bi bi-calendar"></i> Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for teacher in teachers %}
            <tr>
              <td class="text-muted small">{{ forloop.counter }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if teacher.profile.profile_photo %}
                    <img src="{{ teacher.profile.profile_photo.url }}" class="rounded-circle" width="35" height="35" style="object-fit:cover;">
                  {% else %}
                    <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white" style="width:35px;height:35px;font-size:0.85rem;">
                      {{ teacher.first_name|first }}{{ teacher.last_name|first }}
                    </div>
                  {% endif %}
                  <div>
                    <div class="fw-semibold">{{ teacher.get_full_name }}</div>
                    <small class="text-muted">{{ teacher.username }}</small>
                  </div>
                </div>
              </td>
              <td>{{ teacher.email }}</td>
              <td>
                {% for subject in teacher.profile.subjects.all %}
                  <span class="badge bg-info text-dark me-1">{{ subject.name }}</span>
                {% empty %}
                  <span class="text-muted small">— Not assigned —</span>
                {% endfor %}
              </td>
              <td>
                {% if teacher.profile.teacher_profile %}
                  <span class="fw-semibold text-success">
                    ₹{{ teacher.profile.teacher_profile.salary|floatformat:2 }}
                  </span>
                {% else %}
                  <span class="text-muted small">— Not set —</span>
                {% endif %}
              </td>
              <td>
                {% if teacher.profile.teacher_profile %}
                  {{ teacher.profile.teacher_profile.get_qualification_display }}
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td>
                {% if teacher.profile.teacher_profile.joining_date %}
                  {{ teacher.profile.teacher_profile.joining_date|date:"d M Y" }}
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'teacher_edit' teacher.pk %}" class="btn btn-sm btn-warning me-1" title="Edit">
                  <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{% url 'teacher_delete' teacher.pk %}" class="btn btn-sm btn-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-mortarboard fs-3"></i>
                <p class="mt-2">No teachers found. <a href="{% url 'teacher_add' %}">Add your first teacher</a></p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\teacher_performance.html
<<code:
{% extends 'base.html' %}
{% block title %}Teacher Performance - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .perf-card { border-left: 4px solid #667eea; border-radius: 8px; }
  .metric-box { border-radius: 8px; background: #f8f9fa; padding: 10px; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-mortarboard"></i> Teacher Performance</h2>
      <p class="text-muted mb-0">Tests scheduled, grading speed, topics covered, student progress</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>

  {% if not teacher_data %}
  <div class="text-center text-muted py-5">
    <i class="bi bi-mortarboard fs-1"></i>
    <p class="mt-2">No teacher data available yet.</p>
  </div>
  {% endif %}

  {% for t in teacher_data %}
  <div class="card shadow-sm perf-card mb-4">
    <div class="card-header d-flex align-items-center gap-3">
      <!-- Avatar -->
      {% if t.teacher.profile.profile_photo %}
        <img src="{{ t.teacher.profile.profile_photo.url }}" class="rounded-circle" width="48" height="48" style="object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white fw-bold"
             style="width:48px;height:48px;">
          {{ t.teacher.first_name|first }}{{ t.teacher.last_name|first }}
        </div>
      {% endif %}
      <div>
        <h5 class="mb-0 fw-bold">{{ t.teacher.get_full_name }}</h5>
        <small class="text-muted">
          {% for subj in t.subjects %}<span class="badge bg-info text-dark me-1">{{ subj }}</span>{% endfor %}
          {% if t.qualification %}<span class="badge bg-secondary">{{ t.qualification }}</span>{% endif %}
        </small>
      </div>
      <!-- Overall score badge -->
      <div class="ms-auto text-end">
        <div class="fs-4 fw-bold
          {% if t.overall_score >= 80 %}text-success
          {% elif t.overall_score >= 60 %}text-warning
          {% else %}text-danger{% endif %}">
          {{ t.overall_score }}%
        </div>
        <small class="text-muted">Overall Performance</small>
      </div>
    </div>

    <div class="card-body">
      <div class="row g-3">

        <!-- Metrics -->
        <div class="col-md-8">
          <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-primary">{{ t.total_assignments }}</div>
                <small class="text-muted">Assignments Set</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-success">{{ t.graded_count }}</div>
                <small class="text-muted">Graded</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-warning">{{ t.pending_count }}</div>
                <small class="text-muted">Pending Review</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-info">{{ t.avg_grading_days }} days</div>
                <small class="text-muted">Avg Grading Time</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-primary">{{ t.total_topics }}</div>
                <small class="text-muted">Total Topics</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-success">{{ t.completed_topics }}</div>
                <small class="text-muted">Completed</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-warning">{{ t.tests_scheduled }}</div>
                <small class="text-muted">Tests Scheduled</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-box">
                <div class="fs-4 fw-bold text-danger">{{ t.avg_student_score }}%</div>
                <small class="text-muted">Avg Student Score</small>
              </div>
            </div>
          </div>

          <!-- Progress bars -->
          <div class="mb-2">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Grading Rate</small>
              <small class="fw-semibold">{{ t.grading_rate }}%</small>
            </div>
            <div class="progress" style="height:8px;">
              <div class="progress-bar {% if t.grading_rate >= 80 %}bg-success{% elif t.grading_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                   style="width:{{ t.grading_rate }}%"></div>
            </div>
          </div>
          <div class="mb-2">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Roadmap Completion</small>
              <small class="fw-semibold">{{ t.roadmap_pct }}%</small>
            </div>
            <div class="progress" style="height:8px;">
              <div class="progress-bar {% if t.roadmap_pct >= 80 %}bg-success{% elif t.roadmap_pct >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                   style="width:{{ t.roadmap_pct }}%"></div>
            </div>
          </div>
          <div class="mb-2">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Student Average Score</small>
              <small class="fw-semibold">{{ t.avg_student_score }}%</small>
            </div>
            <div class="progress" style="height:8px;">
              <div class="progress-bar {% if t.avg_student_score >= 75 %}bg-success{% elif t.avg_student_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                   style="width:{{ t.avg_student_score }}%"></div>
            </div>
          </div>
        </div>

        <!-- Student Progress Cards -->
        <div class="col-md-4">
          <small class="text-muted fw-semibold d-block mb-2">Student Progress</small>
          <div style="max-height:230px;overflow-y:auto;">
            {% for student in t.students %}
            <div class="d-flex align-items-center gap-2 mb-2">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <small class="fw-semibold">{{ student.name }}</small>
                  <small>{{ student.score }}%</small>
                </div>
                <div class="progress" style="height:5px;">
                  <div class="progress-bar {% if student.score >= 75 %}bg-success{% elif student.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                       style="width:{{ student.score }}%"></div>
                </div>
              </div>
            </div>
            {% empty %}
            <small class="text-muted">No graded submissions yet.</small>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>
  </div>
  {% endfor %}

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\admin\ticket_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Open Tickets - EduTrack Admin{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-ticket-perforated"></i> Assignment Tickets</h2>
      <p class="text-muted mb-0">All tickets raised by students for offline submissions</p>
    </div>
    <a href="{% url 'admin_notifications' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Notifications
    </a>
  </div>

  <!-- Status filter pills -->
  <div class="d-flex gap-2 mb-3 flex-wrap">
    <a href="?status=" class="btn btn-sm {% if not status_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">
      All ({{ all_count }})
    </a>
    <a href="?status=open" class="btn btn-sm {% if status_filter == 'open' %}btn-danger{% else %}btn-outline-danger{% endif %}">
      Open ({{ open_count }})
    </a>
    <a href="?status=acknowledged" class="btn btn-sm {% if status_filter == 'acknowledged' %}btn-warning{% else %}btn-outline-warning{% endif %}">
      Acknowledged ({{ ack_count }})
    </a>
    <a href="?status=verified" class="btn btn-sm {% if status_filter == 'verified' %}btn-success{% else %}btn-outline-success{% endif %}">
      Verified ({{ verified_count }})
    </a>
    <a href="?status=rejected" class="btn btn-sm {% if status_filter == 'rejected' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
      Rejected ({{ rejected_count }})
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Student</th>
              <th>Assignment</th>
              <th>Method</th>
              <th>Details</th>
              <th>Status</th>
              <th>Teacher Response</th>
              <th>Raised</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr>
              <td class="text-muted small">{{ ticket.id }}</td>
              <td>
                <div class="fw-semibold">{{ ticket.student.user.get_full_name }}</div>
                <small class="text-muted">{{ ticket.student.roll_number }}</small>
              </td>
              <td>
                <div>{{ ticket.assignment.title }}</div>
                <small class="text-muted">Grade {{ ticket.assignment.grade }}</small>
              </td>
              <td>
                {% if ticket.submission_method == 'email' %}
                  <span class="badge bg-primary"><i class="bi bi-envelope"></i> Email</span>
                {% elif ticket.submission_method == 'whatsapp' %}
                  <span class="badge bg-success"><i class="bi bi-whatsapp"></i> WhatsApp</span>
                {% else %}
                  <span class="badge bg-secondary"><i class="bi bi-box-seam"></i> Physical</span>
                {% endif %}
              </td>
              <td>
                <span class="text-muted small">{{ ticket.details|truncatechars:60 }}</span>
              </td>
              <td>
                {% if ticket.status == 'open' %}
                  <span class="badge bg-danger">Open</span>
                {% elif ticket.status == 'acknowledged' %}
                  <span class="badge bg-warning text-dark">Acknowledged</span>
                {% elif ticket.status == 'verified' %}
                  <span class="badge bg-success">Verified</span>
                {% elif ticket.status == 'rejected' %}
                  <span class="badge bg-secondary">Rejected</span>
                {% else %}
                  <span class="badge bg-info text-dark">{{ ticket.get_status_display }}</span>
                {% endif %}
              </td>
              <td>
                {% if ticket.teacher_response %}
                  <span class="text-muted small">{{ ticket.teacher_response|truncatechars:50 }}</span>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td>
                <small>{{ ticket.created_at|date:"d M Y" }}</small><br>
                <small class="text-muted">{{ ticket.created_at|timesince }} ago</small>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-ticket-perforated fs-2"></i>
                <p class="mt-2">No tickets found.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\base.html
<<code:
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}EduTrack{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  {% block extra_css %}{% endblock %}
	<style>
		select.form-select.d-inline-block {
     		display: inline-block !important;
     		width: auto !important;
     		margin-right: 4px;
  		 				}
 	</style>

</head>
<body>

  <!-- Navbar -->
  {% if user.is_authenticated %}
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg,#667eea,#764ba2)">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">
        <i class="bi bi-mortarboard-fill"></i> EduTrack
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">

          {% if user.profile.role == 'admin' or user.is_superuser %}
          <li class="nav-item"><a class="nav-link" href="{% url 'admin_dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Administrative</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{% url 'admin_teacher_attendance' %}"><i class="bi bi-person-check"></i> Attendance</a></li>
              <li><a class="dropdown-item" href="{% url 'admin_finance' %}"><i class="bi bi-cash-stack"></i> Finance</a></li>
              <li><a class="dropdown-item" href="{% url 'admin_teacher_performance' %}"><i class="bi bi-graph-up"></i> Performance</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="{% url 'all_roadmaps' %}"><i class="bi bi-map"></i> Roadmaps</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'holiday_list' %}"><i class="bi bi-calendar-event"></i> Holidays</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'admin_analytics' %}"><i class="bi bi-bar-chart"></i> Analytics</a></li>

          {% elif user.profile.role == 'teacher' %}
          <li class="nav-item"><a class="nav-link" href="{% url 'teacher_dashboard' %}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'assignment_list' %}">Assignments</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'student_list' %}">Students</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'roadmap_list' %}">Roadmap</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'mark_attendance' %}">Attendance</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'teacher_tickets' %}">Tickets</a></li>

          {% elif user.profile.role == 'parent' %}
          <li class="nav-item"><a class="nav-link" href="{% url 'parent_dashboard' %}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'public_roadmaps' %}">Roadmaps</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'parent_feedback' %}">Feedback</a></li>

          {% elif user.profile.role == 'student' %}
          <li class="nav-item"><a class="nav-link" href="{% url 'student_dashboard' %}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'student_assignments' %}">Assignments</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'student_roadmap' %}">Roadmap</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'student_progress' %}">Progress</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'ticket_list' %}">Tickets</a></li>
          {% endif %}

        </ul>

        <!-- Notifications + Profile -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link position-relative" {% if request.user.profile.role == 'admin' %}
							href="{% url 'admin_notifications' %}"
						{% else %}
							href="{% url 'notifications' %}"
						{% endif %}>
              <i class="bi bi-bell"></i>
              <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown">
              {% if user.profile.profile_photo %}
                <img src="{{ user.profile.profile_photo.url }}" class="rounded-circle" width="28" height="28" style="object-fit:cover;">
              {% else %}
                <i class="bi bi-person-circle"></i>
              {% endif %}
              {{ user.get_full_name|default:user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'profile_detail' %}"><i class="bi bi-person"></i> Profile</a></li>
              <li><a class="dropdown-item" href="{% url 'profile_update' %}"><i class="bi bi-pencil"></i> Edit Profile</a></li>
              <li><a class="dropdown-item" href="{% url 'password_change' %}"><i class="bi bi-key"></i> Change Password</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  {% endif %}

  <!-- Messages -->
  {% if messages %}
  <div class="container-fluid pt-3 px-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
	<script>
  		document.addEventListener('DOMContentLoaded', function () {
    			setTimeout(function () {
      				document.querySelectorAll('.alert').forEach(function (alert) {
        			if (bootstrap && bootstrap.Alert) {
          				bootstrap.Alert.getOrCreateInstance(alert).close();
        					}
      											});
    					}, 8000);
  									});
	</script>

  <!-- Main Content -->
  <div class="container-fluid py-4 px-4">
    {% block content %}{% endblock %}
  </div>

  <footer class="footer mt-auto py-3 bg-light">
    <div class="container text-center">
      <span class="text-muted">© 2024 EduTrack — Education Management System</span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/main.js' %}"></script>

  <script>
    // Notification count polling
    function refreshNotifCount() {
      fetch('/api/notifications/count/')
        .then(r => r.json())
        .then(data => {
          const badge = document.getElementById('notif-badge');
          if (data.unread_count > 0) {
            badge.textContent = data.unread_count;
            badge.classList.remove('d-none');
          } else {
            badge.classList.add('d-none');
          }
        }).catch(() => {});
    }
    {% if user.is_authenticated %}
    refreshNotifCount();
    setInterval(refreshNotifCount, 60000);
    {% endif %}
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\login.html
<<code:
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - EduTrack</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-card {
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.6s ease;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        .login-header i {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .login-body {
            padding: 40px;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .demo-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="card shadow-lg border-0">
            <div class="login-header">
                <i class="bi bi-mortarboard-fill"></i>
                <h2 class="mb-0">EduTrack</h2>
                <p class="mb-0"><small>Education Management System</small></p>
            </div>
            
            <div class="login-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" id="loginForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="bi bi-person"></i> Username
                        </label>
                        <input type="text" class="form-control" id="username" name="username" 
                               placeholder="Enter your username" required autofocus>
                    </div>
                    
                    <div class="mb-4">
                        <label for="password" class="form-label">
                            <i class="bi bi-lock"></i> Password
                        </label>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-login w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </button>
                </form>

                <div class="demo-info">
                    <strong><i class="bi bi-info-circle"></i> Demo Credentials:</strong>
                    <div class="mt-2">
                        <small>
                            <strong>Teacher:</strong> teacher1 / demo123<br>
                            <strong>Student:</strong> student1 / demo123<br>
                            <strong>Parent:</strong> parent1 / demo123
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add loading state to login button
        document.getElementById('loginForm').addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Logging in...';
            btn.disabled = true;
        });
    </script>
</body>
</html>
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\notifications\notification_list.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Notifications</h2>
    
    <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="unread-tab" data-toggle="tab" href="#unread" role="tab">Unread</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="all-tab" data-toggle="tab" href="#all" role="tab">All</a>
        </li>
    </ul>
    
    <div class="tab-content" id="notificationTabContent">
        <div class="tab-pane fade show active" id="unread" role="tabpanel">
            {% for notification in unread_notifications %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5>{{ notification.title }}</h5>
                    <p>{{ notification.message }}</p>
                    <small>{{ notification.created_at|timesince }} ago</small>
                    <a href="{% url 'mark_notification_read' notification.id %}" class="btn btn-sm btn-primary float-right">Mark as Read</a>
                </div>
            </div>
            {% empty %}
            <p>No unread notifications</p>
            {% endfor %}
        </div>
        
        <div class="tab-pane fade" id="all" role="tabpanel">
            {% for notification in all_notifications %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5>{{ notification.title }}</h5>
                    <p>{{ notification.message }}</p>
                    <small>{{ notification.created_at|date }}</small>
                    <span class="badge badge-{% if notification.is_read %}secondary{% else %}primary{% endif %} float-right">
                        {% if notification.is_read %}Read{% else %}Unread{% endif %}
                    </span>
                </div>
            </div>
            {% empty %}
            <p>No notifications</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\assignment_status.html
<<code:
{% extends 'parent/base_parent.html' %}

{% block parent_content %}
<div class="container">
    <h2>{{ student.user.get_full_name }}'s Assignments</h2>
    
    <ul class="nav nav-tabs" id="assignmentTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pending-tab" data-toggle="tab" href="#pending" role="tab">Pending</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="completed-tab" data-toggle="tab" href="#completed" role="tab">Completed</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="overdue-tab" data-toggle="tab" href="#overdue" role="tab">Overdue</a>
        </li>
    </ul>
    
    <div class="tab-content" id="assignmentTabContent">
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            {% for submission in pending_submissions %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5>{{ submission.assignment.title }}</h5>
                    <p>Due: {{ submission.assignment.due_date|date }}</p>
                    <p>Status: {{ submission.status }}</p>
                </div>
            </div>
            {% empty %}
            <p>No pending assignments</p>
            {% endfor %}
        </div>
        
        <div class="tab-pane fade" id="completed" role="tabpanel">
            {% for submission in completed_submissions %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5>{{ submission.assignment.title }}</h5>
                    <p>Score: {{ submission.score }}/{{ submission.assignment.total_marks }}</p>
                    <p>Submitted: {{ submission.submitted_at|date }}</p>
                </div>
            </div>
            {% empty %}
            <p>No completed assignments</p>
            {% endfor %}
        </div>
        
        <div class="tab-pane fade" id="overdue" role="tabpanel">
            {% for submission in overdue_submissions %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5>{{ submission.assignment.title }}</h5>
                    <p>Due: {{ submission.assignment.due_date|date }}</p>
                    <p class="text-danger">Overdue</p>
                </div>
            </div>
            {% empty %}
            <p>No overdue assignments</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\base_parent.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="parent-dashboard">
    <div class="sidebar">
        <h3>Parent Panel</h3>
        <ul>
            <li><a href="{% url 'parent_dashboard' %}">Dashboard</a></li>
            <li><a href="{% url 'parent_children' %}">My Children</a></li>
            <li><a href="{% url 'parent_feedback' %}">Submit Feedback</a></li>
            <li><a href="{% url 'profile_detail' %}">Profile</a></li>
        </ul>
    </div>
    <div class="content">
        {% block parent_content %}{% endblock %}
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\dashboard.html
<<code:
{% extends 'base.html' %}
{% block title %}Parent Dashboard - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header with profile photo -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2><i class="bi bi-house-heart"></i> Parent Dashboard</h2>
        <p class="mb-0">Welcome, {{ request.user.get_full_name }}</p>
      </div>
      <div class="col-md-4 text-end">
        <form method="post" action="{% url 'profile_photo_update' %}" enctype="multipart/form-data" class="d-inline">
          {% csrf_token %}
          {% if request.user.profile.profile_photo %}
            <img src="{{ request.user.profile.profile_photo.url }}" class="rounded-circle me-2"
                 width="55" height="55" style="object-fit:cover; border:3px solid white;">
          {% else %}
            <i class="bi bi-person-circle fs-1 me-2 text-white"></i>
          {% endif %}
          <label class="btn btn-sm btn-outline-light">
            <i class="bi bi-camera"></i> Change Photo
            <input type="file" name="profile_photo" accept="image/*" class="d-none" onchange="this.form.submit()">
          </label>
        </form>
        <a href="{% url 'password_change' %}" class="btn btn-sm btn-outline-light ms-1">
          <i class="bi bi-key"></i> Change Password
        </a>
      </div>
    </div>
  </div>

  {% if not children_data %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No students are linked to your account yet. Please contact the admin.
  </div>
  {% endif %}

  <!-- Each Child Card -->
  {% for data in children_data %}
  {% with student=data.student %}
  <div class="card mb-4 shadow-sm">
    <div class="card-header" style="background: linear-gradient(135deg,#667eea,#764ba2); color:white;">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          {% if student.user.profile.profile_photo %}
            <img src="{{ student.user.profile.profile_photo.url }}" class="rounded-circle"
                 width="50" height="50" style="object-fit:cover; border:2px solid white;">
          {% else %}
            <i class="bi bi-person-circle fs-2"></i>
          {% endif %}
          <div>
            <h5 class="mb-0">{{ student.user.get_full_name }}</h5>
            <small>Grade {{ student.grade }}{{ student.section }} &bull; Roll No: {{ student.roll_number }}</small>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'parent_student_progress' student.pk %}" class="btn btn-sm btn-light">
            <i class="bi bi-graph-up"></i> Progress
          </a>
          <a href="{% url 'parent_assignment_status' student.pk %}" class="btn btn-sm btn-light">
            <i class="bi bi-journal-text"></i> Assignments
          </a>
          <a href="{% url 'parent_roadmap' student.pk %}" class="btn btn-sm btn-light">
            <i class="bi bi-map"></i> Roadmap
          </a>
          <a href="{% url 'parent_attendance' student.pk %}" class="btn btn-sm btn-light">
            <i class="bi bi-calendar-check"></i> Attendance
          </a>
        </div>
      </div>
    </div>

    <div class="card-body">
      <div class="row g-3">

        <!-- Assignment Stats -->
        <div class="col-md-3">
          <div class="row g-2">
            <div class="col-6">
              <div class="text-center p-2 bg-light rounded">
                <div class="h4 fw-bold text-primary mb-0">{{ data.total_assignments }}</div>
                <small class="text-muted">Total</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-2 bg-light rounded">
                <div class="h4 fw-bold text-success mb-0">{{ data.completed }}</div>
                <small class="text-muted">Graded</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-2 bg-light rounded">
                <div class="h4 fw-bold text-warning mb-0">{{ data.pending }}</div>
                <small class="text-muted">Submitted</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-2 bg-light rounded">
                <div class="h4 fw-bold text-danger mb-0">{{ data.not_submitted }}</div>
                <small class="text-muted">Not Done</small>
              </div>
            </div>
          </div>
          <div class="mt-2 text-center p-2 rounded" style="background:#f0fff4">
            <div class="h5 fw-bold text-success mb-0">{{ data.average_score|floatformat:1 }}%</div>
            <small class="text-muted">Average Score</small>
          </div>
        </div>

        <!-- Recent Test Scores -->
        <div class="col-md-4">
          <h6 class="fw-bold text-muted mb-2"><i class="bi bi-clipboard-check"></i> Recent Test Scores</h6>
          {% if data.recent_scores %}
          <table class="table table-sm mb-0">
            <thead class="table-light"><tr><th>Test</th><th>Score</th><th>Grade</th></tr></thead>
            <tbody>
              {% for score in data.recent_scores %}
              <tr>
                <td>{{ score.test_name|truncatechars:20 }}</td>
                <td>{{ score.score }}/{{ score.max_score }}</td>
                <td>
                  <span class="badge {% if score.get_percentage >= 50 %}bg-success{% else %}bg-danger{% endif %}">
                    {{ score.calculate_grade }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted small">No test scores yet.</p>
          {% endif %}
        </div>

        <!-- Recent Assignment Submissions -->
        <div class="col-md-5">
          <h6 class="fw-bold text-muted mb-2"><i class="bi bi-journal-check"></i> Recent Submissions</h6>
          {% if data.recent_submissions %}
          <table class="table table-sm mb-0">
            <thead class="table-light"><tr><th>Assignment</th><th>Status</th><th>Score</th></tr></thead>
            <tbody>
              {% for sub in data.recent_submissions %}
              <tr>
                <td>{{ sub.assignment.title|truncatechars:22 }}</td>
                <td>
                  <span class="badge {% if sub.status == 'graded' %}bg-success{% elif sub.status == 'submitted' %}bg-warning text-dark{% elif sub.status == 'not_submitted' %}bg-secondary{% else %}bg-info{% endif %}">
                    {{ sub.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if sub.score %}{{ sub.score }}/{{ sub.assignment.max_score }}{% else %}—{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted small">No submissions yet.</p>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
  {% endwith %}
  {% endfor %}

  <!-- Bottom Row: Announcements + Holidays -->
  <div class="row g-3">

    <!-- Status Posts / Announcements -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <strong><i class="bi bi-megaphone"></i> Announcements</strong>
        </div>
        <div class="card-body">
          {% for post in status_posts %}
          <div class="border-start border-3 ps-3 mb-3 {% if post.is_pinned %}border-warning{% else %}border-primary{% endif %}">
            {% if post.is_pinned %}
              <span class="badge bg-warning text-dark me-1"><i class="bi bi-pin"></i> Pinned</span>
            {% endif %}
            <p class="mb-1">{{ post.content }}</p>
            <small class="text-muted">{{ post.created_at|date:"d M Y H:i" }}</small>
          </div>
          {% empty %}
          <p class="text-muted text-center py-2">No announcements.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upcoming Holidays + Quick Links -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <strong><i class="bi bi-calendar-event"></i> Upcoming Holidays / Working Days</strong>
        </div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead class="table-light"><tr><th>Title</th><th>Date</th><th>Type</th></tr></thead>
            <tbody>
              {% for h in holidays %}
              <tr>
                <td>{{ h.title }}</td>
                <td>{{ h.date|date:"d M Y" }}</td>
                <td><span class="badge bg-info text-dark">{{ h.get_holiday_type_display }}</span></td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-center text-muted py-2">No upcoming holidays.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-lightning"></i> Quick Actions</strong></div>
        <div class="card-body d-flex flex-wrap gap-2">
          <a href="{% url 'public_roadmaps' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-map"></i> View All Roadmaps
          </a>
          <a href="{% url 'parent_feedback' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-chat-dots"></i> Submit Feedback
          </a>
          <a href="{% url 'profile_update' %}" class="btn btn-outline-info btn-sm">
            <i class="bi bi-pencil"></i> Edit Profile
          </a>
          <a href="{% url 'notifications' %}" class="btn btn-outline-warning btn-sm">
            <i class="bi bi-bell"></i> Notifications
          </a>
        </div>
      </div>
    </div>

  </div>

</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\feedback.html
<<code:
{% extends 'parent/base_parent.html' %}

{% block parent_content %}
<div class="container">
    <h2>Submit Feedback</h2>
    
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit Feedback</button>
    </form>
    
    <hr>
    
    <h3>Previous Feedback</h3>
    {% for feedback in feedbacks %}
    <div class="card mb-2">
        <div class="card-body">
            <p>{{ feedback.message }}</p>
            <small>Submitted on {{ feedback.created_at|date }}</small>
        </div>
    </div>
    {% empty %}
    <p>No feedback submitted yet</p>
    {% endfor %}
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\progress.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>{{ student.user.get_full_name }}'s Progress</h2>
<h3 class="text-center">{{ average_score }}%</h3>
{% for sub in submissions %}
<div class="mb-2">{{ sub.assignment.title }}: {{ sub.score }}/{{ sub.assignment.total_marks }}</div>
{% endfor %}
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\roadmap.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Curriculum Roadmap</h2>
{% for topic in topics %}
<div class="card mb-2"><div class="card-body"><h5>{{ topic.name }}</h5><p>{{ topic.description }}</p></div></div>
{% endfor %}
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\parent\student_progress.html
<<code:
{% extends 'parent/base_parent.html' %}

{% block parent_content %}
<div class="container">
    <h2>{{ student.user.get_full_name }}'s Progress</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Attendance</h4>
                </div>
                <div class="card-body">
                    <p>Present: {{ attendance.present }} days</p>
                    <p>Absent: {{ attendance.absent }} days</p>
                    <p>Total: {{ attendance.total }} days</p>
                    <p>Percentage: {{ attendance.percentage|floatformat:2 }}%</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Assignment Status</h4>
                </div>
                <div class="card-body">
                    <p>Completed: {{ assignment_stats.completed }}</p>
                    <p>Pending: {{ assignment_stats.pending }}</p>
                    <p>Overdue: {{ assignment_stats.overdue }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Recent Test Scores</h4>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Score</th>
                                <th>Submitted Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for submission in recent_submissions %}
                            <tr>
                                <td>{{ submission.assignment.title }}</td>
                                <td>{{ submission.score }}/{{ submission.assignment.total_marks }}</td>
                                <td>{{ submission.submitted_at|date }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">No submissions yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\profile\profile_detail.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Profile Details</h2>
    <div class="profile-card">
        {% if profile.photo %}
            <img src="{{ profile.photo.url }}" alt="Profile Photo" class="profile-photo">
        {% endif %}
        <p><strong>Username:</strong> {{ user.username }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>First Name:</strong> {{ user.first_name }}</p>
        <p><strong>Last Name:</strong> {{ user.last_name }}</p>
        <p><strong>Role:</strong> {{ profile.get_role_display }}</p>
        <a href="{% url 'profile_update' %}" class="btn btn-primary">Edit Profile</a>
        <a href="{% url 'password_change' %}" class="btn btn-warning">Change Password</a>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\profile\profile_update.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Edit Profile</h2>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ user_form.as_p }}
        {{ profile_form.as_p }}
        <button type="submit" class="btn btn-primary">Update</button>
        <a href="{% url 'profile_detail' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\registration\password_change.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Change Password</h2>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Change Password</button>
        <a href="{% url 'profile_detail' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\registration\password_change_done.html
<<code:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Password Changed Successfully</h2>
    <p>Your password has been changed.</p>
    <a href="{% url 'profile_detail' %}" class="btn btn-primary">Back to Profile</a>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\assignment_list.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>My Assignments</h2>
{% for assignment in assignments %}
<div class="card mb-3">
    <div class="card-body">
        <h5>{{ assignment.title }}</h5>
        <p>{{ assignment.description }}</p>
        <p>Due: {{ assignment.due_date|date:"M d, Y" }}</p>
        {% if assignment.id not in submissions %}
        <a href="{% url 'submit_assignment' assignment.pk %}" class="btn btn-primary">Submit</a>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\brushup_request.html
<<code:
{% extends 'student/base_student.html' %}

{% block student_content %}
<div class="container">
    <h2>Request Brush-up Session</h2>
    
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit Request</button>
        <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\dashboard.html
<<code:
{% extends 'base.html' %}
{% block title %}Student Dashboard - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header with profile photo -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2><i class="bi bi-person-circle"></i> Student Dashboard</h2>
        <p class="mb-0">Welcome, {{ request.user.get_full_name }}</p>
      </div>
      <div class="col-md-4 text-end">
        <form method="post" action="{% url 'profile_photo_update' %}" enctype="multipart/form-data" class="d-inline">
          {% csrf_token %}
          {% if request.user.profile.profile_photo %}
            <img src="{{ request.user.profile.profile_photo.url }}" class="rounded-circle me-2"
                 width="55" height="55" style="object-fit:cover; border:3px solid white;">
          {% else %}
            <i class="bi bi-person-circle fs-1 me-2 text-white"></i>
          {% endif %}
          <label class="btn btn-sm btn-outline-light">
            <i class="bi bi-camera"></i> Change Photo
            <input type="file" name="profile_photo" accept="image/*" class="d-none" onchange="this.form.submit()">
          </label>
        </form>
        <a href="{% url 'password_change' %}" class="btn btn-sm btn-outline-light ms-1">
          <i class="bi bi-key"></i> Change Password
        </a>
      </div>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card">
        <div class="stat-value">{{ total_assignments }}</div>
        <div class="stat-label"><i class="bi bi-journal-text"></i> Total Assignments</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background: linear-gradient(135deg,#ed8936,#c05621)">
        <div class="stat-value">{{ pending_assignments.count }}</div>
        <div class="stat-label"><i class="bi bi-clock"></i> Pending</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background: linear-gradient(135deg,#48bb78,#276749)">
        <div class="stat-value">{{ completed_assignments.count }}</div>
        <div class="stat-label"><i class="bi bi-check-circle"></i> Graded</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background: linear-gradient(135deg,#4299e1,#2b6cb0)">
        <div class="stat-value">{{ average_score }}%</div>
        <div class="stat-label"><i class="bi bi-graph-up"></i> Avg Score</div>
      </div>
    </div>
  </div>

  <div class="row g-3">

    <!-- Pending Assignments -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-hourglass-split text-warning"></i> Pending Assignments</strong>
          <a href="{% url 'student_assignments' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Title</th><th>Subject</th><th>Due Date</th><th></th></tr>
            </thead>
            <tbody>
              {% for assignment in pending_assignments %}
              <tr>
                <td>{{ assignment.title|truncatechars:30 }}</td>
                <td><span class="badge bg-light text-dark border">{{ assignment.subject|default:"—" }}</span></td>
                <td>
                  <span class="{% if assignment.is_overdue %}text-danger fw-bold{% else %}text-dark{% endif %}">
                    {{ assignment.due_date|date:"d M Y" }}
                  </span>
                </td>
                <td>
                  <a href="{% url 'student_submit_assignment' assignment.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-upload"></i> Submit
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3">
                  <i class="bi bi-check-circle-fill text-success"></i> All caught up!
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Submitted / Graded Assignments -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-check-circle text-success"></i> Submitted Assignments</strong>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Title</th><th>Status</th><th>Score</th></tr>
            </thead>
            <tbody>
              {% for sub in submitted_assignments %}
              <tr>
                <td>{{ sub.assignment.title|truncatechars:30 }}</td>
                <td>
                  <span class="badge {% if sub.status == 'graded' %}bg-success{% elif sub.status == 'submitted' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                    {{ sub.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if sub.score %}
                    <strong>{{ sub.score }}/{{ sub.assignment.max_score }}</strong>
                    <small class="text-muted">({{ sub.get_grade }})</small>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              </tr>
              {% for sub in completed_assignments %}
              <tr>
                <td>{{ sub.assignment.title|truncatechars:30 }}</td>
                <td><span class="badge bg-success">{{ sub.get_status_display }}</span></td>
                <td>
                  {% if sub.score %}
                    <strong>{{ sub.score }}/{{ sub.assignment.max_score }}</strong>
                    <small class="text-muted">({{ sub.get_grade }})</small>
                  {% else %}<span class="text-muted">—</span>{% endif %}
                </td>
              </tr>
              {% endfor %}
              {% empty %}
                {% for sub in completed_assignments %}
                <tr>
                  <td>{{ sub.assignment.title|truncatechars:30 }}</td>
                  <td><span class="badge bg-success">{{ sub.get_status_display }}</span></td>
                  <td>
                    {% if sub.score %}
                      <strong>{{ sub.score }}/{{ sub.assignment.max_score }}</strong>
                      <small class="text-muted">({{ sub.get_grade }})</small>
                    {% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted py-3">No submissions yet.</td></tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Overdue Assignments -->
    {% if overdue_assignments %}
    <div class="col-12">
      <div class="card border-danger">
        <div class="card-header bg-danger text-white">
          <strong><i class="bi bi-exclamation-triangle"></i> Overdue Assignments</strong>
        </div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr><th>Title</th><th>Due Date</th><th>Days Overdue</th><th></th></tr>
            </thead>
            <tbody>
              {% for assignment in overdue_assignments %}
              <tr class="table-danger">
                <td>{{ assignment.title }}</td>
                <td>{{ assignment.due_date|date:"d M Y" }}</td>
                <td><span class="badge bg-danger">{{ assignment.days_until_due|add:"0" }} days ago</span></td>
                <td>
                  <a href="{% url 'student_submit_assignment' assignment.pk %}" class="btn btn-sm btn-danger">
                    Submit Now
                  </a>
                  <a href="{% url 'raise_ticket' %}" class="btn btn-sm btn-outline-secondary">
                    Raise Ticket
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Status Posts / Announcements -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <strong><i class="bi bi-megaphone"></i> Announcements</strong>
        </div>
        <div class="card-body">
          {% for post in status_posts %}
          <div class="border-start border-3 ps-3 mb-3 {% if post.is_pinned %}border-warning{% else %}border-primary{% endif %}">
            {% if post.is_pinned %}
              <span class="badge bg-warning text-dark me-1"><i class="bi bi-pin"></i> Pinned</span>
            {% endif %}
            <p class="mb-1">{{ post.content }}</p>
            <small class="text-muted">{{ post.created_at|date:"d M Y H:i" }}</small>
          </div>
          {% empty %}
          <p class="text-muted text-center py-2">No announcements.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upcoming Holidays + Quick Links -->
    <div class="col-md-6">
      <!-- Holidays -->
      <div class="card mb-3">
        <div class="card-header">
          <strong><i class="bi bi-calendar-event"></i> Upcoming Holidays</strong>
        </div>
        <div class="card-body p-0">
          <table class="table mb-0 table-sm">
            <thead class="table-light"><tr><th>Title</th><th>Date</th><th>Type</th></tr></thead>
            <tbody>
              {% for h in holidays %}
              <tr>
                <td>{{ h.title }}</td>
                <td>{{ h.date|date:"d M Y" }}</td>
                <td><span class="badge bg-info text-dark">{{ h.get_holiday_type_display }}</span></td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-center text-muted py-2">No upcoming holidays.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <div class="card-header"><strong><i class="bi bi-lightning"></i> Quick Actions</strong></div>
        <div class="card-body d-flex flex-wrap gap-2">
          <a href="{% url 'student_roadmap' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-map"></i> View Roadmap
          </a>
          <a href="{% url 'student_progress' %}" class="btn btn-outline-success btn-sm">
            <i class="bi bi-graph-up"></i> My Progress
          </a>
          <a href="{% url 'raise_ticket' %}" class="btn btn-outline-warning btn-sm">
            <i class="bi bi-ticket-perforated"></i> Raise Ticket
          </a>
          <a href="{% url 'brushup_request' %}" class="btn btn-outline-info btn-sm">
            <i class="bi bi-arrow-repeat"></i> Request Brush-Up
          </a>
          <a href="{% url 'student_attendance' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-calendar-check"></i> My Attendance
          </a>
          {% if unread_notifications > 0 %}
          <a href="{% url 'notifications' %}" class="btn btn-danger btn-sm">
            <i class="bi bi-bell"></i> {{ unread_notifications }} New Notification(s)
          </a>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\progress.html
<<code:
{% extends 'base.html' %}
{% block title %}My Progress - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">
  <h3 class="mb-4"><i class="bi bi-graph-up"></i> My Progress</h3>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card">
        <div class="stat-value">{{ total_assignments }}</div>
        <div class="stat-label">Graded Assignments</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background:linear-gradient(135deg,#48bb78,#276749)">
        <div class="stat-value">{{ average_score }}%</div>
        <div class="stat-label">Average Score</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background:linear-gradient(135deg,#4299e1,#2b6cb0)">
        <div class="stat-value">{{ attendance_rate }}%</div>
        <div class="stat-label">Attendance Rate</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Score graph -->
    <div class="col-md-7">
      <div class="card">
        <div class="card-header"><strong>Monthly Average Scores</strong></div>
        <div class="card-body">
          <canvas id="scoreChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Topic progress cards -->
    <div class="col-md-5">
      <div class="card">
        <div class="card-header"><strong>Topic Progress</strong></div>
        <div class="card-body" style="max-height:350px;overflow-y:auto;">
          {% for title, info in topic_progress_raw %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="fw-medium">{{ title }}</span>
              <span class="badge {{ info.badge_class }}">{{ info.status|title }}</span>
            </div>
            <div class="progress" style="height:8px;">
              <div class="progress-bar" style="width:{{ info.completion }}%"></div>
            </div>
          </div>
          {% empty %}
          <p class="text-muted text-center">No topics in roadmap yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Recent test scores -->
    <div class="col-12">
      <div class="card">
        <div class="card-header"><strong>Recent Test Scores</strong></div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr><th>Test</th><th>Subject</th><th>Date</th><th>Score</th><th>Grade</th><th>Re-Test?</th></tr>
            </thead>
            <tbody>
              {% for score in test_scores %}
              <tr>
                <td>{{ score.test_name }}</td>
                <td>{{ score.subject }}</td>
                <td>{{ score.date|date:"d M Y" }}</td>
                <td>{{ score.score }}/{{ score.max_score }} ({{ score.get_percentage }}%)</td>
                <td><span class="badge {% if score.get_percentage >= 50 %}bg-success{% else %}bg-danger{% endif %}">{{ score.calculate_grade }}</span></td>
                <td>
                  {% if score.is_failed %}
                    <a href="{% url 'retest_request' score.pk %}" class="btn btn-sm btn-outline-danger">Apply Re-Test</a>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center text-muted py-3">No test scores yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const monthlyRaw = {{ monthly_scores|safe }};
const labels = monthlyRaw.map(d => d.month ? d.month.substring(0,7) : '');
const scores = monthlyRaw.map(d => d.avg ? parseFloat(d.avg).toFixed(1) : 0);

new Chart(document.getElementById('scoreChart'), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Avg Score',
      data: scores,
      borderColor: '#667eea',
      backgroundColor: 'rgba(102,126,234,0.1)',
      tension: 0.3,
      fill: true,
      pointRadius: 5,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true, max: 100 } }
  }
});
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\raise_ticket.html
<<code:
{% extends 'student/base_student.html' %}

{% block student_content %}
<div class="container">
    <h2>Raise a Ticket</h2>
    
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit Ticket</button>
        <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\retest_request.html
<<code:
{% extends 'student/base_student.html' %}

{% block student_content %}
<div class="container">
    <h2>Request Retest</h2>
    
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit Request</button>
        <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\roadmap.html
<<code:
{% extends 'base.html' %}
{% block title %}My Roadmap - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-map"></i> Curriculum Roadmap</h3>
    <a href="{% url 'brushup_request' %}" class="btn btn-outline-primary">
      <i class="bi bi-arrow-repeat"></i> Request Brush-Up / Re-Test
    </a>
  </div>

  <!-- Progress bar -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>Overall Progress</span>
        <span><strong>{{ completed_topics }}/{{ total_topics }}</strong> topics completed</span>
      </div>
      <div class="progress" style="height:12px;">
        <div class="progress-bar" role="progressbar"
             style="width: {{ completion_percentage }}%"
             aria-valuenow="{{ completion_percentage }}" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
      <small class="text-muted">{{ completion_percentage }}% complete</small>
    </div>
  </div>

  <!-- Tree View -->
  <div class="card">
    <div class="card-header"><strong>Topic Hierarchy</strong></div>
    <div class="card-body" id="roadmapTree">
      <div class="text-center py-3"><div class="spinner-border text-primary"></div></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const treeData = {{ tree_data|safe }};

function getBadgeClass(status) {
  const map = {
    'completed': 'bg-success',
    'in_progress': 'bg-warning text-dark',
    'upcoming': 'bg-info',
    'not_started': 'bg-secondary',
  };
  return map[status] || 'bg-secondary';
}

function getStatusLabel(status) {
  const map = {
    'completed': 'Completed',
    'in_progress': 'In Progress',
    'upcoming': 'Upcoming',
    'not_started': 'Not Started',
  };
  return map[status] || status;
}

function buildNode(topic, depth) {
  const indent = depth * 20;
  const hasChildren = topic.children && topic.children.length > 0;
  const collapseId = `topic-${topic.id}-children`;

  let testBadge = '';
  if (topic.test_scheduled) {
    testBadge = `<span class="badge bg-danger ms-1"><i class="bi bi-calendar-check"></i> Test: ${topic.test_scheduled}</span>`;
  }

  let brushupBtn = '';
  if (topic.status !== 'not_started') {
    brushupBtn = `<a href="/student/brushup/request/?topic_id=${topic.id}" class="btn btn-xs btn-outline-secondary ms-2" style="font-size:0.7rem;padding:2px 8px;">Brush-up</a>`;
  }

  let html = `
    <div style="margin-left:${indent}px;" class="py-2 border-start border-2 ps-3 mb-1
      ${topic.status === 'completed' ? 'border-success' :
        topic.status === 'in_progress' ? 'border-warning' : 'border-secondary'}">
      <div class="d-flex align-items-center flex-wrap gap-2">
        ${hasChildren ? `<button class="btn btn-sm btn-outline-secondary py-0 px-2"
          data-bs-toggle="collapse" data-bs-target="#${collapseId}">
          <i class="bi bi-chevron-down" style="font-size:0.7rem;"></i></button>` : '<span style="width:28px;"></span>'}
        <strong>${topic.name}</strong>
        <span class="badge ${getBadgeClass(topic.status)}">${getStatusLabel(topic.status)}</span>
        ${testBadge}
        ${brushupBtn}
      </div>
      ${topic.description ? `<small class="text-muted ms-5">${topic.description}</small>` : ''}
    </div>`;

  if (hasChildren) {
    html += `<div id="${collapseId}" class="collapse show">`;
    for (const child of topic.children) {
      html += buildNode(child, depth + 1);
    }
    html += `</div>`;
  }

  return html;
}

document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('roadmapTree');
  if (!treeData || treeData.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">No roadmap topics available yet.</p>';
    return;
  }
  let html = '';
  for (const topic of treeData) {
    html += buildNode(topic, 0);
  }
  container.innerHTML = html;
});
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\student\submit_assignment.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Submit: {{ assignment.title }}</h2>
<form method="post" enctype="multipart/form-data">{% csrf_token %}{{ form.as_p }}<button type="submit" class="btn btn-success">Submit</button></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\_topic_node.html
<<code:
<!-- Teacher roadmap topic node — recursive for hierarchy tree with badges -->
<div class="d-flex align-items-start gap-2 py-2 border-start border-2 ps-3 mb-2"
     style="margin-left: {{ level|default:0 }}px; border-color: {% if topic.status == 'completed' %}#48bb78{% elif topic.status == 'in_progress' %}#ed8936{% else %}#cbd5e0{% endif %} !important;">

  <div class="flex-grow-1">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <strong>{{ topic.title }}</strong>
      <span class="badge {{ topic.get_badge_class }}">{{ topic.get_status_display }}</span>
      {% if topic.has_upcoming_test %}
        <span class="badge bg-danger"><i class="bi bi-calendar-check"></i> Test: {{ topic.test_scheduled|date:"d M" }}</span>
      {% endif %}
      {% if topic.subject %}
        <span class="badge bg-light text-dark border">{{ topic.subject }}</span>
      {% endif %}
      {% if topic.grade %}
        <span class="badge bg-light text-dark border">Grade {{ topic.grade }}</span>
      {% endif %}
    </div>
    {% if topic.description %}
      <small class="text-muted">{{ topic.description|truncatechars:100 }}</small>
    {% endif %}
  </div>

  <div class="d-flex gap-1 flex-shrink-0">
    <a href="{% url 'roadmap_edit' topic.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
      <i class="bi bi-pencil"></i>
    </a>
    <a href="{% url 'roadmap_create' %}?parent={{ topic.pk }}" class="btn btn-sm btn-outline-primary" title="Add subtopic">
      <i class="bi bi-plus"></i>
    </a>
    <form method="post" action="{% url 'roadmap_delete' topic.pk %}" class="d-inline"
          onsubmit="return confirm('Delete {{ topic.title }}?')">
      {% csrf_token %}
      <button class="btn btn-sm btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></button>
    </form>
  </div>
</div>

{% if topic.subtopics.all %}
  <div style="margin-left: 20px;">
    {% for subtopic in topic.subtopics.all %}
      {% include 'teacher/_topic_node.html' with topic=subtopic level=level|add:20 %}
    {% endfor %}
  </div>
{% endif %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\assignment_confirm_delete.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Delete Assignment</h2>
<p>Delete {{ object.title }}?</p>
<form method="post">{% csrf_token %}<button type="submit" class="btn btn-danger">Yes</button></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\assignment_form.html
<<code:
{% extends 'base.html' %}
{% block title %}{{ action }} Assignment - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="bi bi-journal-plus"></i> {{ action }} Assignment</h4>
        </div>
        <div class="card-body">

          {% if messages %}
            {% for msg in messages %}
              <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
            {% endfor %}
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="assignmentForm">
            {% csrf_token %}

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Title *</label>
                {{ form.title }}
                {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Subject</label>
                {{ form.subject }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Grade</label>
                {{ form.grade }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Max Score</label>
                {{ form.max_score }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Due Date *</label>
                {{ form.due_date }}
                {% if form.due_date.errors %}<div class="text-danger small">{{ form.due_date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Status</label>
                {{ form.status }}
              </div>
              <div class="col-12">
                <label class="form-label">Description *</label>
                {{ form.description }}
              </div>
              <div class="col-12">
                <label class="form-label">Additional Instructions</label>
                {{ form.instructions }}
              </div>

              <!-- File upload — PDF/DOC/DOCX -->
              <div class="col-12">
                <label class="form-label">
                  <i class="bi bi-paperclip"></i> Assignment File
                  <small class="text-muted">(PDF, DOC, DOCX — max 10MB)</small>
                </label>
                {{ form.assignment_file }}
                {% if form.assignment_file.errors %}
                  <div class="text-danger small">{{ form.assignment_file.errors }}</div>
                {% endif %}
                {% if assignment.assignment_file %}
                  <div class="mt-2">
                    <span class="badge bg-success">Current file: {{ assignment.assignment_file.name|slice:"-30:" }}</span>
                    <a href="{{ assignment.assignment_file.url }}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                      <i class="bi bi-download"></i> View
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>

            {% if form.non_field_errors %}
              <div class="alert alert-danger mt-3">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-check-circle"></i> {{ action }} Assignment
              </button>
              <a href="{% url 'assignment_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('assignmentForm').addEventListener('submit', function () {
    const btn = document.getElementById('submitBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    btn.disabled = true;
  });
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\assignment_list.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Assignments <a href="{% url 'assignment_add' %}" class="btn btn-success">Create</a></h2>
{% for assignment in assignments %}
<div class="card mb-3">
    <div class="card-body">
        <h5>{{ assignment.title }}</h5>
        <p>{{ assignment.description }}</p>
        <a href="{% url 'submission_list' assignment.pk %}" class="btn btn-sm btn-primary">View Submissions</a>
        <a href="{% url 'assignment_delete' assignment.pk %}" class="btn btn-sm btn-danger">Delete</a>
    </div>
</div>
{% endfor %}
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\attendance_form.html
<<code:
{% extends 'base.html' %}
{% load dict_extras %}
{% block title %}Mark Attendance - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-calendar-check"></i> Mark Attendance</h2>
      <p class="text-muted mb-0">Select a date and mark each student's attendance.</p>
    </div>
    <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Date Selector Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="dateInput" class="form-label fw-semibold">
            <i class="bi bi-calendar3"></i> Select Date
          </label>
          <input type="date" class="form-control form-control-lg" id="dateInput" name="date"
                 value="{{ att_date|date:'Y-m-d' }}" max="{{ att_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-search"></i> Load Students
          </button>
        </div>
        <div class="col-md-5 text-end">
          <span class="text-muted">
            <i class="bi bi-calendar-event"></i>
            Showing attendance for: <strong class="text-primary">{{ att_date|date:"l, d F Y" }}</strong>
          </span>
        </div>
      </form>
    </div>
  </div>

  <!-- Attendance Form -->
  <form method="post" id="attendanceForm">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ att_date|date:'Y-m-d' }}">

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white py-3">
        <div>
          <h5 class="mb-0"><i class="bi bi-people"></i> Student Attendance — {{ att_date|date:"d M Y" }}</h5>
          <small>{{ students|length }} student(s) listed</small>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light btn-sm" onclick="markAllPresent()">
            <i class="bi bi-check-all"></i> Mark All Present
          </button>
          <button type="button" class="btn btn-light btn-sm" onclick="markAllAbsent()">
            <i class="bi bi-x-circle"></i> Mark All Absent
          </button>
          <button type="submit" class="btn btn-success btn-sm fw-bold px-4" id="saveBtn">
            <i class="bi bi-save"></i> Save Attendance
          </button>
        </div>
      </div>

      <div class="card-body p-0">
        {% if students %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="attendanceTable">
            <thead class="table-light sticky-top">
              <tr>
                <th style="width:40px;">#</th>
                <th><i class="bi bi-person"></i> Student Name</th>
                <th><i class="bi bi-bookmark"></i> Class</th>
                <th><i class="bi bi-book"></i> Subjects</th>
                <th style="min-width:160px;"><i class="bi bi-check-circle"></i> Status</th>
                <th style="min-width:80px;" class="text-center">Present</th>
                <th style="min-width:120px;">Notes</th>
                <th style="min-width:80px;" class="text-center">Edit</th>
              </tr>
            </thead>
            <tbody>
              {% for student in students %}
                {% with rec=existing|get_item:student.id %}
                <tr id="row-{{ student.id }}" class="{% if rec %}{% if rec.status == 'present' %}table-success{% elif rec.status == 'absent' %}table-danger{% elif rec.status == 'late' %}table-warning{% elif rec.status == 'excused' %}table-info{% endif %}{% endif %}">

                  <!-- Row number -->
                  <td class="text-muted small">{{ forloop.counter }}</td>

                  <!-- Student Name + Roll -->
                  <td>
                    <div class="fw-semibold">{{ student.user.get_full_name }}</div>
                    <small class="text-muted">Roll: {{ student.roll_number }}</small>
                  </td>

                  <!-- Class / Section -->
                  <td>
                    <span class="badge bg-info text-dark">
                      Grade {{ student.grade }}{{ student.section }}
                    </span>
                  </td>

                  <!-- Subjects (from assignments for this grade) -->
                  <td>
                    <div class="subjects-cell" data-grade="{{ student.grade }}">
                      {% for sub in student.grade_subjects %}
                        <span class="badge bg-secondary me-1">{{ sub }}</span>
                      {% empty %}
                        <span class="text-muted small">—</span>
                      {% endfor %}
                    </div>
                  </td>

                  <!-- Status Select -->
                  <td>
                    <select name="status_{{ student.id }}"
                            class="form-select form-select-sm status-select {% if not rec %}disabled-look{% endif %}"
                            id="status-{{ student.id }}"
                            {% if rec %}data-original="{{ rec.status }}"{% endif %}
                            onchange="updateRowColor({{ student.id }}, this.value)"
                            {% if not rec %}disabled{% endif %}>
                      <option value="" {% if not rec %}selected{% endif %}>— Not Marked —</option>
                      <option value="present"  {% if rec.status == 'present'  %}selected{% endif %}>✅ Present</option>
                      <option value="absent"   {% if rec.status == 'absent'   %}selected{% endif %}>❌ Absent</option>
                      <option value="late"     {% if rec.status == 'late'     %}selected{% endif %}>⏰ Late</option>
                      <option value="excused"  {% if rec.status == 'excused'  %}selected{% endif %}>🔵 Excused</option>
                      <option value="half_day" {% if rec.status == 'half_day' %}selected{% endif %}>🌓 Half Day</option>
                    </select>
                  </td>

                  <!-- Present Checkbox (quick mark) -->
                  <td class="text-center">
                    <div class="form-check d-flex justify-content-center">
                      <input class="form-check-input present-checkbox"
                             type="checkbox"
                             id="present-{{ student.id }}"
                             data-student-id="{{ student.id }}"
                             {% if rec.status == 'present' %}checked{% endif %}
                             onchange="handleCheckboxChange({{ student.id }}, this.checked)"
                             style="width:1.3em; height:1.3em; cursor:pointer;">
                    </div>
                  </td>

                  <!-- Notes -->
                  <td>
                    <input type="text"
                           name="notes_{{ student.id }}"
                           class="form-control form-control-sm notes-input"
                           placeholder="Optional note"
                           value="{% if rec %}{{ rec.notes }}{% endif %}"
                           {% if rec %}data-original="{{ rec.notes }}"{% endif %}
                           {% if not rec %}disabled{% endif %}>
                  </td>

                  <!-- Edit Button -->
                  <td class="text-center">
                    {% if rec %}
                      <button type="button" class="btn btn-sm btn-outline-warning edit-btn"
                              onclick="enableEdit({{ student.id }})"
                              id="edit-btn-{{ student.id }}"
                              title="Edit attendance for this student">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary cancel-btn d-none"
                              onclick="cancelEdit({{ student.id }})"
                              id="cancel-btn-{{ student.id }}"
                              title="Cancel edit">
                        <i class="bi bi-x"></i>
                      </button>
                    {% else %}
                      <span class="badge bg-light text-muted">New</span>
                    {% endif %}
                  </td>

                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Bottom Save Button -->
        <div class="p-3 border-top bg-light d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="bi bi-info-circle"></i>
            Check the "Present" checkbox for quick marking, or use the dropdown for detailed status.
            Click <strong>Edit</strong> to modify an already-saved record.
          </small>
          <button type="submit" class="btn btn-success fw-bold px-5" id="saveBtn2">
            <i class="bi bi-save"></i> Save Attendance
          </button>
        </div>

        {% else %}
          <div class="text-center py-5 text-muted">
            <i class="bi bi-people" style="font-size:3rem;"></i>
            <p class="mt-3">No students found. <a href="{% url 'student_add' %}">Add students</a> first.</p>
          </div>
        {% endif %}

      </div>
    </div>
  </form>

</div>

<style>
  .status-select {
    min-width: 140px;
  }
  .disabled-look {
    background-color: #f8f9fa;
    color: #999;
  }
  .sticky-top {
    top: 0;
    z-index: 10;
  }
  .table-success td, .table-danger td,
  .table-warning td, .table-info td {
    transition: background-color 0.3s ease;
  }
</style>

<script>
  // Enable editing of an already-saved attendance record
  function enableEdit(studentId) {
    const select = document.getElementById('status-' + studentId);
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    const editBtn = document.getElementById('edit-btn-' + studentId);
    const cancelBtn = document.getElementById('cancel-btn-' + studentId);

    select.disabled = false;
    select.classList.remove('disabled-look');
    notes.disabled = false;
    editBtn.classList.add('d-none');
    cancelBtn.classList.remove('d-none');

    // Highlight row for editing
    const row = document.getElementById('row-' + studentId);
    row.style.outline = '2px solid #f6ad55';
  }

  // Cancel editing, revert to original values
  function cancelEdit(studentId) {
    const select = document.getElementById('status-' + studentId);
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    const editBtn = document.getElementById('edit-btn-' + studentId);
    const cancelBtn = document.getElementById('cancel-btn-' + studentId);
    const row = document.getElementById('row-' + studentId);

    // Revert to saved values
    if (select.dataset.original) select.value = select.dataset.original;
    if (notes.dataset.original !== undefined) notes.value = notes.dataset.original;

    select.disabled = true;
    select.classList.add('disabled-look');
    notes.disabled = true;
    editBtn.classList.remove('d-none');
    cancelBtn.classList.add('d-none');
    row.style.outline = '';

    // Update row color to match original
    updateRowColor(studentId, select.value);
  }

  // Handle present checkbox: sets status to present/absent
  function handleCheckboxChange(studentId, isChecked) {
    const select = document.getElementById('status-' + studentId);
    const row = document.getElementById('row-' + studentId);

    // Enable the select if it's disabled (new record)
    select.disabled = false;
    select.classList.remove('disabled-look');

    // Enable notes too
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    if (notes) notes.disabled = false;

    if (isChecked) {
      select.value = 'present';
    } else {
      // If unchecking, set to absent only if was present, else keep current
      if (select.value === 'present' || select.value === '') {
        select.value = 'absent';
      }
    }
    updateRowColor(studentId, select.value);
  }

  // Sync checkbox with select dropdown
  document.querySelectorAll('.status-select').forEach(function(sel) {
    sel.addEventListener('change', function() {
      const id = this.id.replace('status-', '');
      const checkbox = document.getElementById('present-' + id);
      if (checkbox) checkbox.checked = (this.value === 'present');
    });
  });

  // Update row background color based on status
  function updateRowColor(studentId, status) {
    const row = document.getElementById('row-' + studentId);
    row.classList.remove('table-success', 'table-danger', 'table-warning', 'table-info', 'table-secondary');
    const colorMap = {
      'present':  'table-success',
      'absent':   'table-danger',
      'late':     'table-warning',
      'excused':  'table-info',
      'half_day': 'table-secondary',
    };
    if (colorMap[status]) row.classList.add(colorMap[status]);
  }

  // Mark all students as present
  function markAllPresent() {
    document.querySelectorAll('.status-select').forEach(function(sel) {
      const id = sel.id.replace('status-', '');
      sel.disabled = false;
      sel.classList.remove('disabled-look');
      sel.value = 'present';
      const notes = document.querySelector(`input[name="notes_${id}"]`);
      if (notes) notes.disabled = false;
      updateRowColor(id, 'present');
      const cb = document.getElementById('present-' + id);
      if (cb) cb.checked = true;
    });
  }

  // Mark all students as absent
  function markAllAbsent() {
    document.querySelectorAll('.status-select').forEach(function(sel) {
      const id = sel.id.replace('status-', '');
      sel.disabled = false;
      sel.classList.remove('disabled-look');
      sel.value = 'absent';
      const notes = document.querySelector(`input[name="notes_${id}"]`);
      if (notes) notes.disabled = false;
      updateRowColor(id, 'absent');
      const cb = document.getElementById('present-' + id);
      if (cb) cb.checked = false;
    });
  }

  // Before form submit — enable all selects/inputs so values are submitted
  document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    document.querySelectorAll('.status-select, .notes-input').forEach(function(el) {
      el.disabled = false;
    });

    // Remove "not marked" entries — empty status
    document.querySelectorAll('.status-select').forEach(function(sel) {
      if (!sel.value) sel.name = ''; // remove from POST if not marked
    });

    // Loading state
    document.getElementById('saveBtn').innerHTML =
      '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    document.getElementById('saveBtn').disabled = true;
    if (document.getElementById('saveBtn2')) {
      document.getElementById('saveBtn2').innerHTML =
        '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
      document.getElementById('saveBtn2').disabled = true;
    }
  });
</script>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\dashboard.html
<<code:
{% extends 'base.html' %}
{% block title %}Teacher Dashboard - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header with profile photo -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2><i class="bi bi-mortarboard"></i> Teacher Dashboard</h2>
        <p class="mb-0">Welcome, {{ request.user.get_full_name }}</p>
      </div>
      <div class="col-md-4 text-end">
        <form method="post" action="{% url 'profile_photo_update' %}" enctype="multipart/form-data" class="d-inline">
          {% csrf_token %}
          {% if request.user.profile.profile_photo %}
            <img src="{{ request.user.profile.profile_photo.url }}" class="rounded-circle me-2" width="50" height="50" style="object-fit:cover;">
          {% endif %}
          <label class="btn btn-sm btn-outline-light">
            <i class="bi bi-camera"></i> Photo
            <input type="file" name="profile_photo" accept="image/*" class="d-none" onchange="this.form.submit()">
          </label>
        </form>
        <a href="{% url 'password_change' %}" class="btn btn-sm btn-outline-light ms-1">
          <i class="bi bi-key"></i> Change Password
        </a>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card">
        <div class="stat-value">{{ total_students }}</div>
        <div class="stat-label">Students</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background:linear-gradient(135deg,#4299e1,#2b6cb0)">
        <div class="stat-value">{{ active_assignments }}</div>
        <div class="stat-label">Active Assignments</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background:linear-gradient(135deg,#ed8936,#c05621)">
        <div class="stat-value">{{ pending_reviews }}</div>
        <div class="stat-label">Pending Reviews</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card" style="background:linear-gradient(135deg,#48bb78,#276749)">
        <div class="stat-value">{{ roadmap_count }}</div>
        <div class="stat-label">Roadmap Topics</div>
      </div>
    </div>
  </div>

  <div class="row g-3">

    <!-- Recent Submissions with STATUS — teacher's dashboard -->
    <div class="col-md-7">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-inbox"></i> Recent Submissions (Status)</strong>
          <a href="{% url 'assignment_list' %}" class="btn btn-sm btn-outline-primary">All Assignments</a>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr><th>Student</th><th>Assignment</th><th>Status</th><th>Submitted</th><th></th></tr>
            </thead>
            <tbody>
              {% for sub in recent_submissions %}
              <tr>
                <td>
                  <!-- Clicking student name goes to student detail page — FIXED -->
                  <a href="{% url 'teacher_student_detail' sub.student.pk %}" class="text-decoration-none fw-medium">
                    {{ sub.student.user.get_full_name }}
                  </a>
                </td>
                <td>{{ sub.assignment.title|truncatechars:30 }}</td>
                <td>
                  <span class="badge {% if sub.status == 'submitted' %}bg-warning text-dark{% elif sub.status == 'graded' %}bg-success{% elif sub.status == 'not_submitted' %}bg-secondary{% else %}bg-info{% endif %}">
                    {{ sub.get_status_display }}
                  </span>
                </td>
                <td><small>{{ sub.submitted_at|date:"d M H:i"|default:"—" }}</small></td>
                <td>
                  <a href="{% url 'submission_grade' sub.pk %}" class="btn btn-sm btn-outline-primary">Grade</a>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-3">No recent submissions.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <!-- Quick actions -->
      <div class="card mb-3">
        <div class="card-header"><strong><i class="bi bi-lightning"></i> Quick Actions</strong></div>
        <div class="card-body d-flex flex-wrap gap-2">
          <a href="{% url 'assignment_create' %}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> Create Assignment</a>
          <a href="{% url 'mark_attendance' %}" class="btn btn-success btn-sm"><i class="bi bi-calendar-check"></i> Mark Attendance</a>
          <a href="{% url 'roadmap_create' %}" class="btn btn-info btn-sm"><i class="bi bi-map"></i> Add Topic</a>
          <a href="{% url 'student_list' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-people"></i> Students</a>
          {% if open_tickets > 0 %}
          <a href="{% url 'teacher_tickets' %}" class="btn btn-warning btn-sm">
            <i class="bi bi-ticket-perforated"></i> {{ open_tickets }} Open Ticket(s)
          </a>
          {% endif %}
        </div>
      </div>

      <!-- Roadmap Topics (hierarchy with badges) -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-map"></i> My Roadmap Topics</strong>
          <a href="{% url 'roadmap_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body" style="max-height: 250px; overflow-y:auto;">
          {% for topic in roadmap_topics %}
            <div class="d-flex align-items-center justify-content-between py-1 border-bottom">
              <div>
                <span class="fw-medium">{{ topic.title }}</span>
                <span class="badge {{ topic.get_badge_class }} ms-1">{{ topic.get_status_display }}</span>
                {% if topic.has_upcoming_test %}
                  <span class="badge bg-danger ms-1"><i class="bi bi-calendar-check"></i> Test {{ topic.test_scheduled|date:"d M" }}</span>
                {% endif %}
              </div>
              {% if topic.subtopics.count > 0 %}
                <span class="badge bg-light text-dark border">+{{ topic.subtopics.count }} sub</span>
              {% endif %}
            </div>
          {% empty %}
            <p class="text-muted text-center py-2">No roadmap topics yet. <a href="{% url 'roadmap_create' %}">Add one</a></p>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\grade_submission.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Grade Submission</h2>
<p><strong>Student:</strong> {{ object.student.user.get_full_name }}</p>
<p><strong>Answer:</strong> {{ object.answer_text }}</p>
<form method="post">{% csrf_token %}{{ form.as_p }}<button type="submit" class="btn btn-success">Save</button></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\parent_confirm_delete.html
<<code:
{% extends 'base.html' %}

{% block title %}Delete Parent - EduTrack{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
            </div>
            <div class="card-body">
                <p class="lead">Are you sure you want to delete parent <strong>{{ object.user.get_full_name }}</strong>?</p>
                
                {% if object.user.children.exists %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Warning:</strong> This parent has {{ object.user.children.count }} linked student(s). 
                        They will no longer have a parent assigned.
                    </div>
                {% endif %}
                
                <p class="text-muted">This action cannot be undone.</p>
                
                <form method="post" class="mt-4">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="bi bi-trash"></i> Yes, Delete Parent
                    </button>
                    <a href="{% url 'parent_list' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\parent_form.html
<<code:
{% extends 'base.html' %}

{% block title %}Add Parent - EduTrack{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-person-plus"></i> Add New Parent</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-person-hearts"></i> Parent Information</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_first_name" class="form-label">
                                <i class="bi bi-person"></i> First Name *
                            </label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger">{{ form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_last_name" class="form-label">
                                <i class="bi bi-person"></i> Last Name *
                            </label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger">{{ form.last_name.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_email" class="form-label">
                            <i class="bi bi-envelope"></i> Email Address *
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_phone" class="form-label">
                            <i class="bi bi-telephone"></i> Phone Number
                        </label>
                        {{ form.phone }}
                        <small class="text-muted d-block mt-1">Optional - e.g., +1234567890</small>
                        {% if form.phone.errors %}
                            <div class="text-danger">{{ form.phone.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3"><i class="bi bi-key"></i> Login Credentials</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_username" class="form-label">
                                <i class="bi bi-person-circle"></i> Username *
                            </label>
                            {{ form.username }}
                            <small class="text-muted d-block mt-1">Parent will use this to login</small>
                            {% if form.username.errors %}
                                <div class="text-danger">{{ form.username.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_password" class="form-label">
                                <i class="bi bi-lock"></i> Password *
                            </label>
                            {{ form.password }}
                            <small class="text-muted d-block mt-1">Minimum 8 characters</small>
                            {% if form.password.errors %}
                                <div class="text-danger">{{ form.password.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Add Parent
                        </button>
                        <a href="{% url 'parent_list' %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-info-circle"></i> Instructions</h6>
                <ul class="small">
                    <li>Fill in parent's personal information</li>
                    <li>Create login credentials for the parent</li>
                    <li>After creating, you can link students to this parent</li>
                    <li>Parents can view their child's progress and grades</li>
                </ul>
                
                <hr>
                
                <h6 class="card-title"><i class="bi bi-lightbulb"></i> Next Steps</h6>
                <p class="small mb-0">
                    After creating a parent, go to <strong>Students</strong> → <strong>Edit</strong> a student → Select this parent from the dropdown.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\parent_list.html
<<code:
{% extends 'base.html' %}

{% block title %}Parents - EduTrack{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-hearts"></i> Parent Management</h2>
    <a href="{% url 'parent_add' %}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Add Parent
    </a>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><i class="bi bi-person"></i> Name</th>
                        <th><i class="bi bi-envelope"></i> Email</th>
                        <th><i class="bi bi-telephone"></i> Phone</th>
                        <th><i class="bi bi-people"></i> Children</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for parent in parents %}
                        <tr>
                            <td><strong>{{ parent.user.get_full_name }}</strong></td>
                            <td>{{ parent.user.email }}</td>
                            <td>{{ parent.phone|default:"N/A" }}</td>
                            <td>
                                <span class="badge bg-info">{{ parent.user.children.count }}</span>
                            </td>
                            <td>
                                <a href="{% url 'parent_delete' parent.pk %}" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="bi bi-inbox"></i> No parents found. 
                                <a href="{% url 'parent_add' %}">Add your first parent</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle"></i> 
    <strong>Note:</strong> Parents can be linked to students when adding or editing students.
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\roadmap_csv_upload.html
<<code:
{% extends 'teacher/base_teacher.html' %}

{% block teacher_content %}
<div class="container">
    <h2>Upload Roadmap CSV</h2>
    
    <div class="alert alert-info">
        <h4>CSV Format Instructions</h4>
        <p>Your CSV should have the following columns:</p>
        <ul>
            <li>topic_name (required)</li>
            <li>parent_topic (optional, leave blank for root topics)</li>
            <li>description (optional)</li>
            <li>estimated_hours (optional)</li>
        </ul>
        <a href="{% url 'download_csv_template' %}" class="btn btn-sm btn-info">Download Template</a>
    </div>
    
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Upload CSV</button>
        <a href="{% url 'teacher_roadmap' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\roadmap_form.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Add Topic</h2>
<form method="post">{% csrf_token %}{{ form.as_p }}<button type="submit" class="btn btn-primary">Add</button></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\roadmap_list.html
<<code:
{% extends 'base.html' %}
{% block title %}Roadmap Topics - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-map"></i> Curriculum Roadmap</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'roadmap_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Topic</a>
      <a href="{% url 'roadmap_upload' %}" class="btn btn-outline-secondary"><i class="bi bi-upload"></i> Upload CSV</a>
      <a href="{% url 'download_roadmap_template' %}" class="btn btn-outline-info"><i class="bi bi-download"></i> CSV Template</a>
      <a href="{% url 'roadmap_tree' %}" class="btn btn-outline-success"><i class="bi bi-diagram-3"></i> Tree View</a>
    </div>
  </div>

  <!-- Summary -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="h4 fw-bold text-primary">{{ total }}</div>
        <div class="text-muted small">Total Topics</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="h4 fw-bold text-success">{{ completed }}</div>
        <div class="text-muted small">Completed</div>
      </div>
    </div>
  </div>

  <!-- Hierarchy Tree with Badges -->
  <div class="card">
    <div class="card-header"><strong>Topics (Hierarchy View)</strong></div>
    <div class="card-body">
      {% if root_topics %}
        {% for topic in root_topics %}
          <div class="mb-3">
            {% include 'teacher/_topic_node.html' with topic=topic level=0 %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-map fs-1"></i>
          <p class="mt-2">No topics yet. <a href="{% url 'roadmap_create' %}">Add your first topic</a> or <a href="{% url 'roadmap_upload' %}">upload via CSV</a>.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\roadmap_tree.html
<<code:
{% extends 'teacher/base_teacher.html' %}

{% block teacher_content %}
<div class="container">
    <h2>Roadmap Tree View</h2>
    
    <div class="tree-view">
        {% for roadmap in roadmaps %}
        <div class="roadmap-section">
            <h3>{{ roadmap.teacher.user.get_full_name }}'s Roadmap</h3>
            <ul class="tree">
                {% for topic in roadmap.topics %}
                <li>
                    {{ topic.name }}
                    {% if topic.children.exists %}
                    <ul>
                        {% for child in topic.children.all %}
                        <li>{{ child.name }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% empty %}
        <p>No roadmaps found</p>
        {% endfor %}
    </div>
</div>

<style>
.tree, .tree ul {
    list-style: none;
    margin: 0;
    padding: 0;
}
.tree ul {
    margin-left: 20px;
}
.tree li {
    margin: 5px 0;
    padding: 5px;
    border-left: 1px solid #ddd;
}
</style>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\student_confirm_delete.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Delete Student</h2>
<p>Delete {{ object.user.get_full_name }}?</p>
<form method="post">{% csrf_token %}<button type="submit" class="btn btn-danger">Yes, Delete</button> <a href="{% url 'student_list' %}" class="btn btn-secondary">Cancel</a></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\student_edit.html
<<code:
{% extends 'base.html' %}

{% block title %}Edit Student - EduTrack{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-pencil-square"></i> Edit Student</h2>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Student Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ object.user.get_full_name }}</p>
                <p><strong>Username:</strong> {{ object.user.username }}</p>
                <p><strong>Email:</strong> {{ object.user.email }}</p>
                <p><strong>Enrolled:</strong> {{ object.enrollment_date|date:"M d, Y" }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Edit Details</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.grade.id_for_label }}" class="form-label">
                            <i class="bi bi-bookmark"></i> Grade
                        </label>
                        {{ form.grade }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.section.id_for_label }}" class="form-label">
                            <i class="bi bi-grid"></i> Section
                        </label>
                        {{ form.section }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.parent.id_for_label }}" class="form-label">
                            <i class="bi bi-person-hearts"></i> Parent
                        </label>
                        {{ form.parent }}
                        <small class="text-muted d-block mt-1">
                            Select a parent to link to this student. 
                            <a href="{% url 'parent_add' %}" target="_blank">Create new parent</a>
                        </small>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Student
                        </button>
                        <a href="{% url 'student_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\student_form.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Add Student</h2>
<form method="post">{% csrf_token %}{{ form.as_p }}<button type="submit" class="btn btn-primary">Save</button></form>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\student_list.html
<<code:
{% extends 'base.html' %}

{% block title %}Students - EduTrack{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people"></i> Student Management</h2>
    <div>
        <a href="{% url 'parent_list' %}" class="btn btn-info me-2">
            <i class="bi bi-person-hearts"></i> Manage Parents
        </a>
        <a href="{% url 'student_add' %}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Add Student
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><i class="bi bi-person"></i> Name</th>
                        <th><i class="bi bi-envelope"></i> Email</th>
                        <th><i class="bi bi-bookmark"></i> Grade</th>
                        <th><i class="bi bi-person-hearts"></i> Parent</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                        <tr>
                            <td><strong>{{ student.user.get_full_name }}</strong></td>
                            <td>{{ student.user.email }}</td>
                            <td>
                                <span class="badge bg-info">{{ student.grade }} {{ student.section }}</span>
                            </td>
                            <td>
                                {% if student.parent %}
                                    <i class="bi bi-check-circle text-success"></i> {{ student.parent.get_full_name }}
                                {% else %}
                                    <span class="badge bg-warning">No Parent</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'student_edit' student.pk %}" class="btn btn-sm btn-primary me-1" title="Edit">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <a href="{% url 'student_delete' student.pk %}" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="bi bi-inbox"></i> No students found. 
                                <a href="{% url 'student_add' %}">Add your first student</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle"></i> 
    <strong>Tip:</strong> Click <strong>"Edit"</strong> to link a student to a parent. 
    Make sure to <a href="{% url 'parent_list' %}">create parents</a> first if needed.
</div>
{% endblock %}
>>

--------------------------------------------------------
C:\Users\User\Documents\edutrack_project\templates\teacher\submission_list.html
<<code:
{% extends 'base.html' %}
{% block content %}
<h2>Submissions for: {{ assignment.title }}</h2>
{% for sub in submissions %}
<div class="card mb-2">
    <div class="card-body">
        <strong>{{ sub.student.user.get_full_name }}</strong> - {{ sub.submitted_at|date:"M d, Y" }}
        <a href="{% url 'grade_submission' sub.pk %}" class="btn btn-sm btn-primary float-end">Grade</a>
    </div>
</div>
{% endfor %}
{% endblock %}
>>

