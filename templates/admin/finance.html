{% extends 'base.html' %}
{% block title %}Finance Overview - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .finance-card { border-radius: 12px; }
  .income-card  { border-left: 5px solid #48bb78; }
  .expense-card { border-left: 5px solid #f56565; }
  .net-card     { border-left: 5px solid #667eea; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-cash-stack"></i> EduTrack Finance Overview</h2>
      <p class="text-muted mb-0">Fee income vs salary & petty expenses</p>
    </div>
    <div class="d-flex gap-2">
      <!-- Month filter -->
      <form method="get" class="d-flex gap-2 align-items-center">
        <label class="fw-semibold small mb-0">Month:</label>
        <input type="month" name="month" class="form-control form-control-sm" value="{{ selected_month }}">
        <button type="submit" class="btn btn-sm btn-primary">Go</button>
      </form>
      <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card finance-card income-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total Fee Income</div>
          <div class="fs-3 fw-bold text-success">₹{{ total_income|floatformat:2 }}</div>
          <small class="text-muted">{{ paid_fees_count }} payments received</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card expense-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total Expenses</div>
          <div class="fs-3 fw-bold text-danger">₹{{ total_expenses|floatformat:2 }}</div>
          <small class="text-muted">Salary + Petty Expenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card net-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Net Balance</div>
          <div class="fs-3 fw-bold {% if net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
            ₹{{ net_balance|floatformat:2 }}
          </div>
          <small class="text-muted">Income − Expenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card finance-card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Pending Fees</div>
          <div class="fs-3 fw-bold text-warning">₹{{ total_pending|floatformat:2 }}</div>
          <small class="text-muted">{{ pending_fees_count }} unpaid / overdue</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- Fee Income Breakdown -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-arrow-down-circle text-success"></i> Fee Income — {{ selected_month }}</strong>
          <span class="badge bg-success">₹{{ total_income|floatformat:0 }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:300px;overflow-y:auto;">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Student</th><th>Roll</th><th>Month</th><th>Amount</th><th>Status</th></tr>
              </thead>
              <tbody>
                {% for fee in fee_records %}
                <tr>
                  <td class="fw-semibold small">{{ fee.student.user.get_full_name }}</td>
                  <td><small class="text-muted">{{ fee.student.roll_number }}</small></td>
                  <td><small>{{ fee.month }}</small></td>
                  <td class="fw-semibold">₹{{ fee.fees }}</td>
                  <td>
                    {% if fee.status == 'paid' %}<span class="badge bg-success">Paid</span>
                    {% elif fee.status == 'overdue' %}<span class="badge bg-danger">Overdue</span>
                    {% elif fee.status == 'waived' %}<span class="badge bg-secondary">Waived</span>
                    {% else %}<span class="badge bg-warning text-dark">Unpaid</span>{% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-3">No fee records for this month.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Salary Expenses -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-arrow-up-circle text-danger"></i> Salary Expenses</strong>
          <span class="badge bg-danger">₹{{ total_salary|floatformat:0 }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:200px;overflow-y:auto;">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Name</th><th>Role</th><th>Salary / Month</th></tr>
              </thead>
              <tbody>
                {% for s in salary_records %}
                <tr>
                  <td class="fw-semibold small">{{ s.name }}</td>
                  <td><span class="badge bg-info text-dark small">{{ s.role }}</span></td>
                  <td class="fw-semibold">₹{{ s.salary|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted py-3">No salary records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Petty Expenses -->
        <div class="card-header border-top d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-receipt text-warning"></i> Petty Expenses</strong>
          <span class="badge bg-warning text-dark">₹{{ total_petty|floatformat:0 }}</span>
        </div>
        <div class="card-body">
          <!-- Add petty expense -->
          <form method="post" action="{% url 'admin_finance' %}" class="row g-2 mb-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_expense">
            <div class="col-md-5">
              <input type="text" name="description" class="form-control form-control-sm"
                     placeholder="Description (e.g. Rent)" required>
            </div>
            <div class="col-md-3">
              <input type="number" name="amount" class="form-control form-control-sm"
                     placeholder="Amount ₹" step="0.01" min="0" required>
            </div>
            <div class="col-md-2">
              <input type="date" name="expense_date" class="form-control form-control-sm" value="{{ today }}">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-sm btn-warning w-100">
                <i class="bi bi-plus"></i> Add
              </button>
            </div>
          </form>

          <div class="table-responsive" style="max-height:180px;overflow-y:auto;">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr><th>Date</th><th>Description</th><th>Amount</th><th></th></tr>
              </thead>
              <tbody>
                {% for exp in petty_expenses %}
                <tr>
                  <td><small>{{ exp.date|date:"d M Y" }}</small></td>
                  <td><small>{{ exp.description }}</small></td>
                  <td class="fw-semibold">₹{{ exp.amount }}</td>
                  <td>
                    <form method="post" action="{% url 'admin_finance' %}"
                          onsubmit="return confirm('Delete this expense?')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_expense">
                      <input type="hidden" name="expense_id" value="{{ exp.pk }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted">No petty expenses recorded.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(a => bootstrap.Alert.getOrCreateInstance(a).close());
  }, 8000);
</script>
{% endblock %}
