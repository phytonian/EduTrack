{% extends 'base.html' %}
{% block title %}Analytics - EduTrack Admin{% endblock %}

{% block extra_css %}
<style>
  .analytics-card { border-radius: 12px; }
  .teacher-card { border-left: 4px solid #667eea; }
  .student-row:hover { background: #f8f9fa; cursor: pointer; }
  .progress { border-radius: 10px; }
  .chart-container { position: relative; height: 300px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-bar-chart-line"></i> Analytics</h2>
      <p class="text-muted mb-0">Student progress & teacher performance overview</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Dashboard
    </a>
  </div>

  <!-- Top Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card text-center analytics-card border-primary">
        <div class="card-body py-3">
          <div class="fs-2 fw-bold text-primary">{{ total_students }}</div>
          <div class="text-muted small">Total Students</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center analytics-card border-success">
        <div class="card-body py-3">
          <div class="fs-2 fw-bold text-success">{{ average_score }}%</div>
          <div class="text-muted small">Overall Avg Score</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <a href="{% url 'admin_tickets' %}" class="text-decoration-none">
        <div class="card text-center analytics-card border-warning h-100">
          <div class="card-body py-3">
            <div class="fs-2 fw-bold text-warning">{{ open_tickets }}</div>
            <div class="text-muted small">Open Tickets</div>
            <small class="text-warning"><i class="bi bi-arrow-right-circle"></i> View All</small>
          </div>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a href="{% url 'admin_brushups' %}" class="text-decoration-none">
        <div class="card text-center analytics-card border-info h-100">
          <div class="card-body py-3">
            <div class="fs-2 fw-bold text-info">{{ pending_brushup }}</div>
            <div class="text-muted small">Pending Brush-ups</div>
            <small class="text-info"><i class="bi bi-arrow-right-circle"></i> View All</small>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- View Toggle -->
  <ul class="nav nav-tabs mb-4" id="analyticsTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#students-tab" data-bs-toggle="tab">
        <i class="bi bi-people"></i> Student Performance
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#teachers-tab" data-bs-toggle="tab">
        <i class="bi bi-mortarboard"></i> Teacher Performance
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#trends-tab" data-bs-toggle="tab">
        <i class="bi bi-graph-up"></i> Monthly Trends
      </a>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ── STUDENT PERFORMANCE TAB ─────────────────────────────────────── -->
    <div class="tab-pane fade show active" id="students-tab">

      <!-- Grade-wise chart -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-bar-chart"></i> Average Score by Grade</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="gradeScoreChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-people"></i> Students per Grade</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="gradeCountChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Student list with progress bars -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-list-ol"></i> Individual Student Performance</strong>
          <span class="badge bg-secondary">{{ student_stats|length }} students</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Student</th>
                  <th>Grade</th>
                  <th>Avg Score</th>
                  <th>Attendance</th>
                  <th>Assignments</th>
                  <th>Fees</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for s in student_stats %}
                <tr class="student-row" onclick="window.location='{% url 'student_detail' s.student.pk %}'">
                  <td class="text-muted small">{{ forloop.counter }}</td>
                  <td>
                    <div class="fw-semibold">{{ s.student.user.get_full_name }}</div>
                    <small class="text-muted">{{ s.student.roll_number }}</small>
                  </td>
                  <td><span class="badge bg-primary">{{ s.student.grade }}{{ s.student.section }}</span></td>
                  <td style="min-width:120px;">
                    <div class="d-flex align-items-center gap-2">
                      <div class="progress flex-grow-1" style="height:8px;">
                        <div class="progress-bar {% if s.avg_score >= 75 %}bg-success{% elif s.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             style="width:{{ s.avg_score }}%"></div>
                      </div>
                      <small class="fw-semibold">{{ s.avg_score }}%</small>
                    </div>
                  </td>
                  <td style="min-width:120px;">
                    <div class="d-flex align-items-center gap-2">
                      <div class="progress flex-grow-1" style="height:8px;">
                        <div class="progress-bar {% if s.attendance_rate >= 75 %}bg-success{% elif s.attendance_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             style="width:{{ s.attendance_rate }}%"></div>
                      </div>
                      <small class="fw-semibold">{{ s.attendance_rate }}%</small>
                    </div>
                  </td>
                  <td>
                    <small>{{ s.graded }}/{{ s.total }} done</small>
                  </td>
                  <td>
                    {% if s.pending_fees > 0 %}
                      <span class="badge bg-danger">₹{{ s.pending_fees }}</span>
                    {% else %}
                      <span class="badge bg-success">Clear</span>
                    {% endif %}
                  </td>
                  <td>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center text-muted py-3">No student data yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ── TEACHER PERFORMANCE TAB ─────────────────────────────────────── -->
    <div class="tab-pane fade" id="teachers-tab">

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-bar-chart"></i> Avg Student Score per Teacher</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="teacherScoreChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="bi bi-journal-check"></i> Assignments Graded per Teacher</strong></div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="teacherGradedChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Teacher cards -->
      <div class="row g-3">
        {% for t in teacher_stats %}
        <div class="col-md-6">
          <div class="card shadow-sm teacher-card">
            <div class="card-body">
              <div class="d-flex align-items-center gap-3 mb-3">
                {% if t.teacher.profile.profile_photo %}
                  <img src="{{ t.teacher.profile.profile_photo.url }}" class="rounded-circle" width="50" height="50" style="object-fit:cover;">
                {% else %}
                  <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white fw-bold" style="width:50px;height:50px;">
                    {{ t.teacher.first_name|first }}{{ t.teacher.last_name|first }}
                  </div>
                {% endif %}
                <div>
                  <h6 class="mb-0 fw-semibold">{{ t.teacher.get_full_name }}</h6>
                  <small class="text-muted">
                    {% for subj in t.teacher.profile.subjects.all %}
                      <span class="badge bg-info text-dark me-1">{{ subj.name }}</span>
                    {% endfor %}
                  </small>
                </div>
                <div class="ms-auto text-end">
                  <div class="fs-4 fw-bold text-primary">{{ t.avg_student_score }}%</div>
                  <small class="text-muted">avg score</small>
                </div>
              </div>

              <div class="row text-center g-2 mb-3">
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-primary">{{ t.total_assignments }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Assignments</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-success">{{ t.graded_submissions }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Graded</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-warning">{{ t.pending_submissions }}</div>
                    <small class="text-muted" style="font-size:0.7rem;">Pending</small>
                  </div>
                </div>
                <div class="col-3">
                  <div class="border rounded p-2">
                    <div class="fw-bold text-info">{{ t.roadmap_progress }}%</div>
                    <small class="text-muted" style="font-size:0.7rem;">Roadmap</small>
                  </div>
                </div>
              </div>

              <!-- Student scores under this teacher -->
              {% if t.student_scores %}
              <div class="border-top pt-2">
                <small class="text-muted fw-semibold d-block mb-2">Students' Progress</small>
                {% for ss in t.student_scores %}
                <div class="mb-1">
                  <div class="d-flex justify-content-between">
                    <small>{{ ss.name }}</small>
                    <small class="fw-semibold">{{ ss.score }}%</small>
                  </div>
                  <div class="progress" style="height:5px;">
                    <div class="progress-bar {% if ss.score >= 75 %}bg-success{% elif ss.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                         style="width:{{ ss.score }}%"></div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12 text-center text-muted py-4">No teacher data available.</div>
        {% endfor %}
      </div>
    </div>

    <!-- ── MONTHLY TRENDS TAB ──────────────────────────────────────────── -->
    <div class="tab-pane fade" id="trends-tab">
      <div class="card shadow-sm">
        <div class="card-header"><strong><i class="bi bi-graph-up"></i> Monthly Submission Trend</strong></div>
        <div class="card-body">
          <div style="height:350px;">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end tab-content -->
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ── Data from Django ─────────────────────────────────────────────────────
  const gradeStats   = {{ grade_stats_json|safe }};
  const monthlyData  = {{ monthly_data|safe }};
  const teacherStats = {{ teacher_stats_json|safe }};

  const COLORS = ['#667eea','#48bb78','#ed8936','#4299e1','#9f7aea','#f56565','#38b2ac','#ecc94b'];

  // ── Grade Score Chart ─────────────────────────────────────────────────
  new Chart(document.getElementById('gradeScoreChart'), {
    type: 'bar',
    data: {
      labels: gradeStats.map(g => 'Grade ' + g.grade),
      datasets: [{
        label: 'Avg Score (%)',
        data: gradeStats.map(g => g.avg_score),
        backgroundColor: COLORS,
        borderRadius: 6,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, max: 100 } },
      plugins: { legend: { display: false } }
    }
  });

  // ── Grade Count Chart ─────────────────────────────────────────────────
  new Chart(document.getElementById('gradeCountChart'), {
    type: 'doughnut',
    data: {
      labels: gradeStats.map(g => 'Grade ' + g.grade),
      datasets: [{
        data: gradeStats.map(g => g.student_count),
        backgroundColor: COLORS,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right' } }
    }
  });

  // ── Teacher Score Chart ───────────────────────────────────────────────
  new Chart(document.getElementById('teacherScoreChart'), {
    type: 'bar',
    data: {
      labels: teacherStats.map(t => t.name),
      datasets: [{
        label: 'Avg Student Score (%)',
        data: teacherStats.map(t => t.avg_student_score),
        backgroundColor: COLORS,
        borderRadius: 6,
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, max: 100 } },
      plugins: { legend: { display: false } }
    }
  });

  // ── Teacher Graded Chart ──────────────────────────────────────────────
  new Chart(document.getElementById('teacherGradedChart'), {
    type: 'bar',
    data: {
      labels: teacherStats.map(t => t.name),
      datasets: [
        { label: 'Graded', data: teacherStats.map(t => t.graded), backgroundColor: '#48bb78', borderRadius: 4 },
        { label: 'Pending', data: teacherStats.map(t => t.pending), backgroundColor: '#ed8936', borderRadius: 4 },
      ]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
    }
  });

  // ── Monthly Trend Chart ───────────────────────────────────────────────
  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: monthlyData.map(m => m.month ? m.month.slice(0,7) : ''),
      datasets: [{
        label: 'Avg Score (%)',
        data: monthlyData.map(m => m.avg ? parseFloat(m.avg).toFixed(1) : 0),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102,126,234,0.1)',
        tension: 0.4,
        fill: true,
      },{
        label: 'Submissions Count',
        data: monthlyData.map(m => m.count || 0),
        borderColor: '#48bb78',
        backgroundColor: 'rgba(72,187,120,0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y1',
      }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      scales: {
        y:  { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } },
        y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' }, grid: { drawOnChartArea: false } },
      }
    }
  });
</script>
{% endblock %}
