{% extends 'base.html' %}
{% load dict_extras %}
{% block title %}Mark Attendance - EduTrack{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="bi bi-calendar-check"></i> Mark Attendance</h2>
      <p class="text-muted mb-0">Select a date and mark each student's attendance.</p>
    </div>
    <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Date Selector Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="dateInput" class="form-label fw-semibold">
            <i class="bi bi-calendar3"></i> Select Date
          </label>
          <input type="date" class="form-control form-control-lg" id="dateInput" name="date"
                 value="{{ att_date|date:'Y-m-d' }}" max="{{ att_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-search"></i> Load Students
          </button>
        </div>
        <div class="col-md-5 text-end">
          <span class="text-muted">
            <i class="bi bi-calendar-event"></i>
            Showing attendance for: <strong class="text-primary">{{ att_date|date:"l, d F Y" }}</strong>
          </span>
        </div>
      </form>
    </div>
  </div>

  <!-- Attendance Form -->
  <form method="post" id="attendanceForm">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ att_date|date:'Y-m-d' }}">

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white py-3">
        <div>
          <h5 class="mb-0"><i class="bi bi-people"></i> Student Attendance ‚Äî {{ att_date|date:"d M Y" }}</h5>
          <small>{{ students|length }} student(s) listed</small>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light btn-sm" onclick="markAllPresent()">
            <i class="bi bi-check-all"></i> Mark All Present
          </button>
          <button type="button" class="btn btn-light btn-sm" onclick="markAllAbsent()">
            <i class="bi bi-x-circle"></i> Mark All Absent
          </button>
          <button type="submit" class="btn btn-success btn-sm fw-bold px-4" id="saveBtn">
            <i class="bi bi-save"></i> Save Attendance
          </button>
        </div>
      </div>

      <div class="card-body p-0">
        {% if students %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="attendanceTable">
            <thead class="table-light sticky-top">
              <tr>
                <th style="width:40px;">#</th>
                <th><i class="bi bi-person"></i> Student Name</th>
                <th><i class="bi bi-bookmark"></i> Class</th>
                <th><i class="bi bi-book"></i> Subjects</th>
                <th style="min-width:160px;"><i class="bi bi-check-circle"></i> Status</th>
                <th style="min-width:80px;" class="text-center">Present</th>
                <th style="min-width:120px;">Notes</th>
                <th style="min-width:80px;" class="text-center">Edit</th>
              </tr>
            </thead>
            <tbody>
              {% for student in students %}
                {% with rec=existing|get_item:student.id %}
                <tr id="row-{{ student.id }}" class="{% if rec %}{% if rec.status == 'present' %}table-success{% elif rec.status == 'absent' %}table-danger{% elif rec.status == 'late' %}table-warning{% elif rec.status == 'excused' %}table-info{% endif %}{% endif %}">

                  <!-- Row number -->
                  <td class="text-muted small">{{ forloop.counter }}</td>

                  <!-- Student Name + Roll -->
                  <td>
                    <div class="fw-semibold">{{ student.user.get_full_name }}</div>
                    <small class="text-muted">Roll: {{ student.roll_number }}</small>
                  </td>

                  <!-- Class / Section -->
                  <td>
                    <span class="badge bg-info text-dark">
                      Grade {{ student.grade }}{{ student.section }}
                    </span>
                  </td>

                  <!-- Subjects (from assignments for this grade) -->
                  <td>
                    <div class="subjects-cell" data-grade="{{ student.grade }}">
                      {% for sub in student.grade_subjects %}
                        <span class="badge bg-secondary me-1">{{ sub }}</span>
                      {% empty %}
                        <span class="text-muted small">‚Äî</span>
                      {% endfor %}
                    </div>
                  </td>

                  <!-- Status Select -->
                  <td>
                    <select name="status_{{ student.id }}"
                            class="form-select form-select-sm status-select {% if not rec %}disabled-look{% endif %}"
                            id="status-{{ student.id }}"
                            {% if rec %}data-original="{{ rec.status }}"{% endif %}
                            onchange="updateRowColor({{ student.id }}, this.value)"
                            {% if not rec %}disabled{% endif %}>
                      <option value="" {% if not rec %}selected{% endif %}>‚Äî Not Marked ‚Äî</option>
                      <option value="present"  {% if rec.status == 'present'  %}selected{% endif %}>‚úÖ Present</option>
                      <option value="absent"   {% if rec.status == 'absent'   %}selected{% endif %}>‚ùå Absent</option>
                      <option value="late"     {% if rec.status == 'late'     %}selected{% endif %}>‚è∞ Late</option>
                      <option value="excused"  {% if rec.status == 'excused'  %}selected{% endif %}>üîµ Excused</option>
                      <option value="half_day" {% if rec.status == 'half_day' %}selected{% endif %}>üåì Half Day</option>
                    </select>
                  </td>

                  <!-- Present Checkbox (quick mark) -->
                  <td class="text-center">
                    <div class="form-check d-flex justify-content-center">
                      <input class="form-check-input present-checkbox"
                             type="checkbox"
                             id="present-{{ student.id }}"
                             data-student-id="{{ student.id }}"
                             {% if rec.status == 'present' %}checked{% endif %}
                             onchange="handleCheckboxChange({{ student.id }}, this.checked)"
                             style="width:1.3em; height:1.3em; cursor:pointer;">
                    </div>
                  </td>

                  <!-- Notes -->
                  <td>
                    <input type="text"
                           name="notes_{{ student.id }}"
                           class="form-control form-control-sm notes-input"
                           placeholder="Optional note"
                           value="{% if rec %}{{ rec.notes }}{% endif %}"
                           {% if rec %}data-original="{{ rec.notes }}"{% endif %}
                           {% if not rec %}disabled{% endif %}>
                  </td>

                  <!-- Edit Button -->
                  <td class="text-center">
                    {% if rec %}
                      <button type="button" class="btn btn-sm btn-outline-warning edit-btn"
                              onclick="enableEdit({{ student.id }})"
                              id="edit-btn-{{ student.id }}"
                              title="Edit attendance for this student">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary cancel-btn d-none"
                              onclick="cancelEdit({{ student.id }})"
                              id="cancel-btn-{{ student.id }}"
                              title="Cancel edit">
                        <i class="bi bi-x"></i>
                      </button>
                    {% else %}
                      <span class="badge bg-light text-muted">New</span>
                    {% endif %}
                  </td>

                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Bottom Save Button -->
        <div class="p-3 border-top bg-light d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="bi bi-info-circle"></i>
            Check the "Present" checkbox for quick marking, or use the dropdown for detailed status.
            Click <strong>Edit</strong> to modify an already-saved record.
          </small>
          <button type="submit" class="btn btn-success fw-bold px-5" id="saveBtn2">
            <i class="bi bi-save"></i> Save Attendance
          </button>
        </div>

        {% else %}
          <div class="text-center py-5 text-muted">
            <i class="bi bi-people" style="font-size:3rem;"></i>
            <p class="mt-3">No students found. <a href="{% url 'student_add' %}">Add students</a> first.</p>
          </div>
        {% endif %}

      </div>
    </div>
  </form>

</div>

<style>
  .status-select {
    min-width: 140px;
  }
  .disabled-look {
    background-color: #f8f9fa;
    color: #999;
  }
  .sticky-top {
    top: 0;
    z-index: 10;
  }
  .table-success td, .table-danger td,
  .table-warning td, .table-info td {
    transition: background-color 0.3s ease;
  }
</style>

<script>
  // Enable editing of an already-saved attendance record
  function enableEdit(studentId) {
    const select = document.getElementById('status-' + studentId);
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    const editBtn = document.getElementById('edit-btn-' + studentId);
    const cancelBtn = document.getElementById('cancel-btn-' + studentId);

    select.disabled = false;
    select.classList.remove('disabled-look');
    notes.disabled = false;
    editBtn.classList.add('d-none');
    cancelBtn.classList.remove('d-none');

    // Highlight row for editing
    const row = document.getElementById('row-' + studentId);
    row.style.outline = '2px solid #f6ad55';
  }

  // Cancel editing, revert to original values
  function cancelEdit(studentId) {
    const select = document.getElementById('status-' + studentId);
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    const editBtn = document.getElementById('edit-btn-' + studentId);
    const cancelBtn = document.getElementById('cancel-btn-' + studentId);
    const row = document.getElementById('row-' + studentId);

    // Revert to saved values
    if (select.dataset.original) select.value = select.dataset.original;
    if (notes.dataset.original !== undefined) notes.value = notes.dataset.original;

    select.disabled = true;
    select.classList.add('disabled-look');
    notes.disabled = true;
    editBtn.classList.remove('d-none');
    cancelBtn.classList.add('d-none');
    row.style.outline = '';

    // Update row color to match original
    updateRowColor(studentId, select.value);
  }

  // Handle present checkbox: sets status to present/absent
  function handleCheckboxChange(studentId, isChecked) {
    const select = document.getElementById('status-' + studentId);
    const row = document.getElementById('row-' + studentId);

    // Enable the select if it's disabled (new record)
    select.disabled = false;
    select.classList.remove('disabled-look');

    // Enable notes too
    const notes = document.querySelector(`input[name="notes_${studentId}"]`);
    if (notes) notes.disabled = false;

    if (isChecked) {
      select.value = 'present';
    } else {
      // If unchecking, set to absent only if was present, else keep current
      if (select.value === 'present' || select.value === '') {
        select.value = 'absent';
      }
    }
    updateRowColor(studentId, select.value);
  }

  // Sync checkbox with select dropdown
  document.querySelectorAll('.status-select').forEach(function(sel) {
    sel.addEventListener('change', function() {
      const id = this.id.replace('status-', '');
      const checkbox = document.getElementById('present-' + id);
      if (checkbox) checkbox.checked = (this.value === 'present');
    });
  });

  // Update row background color based on status
  function updateRowColor(studentId, status) {
    const row = document.getElementById('row-' + studentId);
    row.classList.remove('table-success', 'table-danger', 'table-warning', 'table-info', 'table-secondary');
    const colorMap = {
      'present':  'table-success',
      'absent':   'table-danger',
      'late':     'table-warning',
      'excused':  'table-info',
      'half_day': 'table-secondary',
    };
    if (colorMap[status]) row.classList.add(colorMap[status]);
  }

  // Mark all students as present
  function markAllPresent() {
    document.querySelectorAll('.status-select').forEach(function(sel) {
      const id = sel.id.replace('status-', '');
      sel.disabled = false;
      sel.classList.remove('disabled-look');
      sel.value = 'present';
      const notes = document.querySelector(`input[name="notes_${id}"]`);
      if (notes) notes.disabled = false;
      updateRowColor(id, 'present');
      const cb = document.getElementById('present-' + id);
      if (cb) cb.checked = true;
    });
  }

  // Mark all students as absent
  function markAllAbsent() {
    document.querySelectorAll('.status-select').forEach(function(sel) {
      const id = sel.id.replace('status-', '');
      sel.disabled = false;
      sel.classList.remove('disabled-look');
      sel.value = 'absent';
      const notes = document.querySelector(`input[name="notes_${id}"]`);
      if (notes) notes.disabled = false;
      updateRowColor(id, 'absent');
      const cb = document.getElementById('present-' + id);
      if (cb) cb.checked = false;
    });
  }

  // Before form submit ‚Äî enable all selects/inputs so values are submitted
  document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    document.querySelectorAll('.status-select, .notes-input').forEach(function(el) {
      el.disabled = false;
    });

    // Remove "not marked" entries ‚Äî empty status
    document.querySelectorAll('.status-select').forEach(function(sel) {
      if (!sel.value) sel.name = ''; // remove from POST if not marked
    });

    // Loading state
    document.getElementById('saveBtn').innerHTML =
      '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    document.getElementById('saveBtn').disabled = true;
    if (document.getElementById('saveBtn2')) {
      document.getElementById('saveBtn2').innerHTML =
        '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
      document.getElementById('saveBtn2').disabled = true;
    }
  });
</script>
{% endblock %}
